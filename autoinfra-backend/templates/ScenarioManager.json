{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.24.24.22086",
      "templateHash": "13168396069489112304"
    }
  },
  "parameters": {
    "location": {
      "type": "string"
    },
    "DC01ImageReferenceID": {
      "type": "string",
      "defaultValue": ""
    },
    "DC02ImageReferenceID": {
      "type": "string",
      "defaultValue": ""
    },
    "rootDCName": {
      "type": "string",
      "defaultValue": ""
    },
    "CA01ImageReferenceID": {
      "type": "string",
      "defaultValue": ""
    },
    "SRV01ImageReferenceID": {
      "type": "string",
      "defaultValue": ""
    },
    "SRV02ImageReferenceID": {
      "type": "string",
      "defaultValue": ""
    },
    "JUMPBOXImageReferenceID": {
      "type": "string",
      "defaultValue": ""
    },
    "enterpriseAdminUsername": {
      "type": "string"
    },
    "enterpriseAdminPassword": {
      "type": "securestring"
    },
    "caAdminUsername": {
      "type": "string",
      "defaultValue": ""
    },
    "caName": {
      "type": "string",
      "defaultValue": ""
    },
    "rootStandaloneServerName": {
      "type": "string",
      "defaultValue": ""
    },
    "caAdminPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "standaloneAdminUsername": {
      "type": "string",
      "defaultValue": ""
    },
    "standaloneAdminPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "subscriptionID": {
      "type": "string",
      "defaultValue": ""
    },
    "deployResourceGroupName": {
      "type": "string",
      "defaultValue": ""
    },
    "scenarioTagValue": {
      "type": "string",
      "defaultValue": ""
    },
    "expiryTimestamp": {
      "type": "string",
      "defaultValue": ""
    },
    "randomPort": {
      "type": "string",
      "defaultValue": ""
    },
    "rootOrSub": {
      "type": "string",
      "defaultValue": ""
    },
    "rootDomainFqdn": {
      "type": "string",
      "defaultValue": ""
    },
    "rootDomainName": {
      "type": "string",
      "defaultValue": ""
    },
    "subDCName": {
      "type": "string",
      "defaultValue": ""
    },
    "subStandaloneServerName": {
      "type": "string",
      "defaultValue": ""
    },
    "subDomainName": {
      "type": "string",
      "defaultValue": ""
    },
    "rootDomainNetBIOSName": {
      "type": "string",
      "defaultValue": ""
    },
    "rootDomainControllers": {
      "type": "array",
      "defaultValue": []
    },
    "subDomainControllers": {
      "type": "array",
      "defaultValue": []
    },
    "standaloneServers": {
      "type": "array",
      "defaultValue": []
    },
    "certificateAuthorities": {
      "type": "array",
      "defaultValue": []
    },
    "jumpboxConfig": {
      "type": "array",
      "defaultValue": []
    },
    "callerIPAddress": {
      "type": "string",
      "defaultValue": ""
    },
    "kaliSku": {
      "type": "string",
      "defaultValue": "kali-2025-2"
    },
    "scenarioSelection": {
      "type": "string",
      "metadata": {
        "description": "Scenario name for metadata and logging - not used in deployment logic"
      }
    }
  },
  "variables": {
    "connectedPrivateIPAddress": "[if(greater(length(parameters('jumpboxConfig')), 0), parameters('jumpboxConfig')[0].connectedPrivateIPAddress, '')]",
    "jumpboxPrivateIPAddress": "[if(greater(length(parameters('jumpboxConfig')), 0), parameters('jumpboxConfig')[0].jumpboxPrivateIPAddress, '')]",
    "firstRootDC": "[if(greater(length(parameters('rootDomainControllers')), 0), parameters('rootDomainControllers')[0], createObject())]",
    "rootDomainNameVar": "[if(contains(variables('firstRootDC'), 'domainName'), variables('firstRootDC').domainName, '')]",
    "rootDomainControllerFQDN": "[if(and(contains(variables('firstRootDC'), 'name'), not(equals(variables('rootDomainNameVar'), ''))), format('{0}.{1}', variables('firstRootDC').name, variables('rootDomainNameVar')), '')]",
    "rootDomainNetBIOSNameVar": "[if(contains(variables('firstRootDC'), 'netbios'), variables('firstRootDC').netbios, '')]",
    "vnetName": "lab-network",
    "vnetAddressPrefix": "10.10.0.0/16",
    "rootSubnetAddressPrefix": "10.10.0.0/24",
    "rootDCIP": "10.10.0.10",
    "subDCIP": "10.10.0.20",
    "caIP": "10.10.0.15",
    "windowsVmSize": "Standard_B1ms",
    "jumpboxVmSize": "Standard_B2s",
    "standaloneVmSize": "Standard_B2s",
    "vmDiskType": "Standard_LRS",
    "jumpboxName": "JUMPBOX",
    "vmGalleryName": "TestBuilds",
    "vmGalleryResourceGroup": "TestBuilds",
    "buildResourceGroupName": "build"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('BuildLab-{0}', uniqueString(parameters('deployResourceGroupName')))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[variables('vnetAddressPrefix')]"
          },
          "rootSubnetAddressPrefix": {
            "value": "[variables('rootSubnetAddressPrefix')]"
          },
          "windowsVmSize": {
            "value": "[variables('windowsVmSize')]"
          },
          "vmDiskType": {
            "value": "[variables('vmDiskType')]"
          },
          "rootDomainControllers": {
            "value": "[parameters('rootDomainControllers')]"
          },
          "subDomainControllers": {
            "value": "[parameters('subDomainControllers')]"
          },
          "standaloneServers": {
            "value": "[parameters('standaloneServers')]"
          },
          "certificateAuthorities": {
            "value": "[parameters('certificateAuthorities')]"
          },
          "jumpBoxName": {
            "value": "[variables('jumpboxName')]"
          },
          "rootDomainControllerPrivateIp": {
            "value": "[parameters('rootDomainControllers')[0].privateIPAddress]"
          },
          "rootDCName": {
            "value": "[variables('firstRootDC').name]"
          },
          "domainName": {
            "value": "[variables('rootDomainNameVar')]"
          },
          "rootDomainControllerFQDN": {
            "value": "[variables('rootDomainControllerFQDN')]"
          },
          "enterpriseAdminUsername": {
            "value": "[parameters('enterpriseAdminUsername')]"
          },
          "enterpriseAdminPassword": {
            "value": "[parameters('enterpriseAdminPassword')]"
          },
          "jumpboxImageReference": {
            "value": "[parameters('JUMPBOXImageReferenceID')]"
          },
          "jumpboxVmSize": {
            "value": "[variables('jumpboxVmSize')]"
          },
          "resourceGroupName": {
            "value": "[parameters('deployResourceGroupName')]"
          },
          "vmGalleryName": {
            "value": "[variables('vmGalleryName')]"
          },
          "vmGalleryResourceGroup": {
            "value": "[variables('vmGalleryResourceGroup')]"
          },
          "subscriptionID": {
            "value": "[parameters('subscriptionID')]"
          },
          "scenarioTagValue": {
            "value": "[parameters('scenarioTagValue')]"
          },
          "expiryTimeout": {
            "value": "[parameters('expiryTimestamp')]"
          },
          "rootDomainNetBIOSName": {
            "value": "[variables('rootDomainNetBIOSNameVar')]"
          },
          "connectedPrivateIPAddress": {
            "value": "[variables('connectedPrivateIPAddress')]"
          },
          "jumpboxPrivateIPAddress": {
            "value": "[variables('jumpboxPrivateIPAddress')]"
          },
          "jumpboxConfig": {
            "value": "[parameters('jumpboxConfig')]"
          },
          "callerIPAddress": {
            "value": "[parameters('callerIPAddress')]"
          },
          "kaliSku": {
            "value": "[parameters('kaliSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "8520233710570964373"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string"
            },
            "vnetAddressPrefix": {
              "type": "string"
            },
            "rootSubnetAddressPrefix": {
              "type": "string"
            },
            "expiryTimeout": {
              "type": "string"
            },
            "rootDomainControllerPrivateIp": {
              "type": "string"
            },
            "certificateAuthorityPrivateIp": {
              "type": "string",
              "nullable": true
            },
            "standaloneServerPrivateIp": {
              "type": "string",
              "nullable": true
            },
            "windowsVmSize": {
              "type": "string"
            },
            "jumpboxVmSize": {
              "type": "string"
            },
            "vmDiskType": {
              "type": "string"
            },
            "rootDCName": {
              "type": "string"
            },
            "caName": {
              "type": "string",
              "defaultValue": ""
            },
            "rootStandaloneServerName": {
              "type": "string",
              "nullable": true
            },
            "jumpBoxName": {
              "type": "string"
            },
            "rootDomainNetBIOSName": {
              "type": "string"
            },
            "rootDomainControllerFQDN": {
              "type": "string"
            },
            "enterpriseAdminUsername": {
              "type": "string"
            },
            "enterpriseAdminPassword": {
              "type": "securestring"
            },
            "caAdminUsername": {
              "type": "string",
              "nullable": true
            },
            "caAdminPassword": {
              "type": "securestring",
              "nullable": true
            },
            "standaloneServerUsername": {
              "type": "string",
              "nullable": true
            },
            "standaloneServerPassword": {
              "type": "securestring",
              "nullable": true
            },
            "resourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "domainName": {
              "type": "string"
            },
            "scenarioTagValue": {
              "type": "string"
            },
            "deployOrBuild": {
              "type": "string",
              "defaultValue": "build"
            },
            "subscriptionID": {
              "type": "string"
            },
            "vmGalleryName": {
              "type": "string"
            },
            "vmGalleryResourceGroup": {
              "type": "string"
            },
            "jumpboxImageReference": {
              "type": "string"
            },
            "rootOrSub": {
              "type": "string",
              "defaultValue": ""
            },
            "rootDomainFqdn": {
              "type": "string",
              "defaultValue": ""
            },
            "standaloneServers": {
              "type": "array",
              "defaultValue": []
            },
            "rootDomainControllers": {
              "type": "array",
              "defaultValue": []
            },
            "subDomainControllers": {
              "type": "array",
              "defaultValue": []
            },
            "certificateAuthorities": {
              "type": "array",
              "defaultValue": []
            },
            "jumpboxConfig": {
              "type": "array",
              "defaultValue": []
            },
            "connectedPrivateIPAddress": {
              "type": "string",
              "defaultValue": ""
            },
            "jumpboxPrivateIPAddress": {
              "type": "string",
              "defaultValue": ""
            },
            "callerIPAddress": {
              "type": "string",
              "defaultValue": ""
            },
            "kaliSku": {
              "type": "string",
              "defaultValue": "kali-2025-2"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "rootDomainControllerIPs",
                "count": "[length(parameters('rootDomainControllers'))]",
                "input": "[parameters('rootDomainControllers')[copyIndex('rootDomainControllerIPs')].privateIPAddress]"
              },
              {
                "name": "subDomainControllerIPs",
                "count": "[length(parameters('subDomainControllers'))]",
                "input": "[parameters('subDomainControllers')[copyIndex('subDomainControllerIPs')].privateIPAddress]"
              },
              {
                "name": "jumpboxIPs",
                "count": "[length(parameters('jumpboxConfig'))]",
                "input": "[parameters('jumpboxConfig')[copyIndex('jumpboxIPs')].jumpboxPrivateIPAddress]"
              },
              {
                "name": "allStandaloneServersIPs",
                "count": "[length(parameters('standaloneServers'))]",
                "input": "[parameters('standaloneServers')[copyIndex('allStandaloneServersIPs')].privateIPAddress]"
              },
              {
                "name": "allCAIPs",
                "count": "[length(parameters('certificateAuthorities'))]",
                "input": "[parameters('certificateAuthorities')[copyIndex('allCAIPs')].privateIPAddress]"
              },
              {
                "name": "all10IPs",
                "count": "[length(variables('allIPs'))]",
                "input": "[if(contains(string(variables('allIPs')[copyIndex('all10IPs')]), '10.10.'), variables('allIPs')[copyIndex('all10IPs')], null())]"
              },
              {
                "name": "all192IPs",
                "count": "[length(variables('allIPs'))]",
                "input": "[if(contains(string(variables('allIPs')[copyIndex('all192IPs')]), '192.168.'), variables('allIPs')[copyIndex('all192IPs')], null())]"
              },
              {
                "name": "all172IPs",
                "count": "[length(variables('allIPs'))]",
                "input": "[if(contains(string(variables('allIPs')[copyIndex('all172IPs')]), '172.16.'), variables('allIPs')[copyIndex('all172IPs')], null())]"
              },
              {
                "name": "rootDCObjects",
                "count": "[length(parameters('rootDomainControllers'))]",
                "input": {
                  "name": "[parameters('rootDomainControllers')[copyIndex('rootDCObjects')].name]",
                  "serverType": "RootDC"
                }
              },
              {
                "name": "subDCObjects",
                "count": "[length(parameters('subDomainControllers'))]",
                "input": {
                  "name": "[parameters('subDomainControllers')[copyIndex('subDCObjects')].name]",
                  "serverType": "SubDC"
                }
              },
              {
                "name": "standaloneServerObjects",
                "count": "[length(parameters('standaloneServers'))]",
                "input": {
                  "name": "[parameters('standaloneServers')[copyIndex('standaloneServerObjects')].name]",
                  "serverType": "Standalone"
                }
              }
            ],
            "domainAndEnterpriseAdminUsername": "[format('{0}@{1}', parameters('enterpriseAdminUsername'), parameters('rootDomainControllers')[0].domainName)]",
            "allDomainControllers": "[concat(parameters('rootDomainControllers'), parameters('subDomainControllers'))]",
            "allDomainControllerIPs": "[concat(variables('rootDomainControllerIPs'), variables('subDomainControllerIPs'))]",
            "allIP": "[concat(variables('allDomainControllerIPs'), variables('allStandaloneServersIPs'), variables('allCAIPs'))]",
            "allIPs": "[concat(variables('allIP'), variables('jumpboxIPs'))]",
            "all10IPsFiltered": "[filter(variables('all10IPs'), lambda('ip', not(equals(lambdaVariables('ip'), null()))))]",
            "isVNet10Required": "[greater(length(variables('all10IPsFiltered')), 0)]",
            "all192IPsFiltered": "[filter(variables('all192IPs'), lambda('ip', not(equals(lambdaVariables('ip'), null()))))]",
            "isVNet192Required": "[greater(length(variables('all192IPsFiltered')), 0)]",
            "all172IPsFiltered": "[filter(variables('all172IPs'), lambda('ip', not(equals(lambdaVariables('ip'), null()))))]",
            "isVNet172Required": "[greater(length(variables('all172IPsFiltered')), 0)]",
            "subDCCount": "[length(parameters('subDomainControllers'))]",
            "caObject": "[if(and(not(empty(parameters('caName'))), not(equals(parameters('caName'), ''))), createArray(createObject('name', parameters('caName'), 'serverType', 'CA')), createArray())]",
            "serverObjects": "[concat(variables('rootDCObjects'), variables('subDCObjects'), variables('standaloneServerObjects'), variables('caObject'))]"
          },
          "resources": {
            "createResourceGroup": {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2023-07-01",
              "name": "[parameters('resourceGroupName')]",
              "location": "[parameters('location')]",
              "tags": {
                "Scenario": "[parameters('scenarioTagValue')]",
                "expiryTimeout": "[parameters('expiryTimeout')]"
              }
            },
            "vnet10": {
              "condition": "[variables('isVNet10Required')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "vnet-10",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetName": {
                    "value": "vnet-10"
                  },
                  "virtualNetworkAddressPrefix": {
                    "value": "10.10.0.0/16"
                  },
                  "rootSubnetAddressPrefix": {
                    "value": "10.10.0.0/24"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "136376656318129269"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Region to deploy vnet."
                      }
                    },
                    "virtualNetworkAddressPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootSubnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vnetName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Virtual Network name."
                      }
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "variables": {
                    "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(equals(parameters('vnetName'), 'vnet-10'), 'subnet-10', if(equals(parameters('vnetName'), 'vnet-172'), 'subnet-172', if(equals(parameters('vnetName'), 'vnet-192'), 'subnet-192', ''))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('vnetName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('virtualNetworkAddressPrefix')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "[variables('subnetName')]",
                            "properties": {
                              "addressPrefix": "[parameters('rootSubnetAddressPrefix')]"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "createResourceGroup"
              ]
            },
            "vnet192": {
              "condition": "[variables('isVNet192Required')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "vnet-192",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetName": {
                    "value": "vnet-192"
                  },
                  "virtualNetworkAddressPrefix": {
                    "value": "192.168.0.0/16"
                  },
                  "rootSubnetAddressPrefix": {
                    "value": "192.168.0.0/24"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "136376656318129269"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Region to deploy vnet."
                      }
                    },
                    "virtualNetworkAddressPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootSubnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vnetName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Virtual Network name."
                      }
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "variables": {
                    "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(equals(parameters('vnetName'), 'vnet-10'), 'subnet-10', if(equals(parameters('vnetName'), 'vnet-172'), 'subnet-172', if(equals(parameters('vnetName'), 'vnet-192'), 'subnet-192', ''))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('vnetName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('virtualNetworkAddressPrefix')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "[variables('subnetName')]",
                            "properties": {
                              "addressPrefix": "[parameters('rootSubnetAddressPrefix')]"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "createResourceGroup"
              ]
            },
            "vnet172": {
              "condition": "[variables('isVNet172Required')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "vnet-172",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetName": {
                    "value": "vnet-172"
                  },
                  "virtualNetworkAddressPrefix": {
                    "value": "172.16.0.0/16"
                  },
                  "rootSubnetAddressPrefix": {
                    "value": "172.16.0.0/24"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "136376656318129269"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Region to deploy vnet."
                      }
                    },
                    "virtualNetworkAddressPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootSubnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vnetName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Virtual Network name."
                      }
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "variables": {
                    "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(equals(parameters('vnetName'), 'vnet-10'), 'subnet-10', if(equals(parameters('vnetName'), 'vnet-172'), 'subnet-172', if(equals(parameters('vnetName'), 'vnet-192'), 'subnet-192', ''))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('vnetName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('virtualNetworkAddressPrefix')]"
                          ]
                        },
                        "subnets": [
                          {
                            "name": "[variables('subnetName')]",
                            "properties": {
                              "addressPrefix": "[parameters('rootSubnetAddressPrefix')]"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "createResourceGroup"
              ]
            },
            "generatedRootDCModules": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "GeneratedRootDCModules",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "windowsVmSize": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "vmDiskType": {
                    "value": "[parameters('vmDiskType')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "domainAndEnterpriseAdminUsername": {
                    "value": "[variables('domainAndEnterpriseAdminUsername')]"
                  },
                  "enterpriseAdminUsername": {
                    "value": "[parameters('enterpriseAdminUsername')]"
                  },
                  "enterpriseAdminPassword": {
                    "value": "[parameters('enterpriseAdminPassword')]"
                  },
                  "deployOrBuild": {
                    "value": "[parameters('deployOrBuild')]"
                  },
                  "jumpboxPrivateIPAddress": {
                    "value": "[parameters('jumpboxPrivateIPAddress')]"
                  },
                  "connectedPrivateIPAddress": {
                    "value": "[parameters('connectedPrivateIPAddress')]"
                  },
                  "isVNet10Required": {
                    "value": "[variables('isVNet10Required')]"
                  },
                  "isVNet172Required": {
                    "value": "[variables('isVNet172Required')]"
                  },
                  "isVNet192Required": {
                    "value": "[variables('isVNet192Required')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "8493492555552256601"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "windowsVmSize": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vmDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainAndEnterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "deployOrBuild": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainNetBIOSName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllerFQDN": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "subDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "callerIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainControllerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "jumpboxPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "connectedPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "isVNet10Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet192Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet172Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "kaliSku": {
                      "type": "string",
                      "defaultValue": "kali-2025-2"
                    },
                    "hasPublicIP": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "RootDC_0",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "privateIPAddress": {
                            "value": "10.10.0.9"
                          },
                          "virtualMachineSize": {
                            "value": "[parameters('windowsVmSize')]"
                          },
                          "virtualMachineHostname": {
                            "value": "DC01"
                          },
                          "resourceGroupName": {
                            "value": "[parameters('resourceGroupName')]"
                          },
                          "osDiskType": {
                            "value": "[parameters('vmDiskType')]"
                          },
                          "domainName": {
                            "value": "build.lab"
                          },
                          "domainAndEnterpriseAdminUsername": {
                            "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                          },
                          "rootDomainNetBIOSName": {
                            "value": "build"
                          },
                          "enterpriseAdminUsername": {
                            "value": "[parameters('enterpriseAdminUsername')]"
                          },
                          "enterpriseAdminPassword": {
                            "value": "[parameters('enterpriseAdminPassword')]"
                          },
                          "deployOrBuild": {
                            "value": "[parameters('deployOrBuild')]"
                          },
                          "isRoot": {
                            "value": true
                          },
                          "parentDomainControllerPrivateIp": {
                            "value": ""
                          },
                          "oldScenarios": {
                            "value": "[parameters('oldScenarios')]"
                          },
                          "jumpboxPrivateIPAddress": {
                            "value": "[parameters('jumpboxPrivateIPAddress')]"
                          },
                          "connectedPrivateIPAddress": {
                            "value": "[parameters('connectedPrivateIPAddress')]"
                          },
                          "isVNet10Required": {
                            "value": "[parameters('isVNet10Required')]"
                          },
                          "isVNet192Required": {
                            "value": "[parameters('isVNet192Required')]"
                          },
                          "isVNet172Required": {
                            "value": "[parameters('isVNet172Required')]"
                          },
                          "hasPublicIP": {
                            "value": false
                          },
                          "callerIPAddress": {
                            "value": "[parameters('callerIPAddress')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.24.24.22086",
                              "templateHash": "14471965902952370307"
                            }
                          },
                          "parameters": {
                            "virtualMachineSize": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "deployOrBuild": {
                              "type": "string"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "privateIPAddress": {
                              "type": "string"
                            },
                            "virtualMachineHostname": {
                              "type": "string"
                            },
                            "parentDomainControllerPrivateIp": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "imageReference": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "osDiskType": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "domainName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "rootDomainNetBIOSName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "enterpriseAdminUsername": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "enterpriseAdminPassword": {
                              "type": "securestring",
                              "defaultValue": ""
                            },
                            "isRoot": {
                              "type": "bool",
                              "defaultValue": true
                            },
                            "domainAndEnterpriseAdminUsername": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "rootDomainControllerFQDN": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "jumpboxPrivateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "connectedPrivateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "isVNet10Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "isVNet172Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "isVNet192Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "hasPublicIP": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "callerIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "oldScenarios": {
                              "type": "bool",
                              "defaultValue": false
                            }
                          },
                          "variables": {
                            "$fxv#0": "param(\n    [string]$domainName,\n    [string]$enterpriseAdminUsername,\n    [string]$enterpriseAdminPassword\n)\n\n$securePassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n$credential = New-Object System.Management.Automation.PSCredential ($enterpriseAdminUsername, $securePassword)\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n\ntry {\n    Write-Host \"Installing Active Directory Domain Services...\"\n    Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools\n\n    Write-Host \"Configuring Root Domain Controller for $domainName...\"\n    Install-ADDSForest -DomainName $domainName -SafeModeAdministratorPassword $securePassword -Force\n    # Wait for services to init\n    #Start-Sleep -Seconds 60\n    Restart-Service NetLogon -EA 0\n    Add-Content -Path $logFilePath -Value \"Successfully Installed ADDS.\"\n    # Note: UPN for enterprise admin is set via separate PostDCSetup run-command\n} catch {\n    Write-Host \"Failed to configure Root Domain Controller: $_\"\n    Add-Content -Path $logFilePath -Value \"Failed Installing ADDS. $_\"\n}\n\n",
                            "$fxv#1": "param(\n    [string]$domainName,\n    [string]$parentDomainName,\n    [string]$enterpriseAdminUsername,\n    [string]$enterpriseAdminPassword,\n    [string]$rootDomainControllerFQDN\n)\n\n[securestring]$secureAdminPassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n\n# Use the root domain credential as passed (UPN format: buildadmin@build.lab)\n# This works once trust relationship is established between parent and root\n[pscredential]$enterpriseAdminCreds = New-Object System.Management.Automation.PSCredential ($enterpriseAdminUsername, $secureAdminPassword)\n[pscredential]$enterpriseAdminCredsWithDomain = New-Object System.Management.Automation.PSCredential ($enterpriseAdminUsername, $secureAdminPassword)\n\nWrite-Host \"Using credential: $enterpriseAdminUsername\"\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\nStart-Transcript -Path $logFilePath -Append\n\ntry {\n    Write-Host \"Installing Active Directory Domain Services...\"\n    Install-WindowsFeature AD-Domain-Services, rsat-adds -IncludeAllSubFeature\n\n    # DNS resolution retry logic - up to 60 minutes (120 * 30 seconds)\n    $maxAttempts = 120\n    $attempt = 0\n    $dnsResolved = $false\n\n    while ($attempt -lt $maxAttempts -and -not $dnsResolved) {\n        try {\n            Write-Host \"Attempt $($attempt + 1): Resolving $parentDomainName...\"\n            Resolve-DnsName -Name $parentDomainName -ErrorAction Stop | Out-Null\n            $dnsResolved = $true\n            Write-Host \"Successfully resolved $parentDomainName\"\n        } catch {\n            Write-Host \"Could not resolve $parentDomainName. Retrying in 30 seconds...\"\n            Start-Sleep -Seconds 30\n            $attempt++\n        }\n    }\n\n    if (-not $dnsResolved) {\n        throw \"DNS resolution for $parentDomainName failed after $maxAttempts attempts.\"\n    }\n\n    # Wait for parent domain controller to be ready (ping + LDAP bind)\n    $maxWaitSeconds = 3600\n    $interval = 30\n    $elapsed = 0\n    $parentDomainReady = $false\n\n    while ($elapsed -lt $maxWaitSeconds -and -not $parentDomainReady) {\n        try {\n            Write-Host \"Checking if parent domain controller ($rootDomainControllerFQDN) is reachable...\"\n\n            if (Test-Connection -ComputerName $rootDomainControllerFQDN -Count 1 -Quiet) {\n                Write-Host \"Ping successful. Attempting LDAP bind to $parentDomainName...\"\n                $ds = [System.DirectoryServices.ActiveDirectory.Domain]::GetDomain(\n                    (New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext('Domain', $parentDomainName))\n                )\n                Write-Host \"LDAP bind succeeded. Parent domain controller is ready.\"\n                $parentDomainReady = $true\n            } else {\n                Write-Host \"$rootDomainControllerFQDN is not reachable. Retrying...\"\n            }\n        } catch {\n            Write-Host \"Parent domain controller not ready yet: $_\"\n        }\n\n        if (-not $parentDomainReady) {\n            Start-Sleep -Seconds $interval\n            $elapsed += $interval\n        }\n    }\n\n    if (-not $parentDomainReady) {\n        throw \"Timed out waiting for parent domain controller to be ready.\"\n    }\n\n    # Poll until credential can authenticate THROUGH the parent domain controller\n    # This ensures the parent DC's trust relationship and replication are complete\n    # We authenticate against the parent DC using root domain credentials\n    $maxCredAttempts = 120  # Up to 60 minutes (120 * 30 seconds)\n    $credAttempt = 0\n    $credentialReady = $false\n    \n    Write-Host \"Waiting for parent DC to be able to validate root domain credentials...\"\n    Write-Host \"Testing: Can $rootDomainControllerFQDN authenticate $enterpriseAdminUsername?\"\n    \n    while ($credAttempt -lt $maxCredAttempts -and -not $credentialReady) {\n        try {\n            Write-Host \"Attempt $($credAttempt + 1): Testing credential authentication through parent DC...\"\n            \n            # Connect to the PARENT domain controller and authenticate with root domain creds\n            # This proves the parent DC can forward authentication to the root domain (trust is working)\n            $ldapPath = \"LDAP://$rootDomainControllerFQDN\"\n            $directoryEntry = New-Object System.DirectoryServices.DirectoryEntry(\n                $ldapPath,\n                $enterpriseAdminUsername,\n                $enterpriseAdminPassword\n            )\n            \n            # Force authentication by accessing a property\n            $null = $directoryEntry.distinguishedName\n            \n            if ($directoryEntry.distinguishedName) {\n                Write-Host \"Credential validation succeeded! Parent DC can authenticate root domain credentials.\"\n                Write-Host \"Trust relationship between parent and root domain is ready.\"\n                $credentialReady = $true\n                $directoryEntry.Close()\n            } else {\n                throw \"DirectoryEntry returned but no distinguishedName\"\n            }\n        } catch {\n            Write-Host \"Parent DC cannot yet validate root credentials: $_\"\n            Write-Host \"Retrying in 30 seconds...\"\n            Start-Sleep -Seconds 30\n            $credAttempt++\n        }\n    }\n    \n    if (-not $credentialReady) {\n        throw \"Timed out waiting for parent DC to validate credentials. Trust relationship may not be established.\"\n    }\n    \n    # Extract the root domain from the enterprise admin username (e.g., buildadmin@build.lab -> build.lab)\n    $rootDomainFromUsername = $enterpriseAdminUsername.Split('@')[1]\n    $usernameOnly = $enterpriseAdminUsername.Split('@')[0]\n    \n    # CRITICAL: Ensure DNS is pointing ONLY to the parent DC\n    # Azure NIC DNS settings may not be applied yet - force it\n    # Do NOT include 8.8.8.8 as it can cause SRV lookups to fail\n    Write-Host \"Ensuring DNS client is configured to use parent DC ONLY...\"\n    Write-Host \"Resolving parent DC IP from: $rootDomainControllerFQDN\"\n    \n    try {\n        $parentDcIp = (Resolve-DnsName -Name $rootDomainControllerFQDN -Type A -ErrorAction Stop | \n                       Where-Object { $_.Type -eq 'A' } | \n                       Select-Object -First 1).IPAddress\n        Write-Host \"Parent DC IP resolved: $parentDcIp\"\n        \n        # Get the active network adapter and set DNS to ONLY the parent DC\n        $activeAdapter = Get-NetAdapter | Where-Object { $_.Status -eq 'Up' } | Select-Object -First 1\n        if ($activeAdapter) {\n            Write-Host \"Setting DNS server on adapter '$($activeAdapter.InterfaceAlias)' to $parentDcIp ONLY\"\n            Set-DnsClientServerAddress -InterfaceAlias $activeAdapter.InterfaceAlias -ServerAddresses @($parentDcIp)\n            \n            # Flush DNS cache to ensure fresh lookups\n            Write-Host \"Flushing DNS cache...\"\n            ipconfig /flushdns | Out-Null\n            \n            # Verify the change\n            $currentDns = (Get-DnsClientServerAddress -InterfaceAlias $activeAdapter.InterfaceAlias -AddressFamily IPv4).ServerAddresses\n            Write-Host \"DNS servers now set to: $($currentDns -join ', ')\"\n        }\n    } catch {\n        Write-Host \"Warning: Could not set DNS server dynamically: $_\"\n        Write-Host \"Continuing with existing DNS settings...\"\n    }\n    \n    # Check required SRV records that DCPromo needs\n    # Include both parent domain AND forest root records for deep hierarchies\n    Write-Host \"Checking required SRV records...\"\n    \n    # Parent domain SRV records\n    $requiredSrvRecords = @(\n        \"_ldap._tcp.dc._msdcs.$parentDomainName\",\n        \"_kerberos._tcp.$parentDomainName\",\n        \"_ldap._tcp.$parentDomainName\"\n    )\n    \n    # Add forest root records if parent domain != root domain (deep hierarchy)\n    if ($parentDomainName -ne $rootDomainFromUsername) {\n        Write-Host \"Deep hierarchy detected: parent=$parentDomainName, root=$rootDomainFromUsername\"\n        Write-Host \"Adding forest root SRV record checks...\"\n        $requiredSrvRecords += @(\n            \"_ldap._tcp.dc._msdcs.$rootDomainFromUsername\",\n            \"_kerberos._tcp.$rootDomainFromUsername\",\n            \"_gc._tcp.$rootDomainFromUsername\"\n        )\n    }\n    \n    $maxSrvAttempts = 120  # Up to 60 minutes (120 * 30 seconds)\n    $srvAttempt = 0\n    $srvReady = $false\n    \n    while ($srvAttempt -lt $maxSrvAttempts -and -not $srvReady) {\n        $allSrvResolved = $true\n        \n        Write-Host \"Attempt $($srvAttempt + 1): Checking SRV records...\"\n        \n        foreach ($srvRecord in $requiredSrvRecords) {\n            try {\n                $result = Resolve-DnsName -Name $srvRecord -Type SRV -ErrorAction Stop\n                $target = ($result | Select-Object -First 1).NameTarget\n                Write-Host \"  OK: $srvRecord -> $target\"\n            } catch {\n                Write-Host \"  MISSING: $srvRecord - $_\"\n                $allSrvResolved = $false\n            }\n        }\n        \n        if ($allSrvResolved) {\n            Write-Host \"All required SRV records are resolvable!\"\n            $srvReady = $true\n        } else {\n            Write-Host \"Some SRV records not ready. Retrying in 30 seconds...\"\n            Start-Sleep -Seconds 30\n            $srvAttempt++\n        }\n    }\n    \n    if (-not $srvReady) {\n        throw \"Timed out waiting for SRV records. Parent DC DNS may not be fully initialized.\"\n    }\n    \n    # Use nltest to verify DC locator works (this is what Windows uses internally)\n    Write-Host \"Verifying DC locator with nltest for parent domain...\"\n    $maxNltestAttempts = 120  # Up to 60 minutes (120 * 30 seconds)\n    $nltestAttempt = 0\n    $nltestSuccess = $false\n    \n    while ($nltestAttempt -lt $maxNltestAttempts -and -not $nltestSuccess) {\n        try {\n            Write-Host \"Attempt $($nltestAttempt + 1): Running nltest /dsgetdc:$parentDomainName...\"\n            $nltestResult = nltest /dsgetdc:$parentDomainName 2>&1\n            $nltestExitCode = $LASTEXITCODE\n            \n            if ($nltestExitCode -eq 0) {\n                Write-Host \"nltest for parent domain succeeded!\"\n                Write-Host $nltestResult\n                $nltestSuccess = $true\n            } else {\n                throw \"nltest failed with exit code $nltestExitCode : $nltestResult\"\n            }\n        } catch {\n            Write-Host \"nltest not ready yet: $_\"\n            Write-Host \"Retrying in 30 seconds...\"\n            Start-Sleep -Seconds 30\n            $nltestAttempt++\n        }\n    }\n    \n    if (-not $nltestSuccess) {\n        throw \"Timed out waiting for nltest /dsgetdc to succeed for parent domain.\"\n    }\n    \n    # CRITICAL for deep hierarchies: Also verify DC locator works for the FOREST ROOT domain\n    # Install-ADDSDomain uses the credential's domain (build.lab) to authenticate\n    if ($parentDomainName -ne $rootDomainFromUsername) {\n        Write-Host \"Deep hierarchy: Verifying DC locator for forest root domain...\"\n        $maxRootNltestAttempts = 120  # Up to 60 minutes (120 * 30 seconds)\n        $rootNltestAttempt = 0\n        $rootNltestSuccess = $false\n        \n        while ($rootNltestAttempt -lt $maxRootNltestAttempts -and -not $rootNltestSuccess) {\n            try {\n                Write-Host \"Attempt $($rootNltestAttempt + 1): Running nltest /dsgetdc:$rootDomainFromUsername...\"\n                $rootNltestResult = nltest /dsgetdc:$rootDomainFromUsername 2>&1\n                $rootNltestExitCode = $LASTEXITCODE\n                \n                if ($rootNltestExitCode -eq 0) {\n                    Write-Host \"nltest for forest root domain succeeded!\"\n                    Write-Host $rootNltestResult\n                    $rootNltestSuccess = $true\n                } else {\n                    throw \"nltest failed with exit code $rootNltestExitCode : $rootNltestResult\"\n                }\n            } catch {\n                Write-Host \"nltest for forest root not ready yet: $_\"\n                Write-Host \"Retrying in 30 seconds...\"\n                Start-Sleep -Seconds 30\n                $rootNltestAttempt++\n            }\n        }\n        \n        if (-not $rootNltestSuccess) {\n            throw \"Timed out waiting for nltest /dsgetdc:$rootDomainFromUsername. Forest root DC not reachable via DNS.\"\n        }\n    }\n    \n    # Check SYSVOL and NETLOGON shares are accessible (indicates DC is fully promoted)\n    # This is a best-effort check - don't fail if shares aren't accessible\n    # as the other checks (SRV, nltest, user lookup) should be sufficient\n    Write-Host \"Checking SYSVOL and NETLOGON shares on parent DC...\"\n    $maxShareAttempts = 10  # Reduced from 30 - don't wait too long\n    $shareAttempt = 0\n    $sharesReady = $false\n    \n    # Extract parent DC hostname from FQDN\n    $parentDcHostname = $rootDomainControllerFQDN.Split('.')[0]\n    \n    while ($shareAttempt -lt $maxShareAttempts -and -not $sharesReady) {\n        try {\n            Write-Host \"Attempt $($shareAttempt + 1): Checking shares...\"\n            \n            $sysvolPath = \"\\\\$rootDomainControllerFQDN\\SYSVOL\"\n            $netlogonPath = \"\\\\$rootDomainControllerFQDN\\NETLOGON\"\n            \n            $sysvolExists = Test-Path $sysvolPath -ErrorAction Stop\n            $netlogonExists = Test-Path $netlogonPath -ErrorAction Stop\n            \n            if ($sysvolExists -and $netlogonExists) {\n                Write-Host \"  OK: SYSVOL share accessible at $sysvolPath\"\n                Write-Host \"  OK: NETLOGON share accessible at $netlogonPath\"\n                $sharesReady = $true\n            } else {\n                throw \"Shares not accessible: SYSVOL=$sysvolExists, NETLOGON=$netlogonExists\"\n            }\n        } catch {\n            Write-Host \"Shares not ready yet: $_\"\n            Write-Host \"Retrying in 30 seconds...\"\n            Start-Sleep -Seconds 30\n            $shareAttempt++\n        }\n    }\n    \n    if (-not $sharesReady) {\n        Write-Host \"WARNING: SYSVOL/NETLOGON shares not accessible after $maxShareAttempts attempts.\"\n        Write-Host \"This may indicate DFSR hasn't finished initializing, but other checks passed.\"\n        Write-Host \"Continuing with domain installation anyway...\"\n    }\n    \n    # Check time synchronization (Kerberos fails with >5 minute skew)\n    Write-Host \"Checking time synchronization with parent DC...\"\n    try {\n        $w32tmResult = w32tm /stripchart /computer:$rootDomainControllerFQDN /samples:1 /dataonly 2>&1\n        Write-Host \"Time sync check result:\"\n        Write-Host $w32tmResult\n        \n        # Parse the time offset - look for the offset value\n        $offsetMatch = $w32tmResult | Select-String -Pattern '([+-]?\\d+\\.?\\d*)s'\n        if ($offsetMatch) {\n            $offsetSeconds = [math]::Abs([double]$offsetMatch.Matches[0].Groups[1].Value)\n            Write-Host \"Time offset from parent DC: $offsetSeconds seconds\"\n            \n            if ($offsetSeconds -gt 300) {\n                Write-Host \"WARNING: Time skew is greater than 5 minutes! Attempting to sync...\"\n                w32tm /resync /force | Out-Null\n                Start-Sleep -Seconds 5\n            } else {\n                Write-Host \"Time synchronization is within acceptable limits.\"\n            }\n        }\n    } catch {\n        Write-Host \"Warning: Could not check time sync: $_\"\n        Write-Host \"Continuing anyway...\"\n    }\n    \n    # Check required ports are reachable\n    Write-Host \"Checking required AD ports are reachable on parent DC...\"\n    $requiredPorts = @(53, 88, 135, 389, 445, 464, 636, 3268)\n    $portCheckPassed = $true\n    \n    foreach ($port in $requiredPorts) {\n        try {\n            $tcpTest = Test-NetConnection -ComputerName $rootDomainControllerFQDN -Port $port -WarningAction SilentlyContinue -ErrorAction Stop\n            if ($tcpTest.TcpTestSucceeded) {\n                Write-Host \"  OK: Port $port is open\"\n            } else {\n                Write-Host \"  WARNING: Port $port is not accessible\"\n                # Don't fail on port check - some ports may not respond to TCP test\n            }\n        } catch {\n            Write-Host \"  WARNING: Could not test port $port - $_\"\n        }\n    }\n    \n    # Poll until the user account can be resolved via AD\n    # CRITICAL: For deep hierarchies, Install-ADDSDomain resolves the credential via DNS\n    # to the FOREST ROOT domain, not through the parent DC chain.\n    # We must verify the root domain is reachable via DNS from this machine.\n    $maxUserCheckAttempts = 120  # Up to 60 minutes (120 * 30 seconds)\n    $userCheckAttempt = 0\n    $userResolved = $false\n    \n    # Determine where to search - for deep hierarchies we need the FOREST ROOT DC\n    $searchTarget = $rootDomainControllerFQDN\n    $isDeepHierarchy = $parentDomainName -ne $rootDomainFromUsername\n    \n    if ($isDeepHierarchy) {\n        Write-Host \"Deep hierarchy detected - need to resolve user from forest root domain...\"\n        Write-Host \"Credential domain: $rootDomainFromUsername\"\n        Write-Host \"Parent domain: $parentDomainName\"\n        \n        # Find a DC in the forest root domain via DNS\n        try {\n            $rootDcSrv = Resolve-DnsName -Name \"_ldap._tcp.dc._msdcs.$rootDomainFromUsername\" -Type SRV -ErrorAction Stop\n            $rootDcFqdn = ($rootDcSrv | Select-Object -First 1).NameTarget\n            Write-Host \"Found forest root DC via SRV: $rootDcFqdn\"\n            $searchTarget = $rootDcFqdn\n        } catch {\n            Write-Host \"Warning: Could not find forest root DC via SRV, will try direct DNS...\"\n            # Try to resolve the root domain directly and use that\n            try {\n                $rootDomainIp = (Resolve-DnsName -Name $rootDomainFromUsername -Type A -ErrorAction Stop | \n                                 Where-Object { $_.Type -eq 'A' } | \n                                 Select-Object -First 1).IPAddress\n                Write-Host \"Resolved $rootDomainFromUsername to IP: $rootDomainIp\"\n                $searchTarget = $rootDomainFromUsername\n            } catch {\n                Write-Host \"Warning: Could not resolve forest root domain - falling back to parent DC\"\n            }\n        }\n    }\n    \n    Write-Host \"Verifying user account can be resolved in Active Directory...\"\n    Write-Host \"Looking for user '$usernameOnly' in domain '$rootDomainFromUsername' via $searchTarget...\"\n    \n    while ($userCheckAttempt -lt $maxUserCheckAttempts -and -not $userResolved) {\n        try {\n            Write-Host \"Attempt $($userCheckAttempt + 1): Resolving user account via AD...\"\n            \n            # First verify DNS resolution for the root domain\n            $dnsResult = Resolve-DnsName -Name $rootDomainFromUsername -ErrorAction Stop\n            Write-Host \"DNS resolution for $rootDomainFromUsername succeeded.\"\n            \n            # For deep hierarchies, search the FOREST ROOT domain directly\n            # This is what Install-ADDSDomain will do internally\n            $searchRoot = New-Object System.DirectoryServices.DirectoryEntry(\n                \"LDAP://$searchTarget\",\n                $enterpriseAdminUsername,\n                $enterpriseAdminPassword\n            )\n            \n            $searcher = New-Object System.DirectoryServices.DirectorySearcher($searchRoot)\n            $searcher.Filter = \"(sAMAccountName=$usernameOnly)\"\n            $searcher.SearchScope = \"Subtree\"\n            \n            $result = $searcher.FindOne()\n            \n            if ($result) {\n                $userDn = $result.Properties['distinguishedName'][0]\n                Write-Host \"User account '$usernameOnly' found in Active Directory!\"\n                Write-Host \"User DN: $userDn\"\n                \n                # Verify the user is in the correct domain (forest root)\n                if ($isDeepHierarchy -and $userDn -notlike \"*DC=$($rootDomainFromUsername.Split('.')[0]),*\") {\n                    Write-Host \"WARNING: User found but may not be in the forest root domain!\"\n                    Write-Host \"Expected domain: $rootDomainFromUsername\"\n                    Write-Host \"This could cause Install-ADDSDomain to fail.\"\n                }\n                \n                $userResolved = $true\n                $searcher.Dispose()\n                $searchRoot.Close()\n            } else {\n                throw \"User not found in directory search results\"\n            }\n        } catch {\n            Write-Host \"User resolution not ready yet: $_\"\n            Write-Host \"Retrying in 30 seconds...\"\n            Start-Sleep -Seconds 30\n            $userCheckAttempt++\n        }\n    }\n    \n    if (-not $userResolved) {\n        throw \"Timed out waiting for user account to be resolvable in AD. AD replication may not be complete.\"\n    }\n    \n    # Additional check for deep hierarchies: verify we can actually authenticate to the forest root\n    if ($isDeepHierarchy) {\n        Write-Host \"Verifying authentication to forest root domain...\"\n        $maxForestAuthAttempts = 120  # Up to 60 minutes (120 * 30 seconds)\n        $forestAuthAttempt = 0\n        $forestAuthReady = $false\n        \n        while ($forestAuthAttempt -lt $maxForestAuthAttempts -and -not $forestAuthReady) {\n            try {\n                Write-Host \"Attempt $($forestAuthAttempt + 1): Testing authentication to $rootDomainFromUsername...\"\n                \n                # Try to bind directly to the forest root domain via DNS name\n                $forestEntry = New-Object System.DirectoryServices.DirectoryEntry(\n                    \"LDAP://$rootDomainFromUsername\",\n                    $enterpriseAdminUsername,\n                    $enterpriseAdminPassword\n                )\n                \n                # Force authentication\n                $null = $forestEntry.distinguishedName\n                \n                if ($forestEntry.distinguishedName) {\n                    Write-Host \"Successfully authenticated to forest root domain!\"\n                    Write-Host \"Forest root DN: $($forestEntry.distinguishedName)\"\n                    $forestAuthReady = $true\n                    $forestEntry.Close()\n                } else {\n                    throw \"Could not get distinguishedName from forest root\"\n                }\n            } catch {\n                Write-Host \"Forest root authentication not ready yet: $_\"\n                Write-Host \"Retrying in 30 seconds...\"\n                Start-Sleep -Seconds 30\n                $forestAuthAttempt++\n            }\n        }\n        \n        if (-not $forestAuthReady) {\n            throw \"Timed out waiting for forest root authentication. DNS forwarding may not be working.\"\n        }\n    }\n    \n    Write-Host \"All prerequisites passed.\"\n    \n    # CRITICAL: Wait for AD replication/Kerberos/DNS to fully settle\n    # This was in the original working script and is apparently necessary. IDK why, but atm, simply waiting a while just cause is the only solution. I really wish to find the actul thing to probe to know for sure install-ad would work. \n    # even after all our checks pass - Install-ADDSDomain has internal timing requirements\n    # For deep hierarchies (DC03+), wait longer as there are more replication hops\n    if ($isDeepHierarchy) {\n        $stabilizationWait = 600  # 10 minutes for deep hierarchies\n        Write-Host \"Deep hierarchy detected - waiting 10 minutes for AD infrastructure to fully stabilize...\"\n    } else {\n        $stabilizationWait = 300  # 5 minutes for first-level child domains\n        Write-Host \"Waiting 5 minutes for AD infrastructure to fully stabilize...\"\n    }\n    Write-Host \"Start time: $(Get-Date)\"\n    Start-Sleep -Seconds $stabilizationWait\n    Write-Host \"Wait complete. Proceeding with domain installation...\"\n    Write-Host \"End time: $(Get-Date)\"\n\n    # Final pre-flight check: Run Test-ADDSDomainInstallation to verify everything is ready\n    # This is the same validation that Install-ADDSDomain runs internally\n    Write-Host \"Running Test-ADDSDomainInstallation to verify readiness...\"\n    $maxTestAttempts = 20\n    $testAttempt = 0\n    $testPassed = $false\n    \n    while ($testAttempt -lt $maxTestAttempts -and -not $testPassed) {\n        try {\n            Write-Host \"Test attempt $($testAttempt + 1) of $maxTestAttempts...\"\n            $testResult = Test-ADDSDomainInstallation `\n                -NewDomainName $domainName `\n                -ParentDomainName $parentDomainName `\n                -DomainType \"ChildDomain\" `\n                -InstallDNS `\n                -ReplicationSourceDC $rootDomainControllerFQDN `\n                -SafeModeAdministratorPassword $secureAdminPassword `\n                -Credential $enterpriseAdminCredsWithDomain\n            \n            if ($testResult.Status -eq \"Success\") {\n                Write-Host \"Test-ADDSDomainInstallation passed!\"\n                $testPassed = $true\n            } else {\n                Write-Host \"Test-ADDSDomainInstallation returned: $($testResult.Status)\"\n                Write-Host \"Message: $($testResult.Message)\"\n                $testAttempt++\n                if ($testAttempt -lt $maxTestAttempts) {\n                    Write-Host \"Retrying in 60 seconds...\"\n                    Start-Sleep -Seconds 60\n                }\n            }\n        } catch {\n            Write-Host \"Test-ADDSDomainInstallation error: $_\"\n            $testAttempt++\n            if ($testAttempt -lt $maxTestAttempts) {\n                Write-Host \"Retrying in 60 seconds...\"\n                Start-Sleep -Seconds 60\n            }\n        }\n    }\n    \n    if (-not $testPassed) {\n        throw \"Test-ADDSDomainInstallation failed after $maxTestAttempts attempts. Prerequisites not met.\"\n    }\n\n    # Now run the actual Install-ADDSDomain\n    # Retry logic checks the result Status since it doesn't throw exceptions on failure\n    $maxInstallAttempts = 20\n    $installAttempt = 0\n    $installSuccess = $false\n\n    while ($installAttempt -lt $maxInstallAttempts -and -not $installSuccess) {\n        Write-Host \"Attempting to configure Subdomain Controller (Attempt $($installAttempt + 1) of $maxInstallAttempts)...\"\n        \n        $installResult = Install-ADDSDomain `\n            -NewDomainName $domainName `\n            -ParentDomainName $parentDomainName `\n            -DomainType \"ChildDomain\" `\n            -InstallDNS `\n            -CreateDNSDelegation `\n            -DomainMode \"WinThreshold\" `\n            -ReplicationSourceDC $rootDomainControllerFQDN `\n            -SafeModeAdministratorPassword $secureAdminPassword `\n            -Force `\n            -Credential $enterpriseAdminCredsWithDomain\n        \n        # Check the result status - Install-ADDSDomain doesn't throw on failure\n        if ($installResult.Status -eq \"Success\") {\n            Write-Host \"Install-ADDSDomain completed successfully!\"\n            $installSuccess = $true\n        } else {\n            Write-Host \"Install-ADDSDomain returned Status: $($installResult.Status)\"\n            Write-Host \"Message: $($installResult.Message)\"\n            $installAttempt++\n            if ($installAttempt -lt $maxInstallAttempts) {\n                Write-Host \"Retrying in 60 seconds... ($installAttempt of $maxInstallAttempts attempts used)\"\n                Start-Sleep -Seconds 60\n            }\n        }\n    }\n\n    if (-not $installSuccess) {\n        throw \"Install-ADDSDomain failed after $maxInstallAttempts attempts (20 minutes).\"\n    }\n\n    # Restore 8.8.8.8 as secondary DNS for general internet connectivity\n    try {\n        $activeAdapter = Get-NetAdapter | Where-Object { $_.Status -eq 'Up' } | Select-Object -First 1\n        if ($activeAdapter -and $parentDcIp) {\n            Write-Host \"Restoring 8.8.8.8 as secondary DNS for internet connectivity...\"\n            Set-DnsClientServerAddress -InterfaceAlias $activeAdapter.InterfaceAlias -ServerAddresses @($parentDcIp, \"8.8.8.8\")\n        }\n    } catch {\n        Write-Host \"Warning: Could not restore secondary DNS: $_\"\n    }\n\n    Restart-Service NetLogon -Force -EA 0\n    Add-Content -Path $logFilePath -Value \"Successfully installed ADDS for subdomain.\"\n} catch {\n    Write-Host \"Failed to configure Subdomain Controller: $_\"\n    Add-Content -Path $logFilePath -Value \"Failed to install ADDS for subdomain. $_\"\n}\n\nStop-Transcript\n",
                            "$fxv#2": "\r\nparam(\r\n    [string]$targetFiles,\r\n    [string]$domainName\r\n)\r\n\r\n$logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n$domainDN = ($domainName -split '\\.' | ForEach-Object { \"DC=$_\" }) -join ','\r\nAdd-Content -Path $logFilePath -Value \"Domain DN: $domainDN\"\r\n\r\n$targetFilesArray = $targetFiles -split \",\"\r\n\r\nforeach ($file in $targetFilesArray)\r\n{\r\n    switch ($file)\r\n    {\r\n        'module'\r\n        {\r\n            Install-WindowsFeature -Name RSAT-AD-PowerShell\r\n            $localFilePath = \"C:\\Temp\\ADVulnEnvModule\"\r\n            $fileName = \"C:\\Temp\\ADVulnEnvModule\\ADVulnEnvModule.psm1\"\r\n\r\n            # Create directory if it doesn't exist\r\n            New-Item -ItemType Directory -Path $localFilePath -Force | Out-Null\r\n\r\n            Add-Content -Path $logFilePath -Value \"=== EMBEDDED SETUP STARTED ===\"\r\n            Add-Content -Path $logFilePath -Value \"Writing embedded module content to $fileName\"\r\n\r\n            # Module content embedded directly in script (will be replaced by bicep)\r\n            $moduleContent = @'\r\n__MODULE_CONTENT_PLACEHOLDER__\r\n'@\r\n\r\n            Add-Content -Path $logFilePath -Value \"Module content size: $($moduleContent.Length) characters\"\r\n\r\n            # Write the embedded module content to file\r\n            try {\r\n                [System.IO.File]::WriteAllText($fileName, $moduleContent, [System.Text.Encoding]::UTF8)\r\n                Add-Content -Path $logFilePath -Value \"Module content written to $fileName\"\r\n\r\n                # Verify file was created\r\n                if (Test-Path $fileName) {\r\n                    $fileSize = (Get-Item $fileName).Length\r\n                    Add-Content -Path $logFilePath -Value \"Module file verified: $fileSize bytes\"\r\n                } else {\r\n                    Add-Content -Path $logFilePath -Value \"ERROR: Module file was not created at $fileName\"\r\n                }\r\n            }\r\n            catch {\r\n                Add-Content -Path $logFilePath -Value \"ERROR writing module file: $_\"\r\n                Add-Content -Path $logFilePath -Value \"Exception type: $($_.Exception.GetType().FullName)\"\r\n                Add-Content -Path $logFilePath -Value \"Exception message: $($_.Exception.Message)\"\r\n            }\r\n        }\r\n        'esc'\r\n        {\r\n            # Create ADCS files directory\r\n            $adcsPath = \"C:\\Temp\\adcs-files\"\r\n            New-Item -ItemType Directory -Path $adcsPath -Force | Out-Null\r\n            Add-Content -Path $logFilePath -Value \"=== ESC FILES SETUP STARTED ===\"\r\n\r\n            # ESC file contents embedded directly in script (will be replaced by bicep)\r\n            $esc1Vuln = @'\r\n__ESC1_VULN_PLACEHOLDER__\r\n'@\r\n            $esc1VulnSecurityDescriptor = @'\r\n__ESC1_VULN_SD_PLACEHOLDER__\r\n'@\r\n            $esc3VulnAuthSignatures = @'\r\n__ESC3_AUTH_SIG_PLACEHOLDER__\r\n'@\r\n            $esc3VulnRequestAgentSecurityDescriptor = @'\r\n__ESC3_REQ_AGENT_SD_PLACEHOLDER__\r\n'@\r\n            $esc4VulnWrite = @'\r\n__ESC4_VULN_PLACEHOLDER__\r\n'@\r\n            $esc3VulnRequestAgent = @'\r\n__ESC3_REQ_AGENT_PLACEHOLDER__\r\n'@\r\n            $esc3VulnAuthSignaturesSecurityDescriptor = @'\r\n__ESC3_AUTH_SIG_SD_PLACEHOLDER__\r\n'@\r\n            $esc4VulnWriteSecurityDescriptor = @'\r\n__ESC4_VULN_SD_PLACEHOLDER__\r\n'@\r\n\r\n            # Replace hardcoded domain with actual domain DN\r\n            $esc1Vuln = $esc1Vuln -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc1VulnSecurityDescriptor = $esc1VulnSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnAuthSignatures = $esc3VulnAuthSignatures -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnRequestAgentSecurityDescriptor = $esc3VulnRequestAgentSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc4VulnWrite = $esc4VulnWrite -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnRequestAgent = $esc3VulnRequestAgent -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnAuthSignaturesSecurityDescriptor = $esc3VulnAuthSignaturesSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc4VulnWriteSecurityDescriptor = $esc4VulnWriteSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n\r\n            Add-Content -Path $logFilePath -Value \"Replaced hardcoded domain with $domainDN in all ESC templates\"\r\n\r\n            # Write each ESC .ldf file from embedded content\r\n            $esc1Vuln | Set-Content -Path \"$adcsPath\\ESC1Vuln.ldf\" -Force\r\n            $esc1VulnSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC1VulnSecurityDescriptor.ldf\" -Force\r\n            $esc3VulnAuthSignatures | Set-Content -Path \"$adcsPath\\ESC3VulnAuthSignatures.ldf\" -Force\r\n            $esc3VulnRequestAgentSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC3VulnRequestAgentSecurityDescriptor.ldf\" -Force\r\n            $esc4VulnWrite | Set-Content -Path \"$adcsPath\\ESC4VulnWrite.ldf\" -Force\r\n            $esc3VulnRequestAgent | Set-Content -Path \"$adcsPath\\ESC3VulnRequestAgent.ldf\" -Force\r\n            $esc3VulnAuthSignaturesSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC3VulnAuthSignaturesSecurityDescriptor.ldf\" -Force\r\n            $esc4VulnWriteSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC4VulnWriteSecurityDescriptor.ldf\" -Force\r\n\r\n            Add-Content -Path $logFilePath -Value \"Successfully wrote 8 ADCS template files to $adcsPath\"\r\n        }\r\n        Default\r\n        {\r\n            Add-Content -Path $logFilePath -Value \"Error: Unknown target file type '$file'\"\r\n        }\r\n    }\r\n}\r\n",
                            "$fxv#3": "<# =============================\r\n          Creation Functions\r\n    ============================#>\r\n\r\n\r\nFunction GenerateUsers {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Define an array of 25 names\r\n    $userNames = @(\"User1\", \"User2\", \"User3\", \"User4\", \"User5\",\r\n                   \"User6\", \"User7\", \"User8\", \"User9\", \"User10\",\r\n                   \"User11\", \"User12\", \"User13\", \"User14\", \"User15\",\r\n                   \"User16\", \"User17\", \"User18\", \"User19\", \"User20\",\r\n                   \"User21\", \"User22\", \"User23\", \"User24\", \"EntryUser\")\r\n\r\n    # Loop through each name and create a user\r\n    foreach ($name in $userNames) {\r\n        try {\r\n            Add-Type -AssemblyName System.Web\r\n    \r\n            # Assign specific simple passwords for User8(Kerberoast User) and EntryUser\r\n            if ($name -eq \"User8\") {\r\n                $password = \"Password123\"\r\n            } elseif ($name -eq \"EntryUser\" -or $name -eq \"User2\") { # Assign simple passwords for entryuser(user to login with and user2 for responder attack)\r\n                $password = \"Password#1\"\r\n            } else {\r\n                # Generate a random password for other users\r\n                $password = [System.Web.Security.Membership]::GeneratePassword(25, 1)\r\n            }\r\n    \r\n            $description = 'Inspired by secframe.com/badblood.'\r\n            $upn = \"$name@$domainName\"\r\n    \r\n            # Create the user with New-ADUser using the provided credentials\r\n            New-ADUser -Name $name -SamAccountName $name -Surname $name -Enabled $true -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n    \r\n            # Add successful execution in logs\r\n            $successMessage = \"GenerateUsers Function: Successfully created user: $name\"\r\n            Add-Content -Path $logFilePath -Value $successMessage\r\n            Write-Output $successMessage\r\n\r\n            # Add EntryUser and User2 to rdp group (entryuser to be utilize to rdp into domain and User2 used to similate traffic for responder attack)\r\n            if ($name -eq \"EntryUser\") {\r\n                # Add to domain Remote Desktop Users group (DCs don't have local groups)\r\n                Add-ADGroupMember -Identity \"Remote Desktop Users\" -Members $name -Credential $DomainAdminCreds\r\n                $rdpMessage = \"GenerateUsers Function: Added $name to Remote Desktop Users domain group\"\r\n                Add-Content -Path $logFilePath -Value $rdpMessage\r\n                Write-Output $rdpMessage\r\n            }\r\n        } catch {\r\n            # Add failed execution in logs\r\n            Add-Content -Path $logFilePath -Value \"GenerateUsers Function: Error in running function and creating user $name : $_ \"\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\nFunction GenerateRandomUsers {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [int]$numberOfUsers,\r\n        [string]$usernameFormat = \"firstname\"  # Options: \"firstname\", \"firstname.lastname\", \"firstinitial.lastname\"\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    # Log the received parameters for debugging\r\n    Add-Content -Path $logFilePath -Value \"GenerateRandomUsers Function: Received usernameFormat parameter: '$usernameFormat'\"\r\n\r\n    # Read first names from the file\r\n    $fileURL = \"https://raw.githubusercontent.com/davidprowe/BadBlood/master/AD_Users_Create/Names/names.txt\"\r\n    $namesFilePath = \"C:\\temp\\names.txt\"\r\n    Invoke-WebRequest -Uri $fileURL -OutFile $namesFilePath\r\n    if (-Not (Test-Path $namesFilePath)) {\r\n        Write-Error \"Names file not found at $namesFilePath\"\r\n        return\r\n    }\r\n\r\n    $allFirstNames = Get-Content $namesFilePath\r\n\r\n    # Read last names from the file (if needed for format)\r\n    $allLastNames = @()\r\n    if ($usernameFormat -ne \"firstname\") {\r\n        $lastNamesURL = \"https://raw.githubusercontent.com/your-repo/lastnames.txt\"\r\n        $lastNamesFilePath = \"C:\\temp\\lastnames.txt\"\r\n        \r\n        # For now, use a predefined list of common last names\r\n        $allLastNames = @(\r\n            \"smith\", \"johnson\", \"williams\", \"brown\", \"jones\", \"garcia\", \"miller\", \"davis\", \r\n            \"rodriguez\", \"martinez\", \"hernandez\", \"lopez\", \"gonzalez\", \"wilson\", \"anderson\", \r\n            \"thomas\", \"taylor\", \"moore\", \"jackson\", \"martin\", \"lee\", \"perez\", \"thompson\", \r\n            \"white\", \"harris\", \"sanchez\", \"clark\", \"ramirez\", \"lewis\", \"robinson\", \"walker\",\r\n            \"young\", \"allen\", \"king\", \"wright\", \"scott\", \"torres\", \"nguyen\", \"hill\", \"flores\",\r\n            \"green\", \"adams\", \"nelson\", \"baker\", \"hall\", \"rivera\", \"campbell\", \"mitchell\",\r\n            \"carter\", \"roberts\", \"gomez\", \"phillips\", \"evans\", \"turner\", \"diaz\", \"parker\",\r\n            \"cruz\", \"edwards\", \"collins\", \"reyes\", \"stewart\", \"morris\", \"morales\", \"murphy\",\r\n            \"cook\", \"rogers\", \"gutierrez\", \"ortiz\", \"morgan\", \"cooper\", \"peterson\", \"bailey\",\r\n            \"reed\", \"kelly\", \"howard\", \"ramos\", \"kim\", \"cox\", \"ward\", \"richardson\", \"watson\",\r\n            \"brooks\", \"chavez\", \"wood\", \"james\", \"bennett\", \"gray\", \"mendoza\", \"ruiz\", \"hughes\",\r\n            \"price\", \"alvarez\", \"castillo\", \"sanders\", \"patel\", \"myers\", \"long\", \"ross\", \"foster\"\r\n        )\r\n    }\r\n\r\n    # Generate usernames based on format\r\n    $generatedUsernames = @()\r\n    for ($i = 0; $i -lt $numberOfUsers; $i++) {\r\n        $firstName = (Get-Random -InputObject $allFirstNames).ToLower()\r\n        \r\n        switch ($usernameFormat) {\r\n            \"firstname\" {\r\n                $username = $firstName\r\n            }\r\n            \"firstname.lastname\" {\r\n                $lastName = (Get-Random -InputObject $allLastNames).ToLower()\r\n                $username = \"$firstName.$lastName\"\r\n            }\r\n            \"firstinitial.lastname\" {\r\n                $lastName = (Get-Random -InputObject $allLastNames).ToLower()\r\n                $firstInitial = $firstName.Substring(0, 1).ToLower()\r\n                $username = \"$firstInitial$lastName\"\r\n            }\r\n            default {\r\n                $username = $firstName\r\n            }\r\n        }\r\n        \r\n        # Ensure username is unique in this batch\r\n        $counter = 1\r\n        $originalUsername = $username\r\n        while ($generatedUsernames -contains $username) {\r\n            $username = \"$originalUsername$counter\"\r\n            $counter++\r\n        }\r\n        \r\n        $generatedUsernames += $username\r\n    }\r\n\r\n    # Loop through each generated username and create a user\r\n    foreach ($username in $generatedUsernames) {\r\n        try {\r\n            Add-Type -AssemblyName System.Web\r\n\r\n            # Generate a random password for the user\r\n            $password = [System.Web.Security.Membership]::GeneratePassword(25, 1)\r\n\r\n            $description = 'Inspired by secframe.com/badblood.'\r\n            $upn = \"$username@$domainName\"\r\n            \r\n            # Use the username as both the display name and SAM account name\r\n            $displayName = $username\r\n\r\n            # Create the user with New-ADUser using the provided credentials\r\n            New-ADUser -Name $displayName -SamAccountName $username -Surname $username -Enabled $true -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n\r\n            # Add successful execution in logs\r\n            $successMessage = \"GenerateRandomUsers Function: Successfully created user: $username\"\r\n            Add-Content -Path $logFilePath -Value $successMessage\r\n            Write-Output $successMessage\r\n        } catch {\r\n            # Add failed execution in logs\r\n            Add-Content -Path $logFilePath -Value \"GenerateRandomUsers Function: Error in running function and creating user $username : $_ \"\r\n        }\r\n    }\r\n}\r\nFunction CreateSingleUser {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$singleUsername,\r\n        [string]$singleUserPassword\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    $description = 'Single User Creation'\r\n    $upn = \"$singleUsername@$domainName\"\r\n    \r\n    try {\r\n        # Create the user with New-ADUser using the provided credentials\r\n        New-ADUser -Name $singleUsername -SamAccountName $singleUsername -Surname $singleUsername -Enabled $true -AccountPassword (ConvertTo-SecureString $singleUserPassword -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n\r\n        # Add successful execution in logs\r\n        $successMessage = \"CreateSingleUser Function: Successfully created user: $singleUsername\"\r\n        Add-Content -Path $logFilePath -Value $successMessage\r\n        Write-Output $successMessage\r\n\r\n    }\r\n    catch {\r\n        # Add failed execution in logs\r\n        Add-Content -Path $logFilePath -Value \"CreateSingleUser Function: Error in running function and creating user $singleUsername : $_ \"\r\n    }\r\n    \r\n}\r\n\r\nFunction ConfigureUserToRDP {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$targetUser\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    try {\r\n        Add-Type -AssemblyName System.Web\r\n\r\n\r\n        Add-ADGroupMember -Identity \"Remote Desktop Users\" -Members $targetUser -Credential $DomainAdminCreds\r\n        Add-LocalGroupMember -Group \"Remote Desktop Users\" -Member $targetUser \r\n        Add-Content -Path $logFilePath -Value \"ConfigureUserToRDP Function: Added $targetUser to Remote Desktop Users group\"\r\n        \r\n    } catch {\r\n        # Add failed execution in logs\r\n        Add-Content -Path $logFilePath -Value \"ConfigureUserToRDP Function: Error in running function $targetUser : $_ \"\r\n    }\r\n}\r\n\r\nFunction CreateAndOrganizeOUs {\r\n    param (\r\n        [string]$OU1Name,\r\n        [string]$OU2Name,\r\n        [int]$NumberOfUsersInOU1,\r\n        [pscredential]$DomainAdminCreds\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Create the first OU\r\n        New-ADOrganizationalUnit -Name $OU1Name -Credential $DomainAdminCreds\r\n        Add-Content -Path $logFilePath -Value \"Created OU: $OU1Name\"\r\n\r\n        # Create the second OU\r\n        New-ADOrganizationalUnit -Name $OU2Name -Credential $DomainAdminCreds\r\n        Add-Content -Path $logFilePath -Value \"Created OU: $OU2Name\"\r\n\r\n        # Move users to the first OU\r\n        $users = Get-ADUser -Filter * -SearchBase \"CN=Users,DC=redteam,DC=lab\" | Select-Object -First $NumberOfUsersInOU1\r\n        foreach ($user in $users) {\r\n            Move-ADObject -Identity $user.DistinguishedName -TargetPath \"OU=$OU1Name,DC=redteam,DC=lab\"\r\n            Add-Content -Path $logFilePath -Value \"Moved user $($user.Name) to OU: $OU1Name\"\r\n        }\r\n\r\n        # Move the remaining users to the second OU\r\n        $remainingUsers = Get-ADUser -Filter * -SearchBase \"CN=Users,DC=redteam,DC=lab\" \r\n        foreach ($user in $remainingUsers) {\r\n            Move-ADObject -Identity $user.DistinguishedName -TargetPath \"OU=$OU2Name,DC=redteam,DC=lab\"\r\n            Add-Content -Path $logFilePath -Value \"Moved user $($user.Name) to OU: $OU2Name\"\r\n        }\r\n\r\n    } catch {\r\n        Add-Content -Path $logFilePath -Value \"Error in CreateAndOrganizeOUs: $_ \"\r\n    }\r\n}\r\n\r\nFunction CreateComputerObjects {\r\n    param (\r\n        [string]$TargetOU, # Optional: OU to place the computer objects\r\n        [pscredential]$DomainAdminCreds\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Predefined list of computer names\r\n    $ComputerNames = @(\"Computer1\", \"Computer2\", \"Computer3\", \"Computer4\", \"Computer5\")\r\n\r\n    foreach ($name in $ComputerNames) {\r\n        try {\r\n            $params = @{\r\n                Name = $name\r\n                Credential = $DomainAdminCreds\r\n                Path = if ($TargetOU) { \"OU=$TargetOU,DC=redteam,DC=lab\" } else { \"CN=Computers,DC=redteam,DC=lab\" }\r\n            }\r\n\r\n            # Create the computer object\r\n            New-ADComputer @params\r\n\r\n            # Log success\r\n            Add-Content -Path $logFilePath -Value \"CreateComputerObjects: Successfully created computer object: $name\"\r\n        } catch {\r\n            # Log any errors\r\n            Add-Content -Path $logFilePath -Value \"CreateComputerObjects: Error creating computer object $name : $_ \"\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n<# =================================\r\n        Attack Vector Functions\r\n    ================================#>\r\n\r\nFunction Import-VulnerableCertificateTemplate {\r\n    param (\r\n        [string]$domainAdminUsername,\r\n        [string]$domainAdminPassword,\r\n        [string]$domainName,\r\n        [string]$templateName\r\n    )\r\n    $logLocation = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n        ldifde -i -k -f \"C:\\Temp\\adcs-files\\$templateName.ldf\" -b $domainAdminUsername $domainName $domainAdminPassword\r\n        ldifde -i -k -f $(\"C:\\Temp\\adcs-files\\\" + $templateName + \"SecurityDescriptor.ldf\") -b $domainAdminUsername $domainName $domainAdminPassword\r\n\r\n        # For ESC4, grant Domain Users WriteProperty and Enroll permissions\r\n        if ($templateName -eq \"ESC4VulnWrite\") {\r\n            Add-Content -Path $logLocation -Value \"Setting ESC4VulnWrite ACL for Domain Users...\"\r\n            $domain = (Get-ADDomain).NetBIOSName\r\n            $templateDN = \"CN=$templateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=$($domainName.Replace('.', ',DC='))\"\r\n\r\n            # Grant Write Property permission (to modify template attributes)\r\n            $result1 = dsacls $templateDN /G \"${domain}\\Domain Users:RPWP\" 2>&1\r\n            Add-Content -Path $logLocation -Value \"dsacls WriteProperty result: $result1\"\r\n\r\n            # Grant enrollment extended right (GUID 0e10c968-78fb-11d2-90d4-00c04f79dc55)\r\n            $result2 = dsacls $templateDN /G \"${domain}\\Domain Users:CA;0e10c968-78fb-11d2-90d4-00c04f79dc55\" 2>&1\r\n            Add-Content -Path $logLocation -Value \"dsacls Enrollment result: $result2\"\r\n\r\n            Add-Content -Path $logLocation -Value \"ESC4VulnWrite ACL updated successfully\"\r\n        }\r\n\r\n        Restart-Service -Name certsvc -Force\r\n    } catch {\r\n        Add-Content -Path $logLocation -Value \"Error Enabling $templateName : $_ \"\r\n    }\r\n}\r\n\r\nFunction Disable-PreAuth {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Use the credentials for AD operations\r\n        Set-ADAccountControl -Credential $domainAdminCreds -Identity $targetUser -DoesNotRequirePreAuth:$true\r\n\r\n        # Add successfull execution in logs\r\n        Add-Content -Path $logFilePath -Value \"DisablePreAuth Function: Successfully disabled preauth for $targetUser\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"DisablePreAuth Function: Error running Disable-PreAuth: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-User-for-Kerberoast {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Generate unique SPN per user by including username in hostname\r\n        $uniqueSpn = \"MSSQLSvc/sql-$targetUser.$domainName:1433\"\r\n\r\n        # Use the credentials for AD operations\r\n        Set-ADUser -Credential $domainAdminCreds -Identity $targetUser -ServicePrincipalNames @{Add=$uniqueSpn}\r\n\r\n        # Add successfull execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Kerberoast Function: Made $targetUser be kerberoasted with SPN $uniqueSpn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Kerberoast Function: Error running Update-User-for-Kerberoast: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-User-for-Constrained-Delegation {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$userForCDelegation,\r\n        [string]$dcName,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Set the SPN for the DC\r\n        $spn = \"HTTP/$dcName.$domainName\"\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $dcName -ServicePrincipalNames @{ADD=$spn}\r\n        # Use the credentials for AD operations\r\n        Get-ADUser -Credential $domainAdminCreds -Identity $userForCDelegation | Set-ADAccountControl -TrustedToAuthForDelegation $true\r\n        Set-ADUser -Credential $domainAdminCreds -Identity $userForCDelegation -Add @{'msDS-AllowedToDelegateTo'=@($spn)}\r\n        \r\n        # Add successful execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Constrained-Delegation Function: Configured $userForCDelegation for constrained delegation with SPN $spn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Constrained-Delegation Function: Error running Update-User-for-Constrained-Delegation: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-Computer-for-Constrained-Delegation {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$computerForCDelegation,\r\n        [string]$dcName,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n        # Set the SPN for the DC\r\n        $spn = \"HTTP/$dcName.$domainName\"\r\n        #Add spn onto DC\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $dcName -ServicePrincipalNames @{ADD=$spn}\r\n        # set target computer to be able to delegate\r\n        Get-ADComputer -Credential $domainAdminCreds -Identity $computerForCDelegation | Set-ADAccountControl -TrustedToAuthForDelegation $true\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $computerForCDelegation -Add @{'msDS-AllowedToDelegateTo'=@($spn)}\r\n        \r\n        # Add successful execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-Computer-for-Constrained-Delegation Function: Configured $computerForCDelegation for constrained delegation with SPN $spn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-Computer-for-Constrained-Delegation Function: Error running Update-Computer-for-Constrained-Delegation: $_ \"\r\n    }\r\n}\r\n\r\n\r\nFunction Set-ADUserPermissions {\r\n    param (\r\n        [string]$GrantingUser,\r\n        [string]$ReceivingUser,\r\n        [string]$PermissionType\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    try {\r\n        # Get the AD user object for the receiving user\r\n        $user = Get-ADUser -Identity $ReceivingUser\r\n\r\n        # Define the type of access right based on the PermissionType string\r\n        $accessRight = @{\r\n            \"GenericAll\" = [System.DirectoryServices.ActiveDirectoryRights]::GenericAll\r\n            \"GenericWrite\" = [System.DirectoryServices.ActiveDirectoryRights]::WriteProperty\r\n        }\r\n\r\n        # Create an Access Control Entry (ACE)\r\n        $ace = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(\r\n            (New-Object System.Security.Principal.NTAccount($GrantingUser)),\r\n            $accessRight[$PermissionType],\r\n            'Allow'\r\n        )\r\n\r\n        # Get the current ACL for the user\r\n        $acl = Get-Acl \"AD:$($user.DistinguishedName)\"\r\n\r\n        # Add the new ACE to the ACL\r\n        $acl.AddAccessRule($ace)\r\n\r\n        # Set the new ACL on the user object\r\n        Set-Acl \"AD:$($user.DistinguishedName)\" $acl\r\n\r\n        # Log success\r\n        Add-Content -Path $logFilePath -Value \"Set-ADUserPermissions: Successfully set $PermissionType permission for $GrantingUser on $ReceivingUser\"\r\n    } catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Set-ADUserPermissions: Error setting permissions for $GrantingUser on $ReceivingUser : $_ \"\r\n    }\r\n}\r\n\r\nFunction SimulateUserTrafficAsUser2 {\r\n    param (\r\n        [string]$BogusSharePath,\r\n        [int]$IntervalSeconds\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # User2's credentials\r\n    $user2Username = \"redteam.lab\\User2\"\r\n    $user2Password = ConvertTo-SecureString \"Password#1\" -AsPlainText -Force\r\n    $user2Creds = New-Object System.Management.Automation.PSCredential ($user2Username, $user2Password)\r\n\r\n    # Script block to simulate traffic\r\n    $scriptBlock = {\r\n        param($BogusSharePath, $logFilePath, $IntervalSeconds)\r\n        while ($true) {\r\n            try {\r\n                # Attempt to access the bogus file share\r\n                & cmd.exe /c dir $BogusSharePath\r\n\r\n                # Log the attempt\r\n                Add-Content -Path $logFilePath -Value \"SimulateUserTraffic: Attempted to access $BogusSharePath\"\r\n            } catch {\r\n                # Log any errors from the attempt\r\n                Add-Content -Path $logFilePath -Value \"SimulateUserTraffic: Error accessing $BogusSharePath : $_ \"\r\n            }\r\n\r\n            # Wait for the specified interval\r\n            Start-Sleep -Seconds $IntervalSeconds\r\n        }\r\n    }\r\n\r\n    # Start the script block as a background job\r\n    Start-Job -ScriptBlock $scriptBlock -ArgumentList $BogusSharePath, $logFilePath, $IntervalSeconds -Credential $user2Creds\r\n}\r\n\r\nFunction Set-LocalPrivEsc-BinPathWriteAccess {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    # Specify the service you're targeting\r\n    $service = \"wuauserv\"\r\n    $domainUser = \"$domainName\\$targetUser\"\r\n    # File for acl updates\r\n    $downloadUrl =  \"http://web.archive.org/web/20190910062448if_/http://download.microsoft.com/download/1/7/d/17d82b72-bc6a-4dc8-bfaa-98b37b22b367/subinacl.msi\"\r\n    $localPath = \"C:\\Temp\\subinacl.msi\"  \r\n    try {\r\n        # Download subinacl.msi\r\n        Invoke-WebRequest -Uri $downloadUrl -OutFile $localPath  \r\n        # Install it silently to prevent gui\r\n        Start-Process \"msiexec.exe\" -ArgumentList \"/i $localPath /qn /norestart\" -NoNewWindow -Wait  \r\n        $subinaclPath = \"C:\\Program Files (x86)\\Windows Resource Kits\\Tools\\subinacl.exe\"  \r\n        # Grant targetuser full permissions on bin\r\n        & $subinaclPath /service $service /grant=$domainUser=F\r\n        # Log success\r\n        Add-Content -Path $logFilePath -Value \"Grant-ServiceBinPathWriteAccess: Successfully granted write access to binPath of $service for $targetUser.\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Grant-ServiceBinPathWriteAccess: Error granting write access to binPath of $service for $targetUser : $_\"\r\n    }\r\n}\r\n\r\n\r\nFunction Set-UnquotedServicePathVulnerability {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$vulnerablePath = \"C:\\Program Files\\My Vulnerable App\"\r\n    )\r\n\r\n    # Define the benign executable and service details\r\n    $benignExecutable = \"C:\\Windows\\System32\\notepad.exe\" # Example benign executable\r\n    $serviceName = \"BenignService\"\r\n    $serviceDisplayName = \"Benign Service\"\r\n    $servicePath = \"$vulnerablePath\\service.exe\" # Construct the service path with spaces\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\unquotedServicePathVulnerabilityLog.txt\"\r\n\r\n    try {\r\n        # Ensure the vulnerable directory path exists\r\n        New-Item -ItemType Directory -Path $vulnerablePath -Force\r\n\r\n        # Copy the benign executable to the service path (simulating a service installation)\r\n        Copy-Item -Path $benignExecutable -Destination $servicePath -Force\r\n\r\n        # Create the new service using sc.exe to bypass PowerShell cmdlet limitations on path quoting\r\n        $scArgs = \"create $serviceName binPath= `\"$servicePath`\" DisplayName= `\"$serviceDisplayName`\"\"\r\n        $scCreateResult = Start-Process sc.exe -ArgumentList $scArgs -Wait -PassThru -NoNewWindow\r\n\r\n        # Verify service creation was successful\r\n        if ($scCreateResult.ExitCode -eq 0) {\r\n            Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Service '$serviceName' created successfully.\"\r\n        } else {\r\n            throw \"Failed to create service. Exit Code: $($scCreateResult.ExitCode)\"\r\n        }\r\n\r\n        # Grant write access to the target user for the vulnerable part of the path\r\n        $acl = Get-Acl $vulnerablePath\r\n        $permission = \"$targetUser\",\"Modify\",\"Allow\"\r\n        $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission\r\n        $acl.AddAccessRule($accessRule)\r\n        Set-Acl -Path $vulnerablePath -AclObject $acl\r\n\r\n        Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Granted Modify access to '$targetUser' on '$vulnerablePath'.\"\r\n    }\r\n    catch {\r\n        Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Error encountered: $_ \"\r\n    }\r\n}\r\n\r\n\r\n<#\r\nFunction Set-DomainAdminStoredCreds {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n\r\n    # Generate a simple password for the target user\r\n    $newPassword = \"Password123!\"\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\domainAdminStoredCredsLog.txt\"\r\n\r\n    try {\r\n        # Change the password of the target user\r\n        Set-ADAccountPassword -Identity $targetUser -NewPassword (ConvertTo-SecureString $newPassword -AsPlainText -Force) -Credential $domainAdminCreds\r\n\r\n        # Extract domain admin credentials\r\n        $domainAdminUser = $domainAdminCreds.UserName\r\n        $domainAdminPassword = $domainAdminCreds.GetNetworkCredential().Password\r\n\r\n        # Use cmdkey to add stored credentials\r\n        $targetUserFQDN = \"$domainName\\$targetUser\"\r\n\r\n        Start-Process -FilePath \"cmdkey\" -ArgumentList \"/generic:$targetUserFQDN /user:$targetUserFQDN /pass:$newPassword\" -Credential $adminCreds -NoNewWindow -Wait\r\n\r\n        # Logging the action\r\n        Add-Content -Path $logFilePath -Value \"Set-DomainAdminStoredCreds: Successfully changed password and added stored credentials for '$targetUser'.\"\r\n    }\r\n    catch {\r\n        Add-Content -Path $logFilePath -Value \"Set-DomainAdminStoredCreds: Error encountered: $_ \"\r\n    }\r\n}\r\n#>\r\nFunction Add-CredsForMimikatz {\r\n    param (\r\n        [string]$userForMimikatz,\r\n        [string]$singleUserPassword,\r\n        [string]$domainName,\r\n        [string]$computerForMimikatz\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n       # Need to add user to local admin group in order to be able to psremote in and provide creds.\r\n       #Add-LocalGroupMember -Group \"Administrators\" -Member $userForMimikatz\r\n \r\n       $username = \"$domainName\\$userForMimikatz\"\r\n       $password = ConvertTo-SecureString $singleUserPassword -AsPlainText -Force\r\n       $credential = New-Object System.Management.Automation.PSCredential ($username, $password)\r\n       Invoke-Command -Credential $credential -ComputerName $computerForMimikatz -ScriptBlock {Start-Process powershell.exe}\r\n       Add-Content -Path $logFilePath -Value \"Add-CredsForMimikatz: Configured $userForMimikatz to have hash within the targetbox\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Add-CredsForMimikatz Function: Error running Add-CredsForMimikatz: $_ \"\r\n    }\r\n\r\n\r\n}\r\n\r\n\r\nFunction GenerateRandomCTF {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$dcName,\r\n        [int]$numberOfUsers,\r\n        [string]$targetBox,\r\n        [string]$difficulty\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Generate random users\r\n    GenerateRandomUsers -DomainAdminCreds $DomainAdminCreds -domainName $domainName -numberOfUsers $numberOfUsers\r\n\r\n    # Get all generated users\r\n    $randomUsers = Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName\r\n\r\n    # Assign RDP permissions to a random user\r\n    $entryUser = Get-Random -InputObject $randomUsers\r\n    ConfigureUserToRDP -DomainAdminCreds $DomainAdminCreds -domainName $domainName -targetUser $entryUser\r\n    Set-ADAccountPassword -Identity $entryUser -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n\r\n    # Determine attack count based on difficulty\r\n    $attackCount = switch ($difficulty) {\r\n        \"easy\" { 2 }\r\n        \"medium\" { 3 }\r\n        \"hard\" { 4 }\r\n        default { 2 }\r\n    }\r\n\r\n    # Define all attacks\r\n    $attacks = @(\r\n        \"Disable-PreAuth\", \r\n        \"Update-User-for-Kerberoast\", \r\n        \"Update-User-for-Constrained-Delegation\", \r\n        \"Update-Computer-for-Constrained-Delegation\", \r\n        \"Set-LocalPrivEsc-BinPathWriteAccess\", \r\n        \"Set-UnquotedServicePathVulnerability\", \r\n        \"Add-CredsForMimikatz\"\r\n    )\r\n\r\n    # Select the first attack\r\n    $firstAttackOptions = $attacks | Where-Object { $_ -in @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\", \"Disable-PreAuth\", \"Update-User-for-Kerberoast\") }\r\n    $firstAttack = Get-Random -InputObject $firstAttackOptions\r\n\r\n    # Remove first attack from remaining attacks\r\n    $remainingAttacks = $attacks | Where-Object { $_ -ne $firstAttack }\r\n\r\n    # Ensure the last attack leads to domain admin\r\n    $lastAttackOptions = @(\"Update-User-for-Constrained-Delegation\", \"Update-Computer-for-Constrained-Delegation\", \"Add-CredsForMimikatz\")\r\n    $lastAttack = Get-Random -InputObject $lastAttackOptions\r\n\r\n    # Adjust attack count to ensure it's valid\r\n    $countToSelect = [math]::Max($attackCount - 2, 0)\r\n    if ($countToSelect -gt 0) {\r\n        $selectedAttacks = @($firstAttack) + (Get-Random -InputObject $remainingAttacks -Count $countToSelect) + $lastAttack\r\n    } else {\r\n        $selectedAttacks = @($firstAttack, $lastAttack)\r\n    }\r\n\r\n    # Ensure Mimikatz or Update-Computer-for-Constrained-Delegation follows a priv esc attack and adjust selection if necessary\r\n    if ($selectedAttacks[-1] -in @(\"Add-CredsForMimikatz\", \"Update-Computer-for-Constrained-Delegation\") -and $firstAttack -notin @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\")) {\r\n        $firstAttack = Get-Random -InputObject @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\")\r\n        $selectedAttacks[0] = $firstAttack\r\n    }\r\n\r\n    # Initialize applied attacks array and previous user\r\n    $appliedAttacks = @()\r\n    $previousUser = $null\r\n\r\n    # Process attacks\r\n    foreach ($attack in $selectedAttacks) {\r\n        switch ($attack) {\r\n            \"Disable-PreAuth\" {\r\n                $user = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                Disable-PreAuth -domainAdminCreds $DomainAdminCreds -targetUser $user\r\n                Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                $appliedAttacks += \"Disable-PreAuth\"\r\n                $previousUser = $user\r\n            }\r\n            \"Update-User-for-Kerberoast\" {\r\n                $user = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                Update-User-for-Kerberoast -domainAdminCreds $DomainAdminCreds -targetUser $user -domainName $domainName\r\n                Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                $appliedAttacks += \"Update-User-for-Kerberoast\"\r\n                $previousUser = $user\r\n            }\r\n            \"Update-User-for-Constrained-Delegation\" {\r\n                if ($previousUser -ne $null -and $appliedAttacks -contains \"Disable-PreAuth\" -or $appliedAttacks -contains \"Update-User-for-Kerberoast\" -or $appliedAttacks -contains \"Add-CredsForMimikatz\") {\r\n                    Update-User-for-Constrained-Delegation -domainAdminCreds $DomainAdminCreds -userForCDelegation $previousUser -dcName $dcName -domainName $domainName\r\n                    $appliedAttacks += \"Update-User-for-Constrained-Delegation\"\r\n                }\r\n            }\r\n            \"Update-Computer-for-Constrained-Delegation\" {\r\n                if ($appliedAttacks -contains \"Set-LocalPrivEsc-BinPathWriteAccess\" -or $appliedAttacks -contains \"Set-UnquotedServicePathVulnerability\") {\r\n                    Update-Computer-for-Constrained-Delegation -domainAdminCreds $DomainAdminCreds -computerForCDelegation $targetBox -dcName $dcName -domainName $domainName\r\n                    $appliedAttacks += \"Update-Computer-for-Constrained-Delegation\"\r\n                }\r\n            }\r\n            \"Set-LocalPrivEsc-BinPathWriteAccess\" {\r\n                Set-LocalPrivEsc-BinPathWriteAccess -domainAdminCreds $DomainAdminCreds -targetUser $entryUser -domainName $domainName\r\n                $appliedAttacks += \"Set-LocalPrivEsc-BinPathWriteAccess\"\r\n            }\r\n            \"Set-UnquotedServicePathVulnerability\" {\r\n                Set-UnquotedServicePathVulnerability -domainAdminCreds $DomainAdminCreds -targetUser $entryUser\r\n                $appliedAttacks += \"Set-UnquotedServicePathVulnerability\"\r\n            }\r\n            \"Add-CredsForMimikatz\" {\r\n                if ($appliedAttacks -contains \"Set-LocalPrivEsc-BinPathWriteAccess\" -or $appliedAttacks -contains \"Set-UnquotedServicePathVulnerability\") {\r\n                    $mimikatzUser = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                    Set-ADAccountPassword -Identity $mimikatzUser -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                    Add-CredsForMimikatz -userForMimikatz $mimikatzUser -singleUserPassword \"Password123\" -domainName $domainName -computerForMimikatz $targetBox\r\n                    $appliedAttacks += \"Add-CredsForMimikatz\"\r\n                    $previousUser = $mimikatzUser\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    # Log applied attacks\r\n    Add-Content -Path $logFilePath -Value \"GenerateRandomCTF: Successfully generated a random CTF with $($appliedAttacks.Count) attacks: $($appliedAttacks -join ', ')\"\r\n}\r\n\r\n\r\n\r\n",
                            "parentDomainName": "[if(not(empty(parameters('domainName'))), join(skip(split(parameters('domainName'), '.'), 1), '.'), '')]",
                            "isIP10": "[startsWith(parameters('privateIPAddress'), '10.10.')]",
                            "isIP172": "[startsWith(parameters('privateIPAddress'), '172.16.')]",
                            "isIP192": "[startsWith(parameters('privateIPAddress'), '192.168.')]",
                            "vName": "[if(parameters('oldScenarios'), 'lab-network', if(variables('isIP10'), 'vnet-10', if(variables('isIP172'), 'vnet-172', 'vnet-192')))]",
                            "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(variables('isIP10'), 'vnet-10/subnet-10', if(variables('isIP172'), 'vnet-172/subnet-172', 'vnet-192/subnet-192')))]",
                            "currentNetwork": "[if(startsWith(parameters('privateIPAddress'), '10.10.'), '10', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172', '192'))]",
                            "parentNetwork": "[if(startsWith(parameters('parentDomainControllerPrivateIp'), '10.10.'), '10', if(startsWith(parameters('parentDomainControllerPrivateIp'), '172.16.'), '172', '192'))]",
                            "requiresPeering": "[and(not(empty(parameters('parentDomainControllerPrivateIp'))), not(equals(variables('currentNetwork'), variables('parentNetwork'))))]",
                            "jumpboxNetwork": "[if(empty(parameters('jumpboxPrivateIPAddress')), '00', if(startsWith(parameters('jumpboxPrivateIPAddress'), '10.10.'), '10', if(startsWith(parameters('jumpboxPrivateIPAddress'), '172.16.'), '172', '192')))]",
                            "isJumpbox": "[if(and(and(and(not(empty(parameters('privateIPAddress'))), not(empty(parameters('connectedPrivateIPAddress')))), not(empty(variables('currentNetwork')))), not(empty(variables('jumpboxNetwork')))), and(equals(parameters('privateIPAddress'), parameters('connectedPrivateIPAddress')), not(equals(variables('currentNetwork'), variables('jumpboxNetwork')))), false())]",
                            "dcPeeringRules": "[if(variables('requiresPeering'), createArray(createObject('name', 'Allow-SpecificDC-Communication-Inbound', 'properties', createObject('description', 'Allows inbound traffic between specific DCs', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('parentDomainControllerPrivateIp'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 100, 'direction', 'Inbound')), createObject('name', 'Allow-SpecificDC-Communication-Outbound', 'properties', createObject('description', 'Allows outbound traffic between specific DCs', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('privateIPAddress'), 'destinationAddressPrefix', parameters('parentDomainControllerPrivateIp'), 'access', 'Allow', 'priority', 100, 'direction', 'Outbound')), createObject('name', 'Allow-IntraSubnet-Inbound', 'properties', createObject('description', 'Allows all inbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Inbound')), createObject('name', 'Allow-IntraSubnet-Outbound', 'properties', createObject('description', 'Allows all outbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Outbound')), createObject('name', 'Deny-CrossSubnet-Inbound', 'properties', createObject('description', 'Denies all other inbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('parentDomainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('parentDomainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Inbound')), createObject('name', 'Deny-CrossSubnet-Outbound', 'properties', createObject('description', 'Denies all other outbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('parentDomainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('parentDomainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Outbound'))), createArray())]",
                            "jumpboxRules": "[if(variables('isJumpbox'), createArray(createObject('name', 'Allow-Jumpbox-Communication-Inbound', 'properties', createObject('description', 'Allows inbound traffic from jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 150, 'direction', 'Inbound')), createObject('name', 'Allow-Jumpbox-Communication-Outbound', 'properties', createObject('description', 'Allows outbound traffic to jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('privateIPAddress'), 'destinationAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'access', 'Allow', 'priority', 150, 'direction', 'Outbound'))), createArray())]",
                            "publicIPRules": "[if(parameters('hasPublicIP'), createArray(createObject('name', 'Allow-RDP-from-Caller', 'properties', createObject('description', 'Allows RDP access from the caller IP address', 'protocol', 'TCP', 'sourcePortRange', '*', 'destinationPortRange', '3389', 'sourceAddressPrefix', if(not(empty(parameters('callerIPAddress'))), parameters('callerIPAddress'), '0.0.0.0/0'), 'destinationAddressPrefix', '*', 'access', 'Allow', 'priority', 100, 'direction', 'Inbound')), createObject('name', 'Outbound-Internet-Access', 'properties', createObject('description', 'Allows outbound internet access', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', '*', 'destinationAddressPrefix', 'Internet', 'access', 'Allow', 'priority', 100, 'direction', 'Outbound'))), createArray())]",
                            "allNSG": "[concat(variables('dcPeeringRules'), variables('jumpboxRules'), variables('publicIPRules'))]"
                          },
                          "resources": [
                            {
                              "condition": "[not(empty(variables('allNSG')))]",
                              "type": "Microsoft.Network/networkSecurityGroups",
                              "apiVersion": "2023-05-01",
                              "name": "[format('combined-nsg-{0}', parameters('virtualMachineHostname'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "securityRules": "[variables('allNSG')]"
                              }
                            },
                            {
                              "condition": "[parameters('hasPublicIP')]",
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}-public-ip', parameters('virtualMachineHostname'))]",
                              "location": "[parameters('location')]",
                              "sku": {
                                "name": "Basic",
                                "tier": "Regional"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "Dynamic"
                              }
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2022-11-01",
                              "name": "[format('{0}-NIC', parameters('virtualMachineHostname'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "dnsSettings": {
                                  "dnsServers": [
                                    "[parameters('privateIPAddress')]",
                                    "8.8.8.8"
                                  ]
                                },
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAllocationMethod": "Static",
                                      "privateIPAddress": "[parameters('privateIPAddress')]",
                                      "subnet": {
                                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', split(variables('subnetName'), '/')[0], split(variables('subnetName'), '/')[1])]"
                                      },
                                      "publicIPAddress": "[if(parameters('hasPublicIP'), createObject('id', resourceId('Microsoft.Network/publicIPAddresses', format('{0}-public-ip', parameters('virtualMachineHostname')))), null())]"
                                    }
                                  }
                                ],
                                "networkSecurityGroup": "[if(not(empty(variables('allNSG'))), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', format('combined-nsg-{0}', parameters('virtualMachineHostname')))), null())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkSecurityGroups', format('combined-nsg-{0}', parameters('virtualMachineHostname')))]",
                                "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-public-ip', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[variables('requiresPeering')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('parentNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('parentNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[variables('requiresPeering')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('parentNetwork'), variables('currentNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('currentNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]",
                                "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('parentNetwork')), '/')[0], split(format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('parentNetwork')), '/')[1])]"
                              ]
                            },
                            {
                              "condition": "[variables('isJumpbox')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('jumpboxNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('jumpboxNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'deploy')]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2023-07-01",
                              "name": "[parameters('virtualMachineHostname')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('RootDC:{0}', parameters('resourceGroupName'))]"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "id": "[parameters('imageReference')]"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2022-11-01",
                              "name": "[parameters('virtualMachineHostname')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('RootDC:{0}', parameters('resourceGroupName'))]"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "osDisk": {
                                    "createOption": "fromImage",
                                    "managedDisk": {
                                      "storageAccountType": "[parameters('osDiskType')]"
                                    }
                                  },
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2022-datacenter-g2",
                                    "version": "latest"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                                    }
                                  ]
                                },
                                "osProfile": {
                                  "computerName": "[parameters('virtualMachineHostname')]",
                                  "adminUsername": "[parameters('enterpriseAdminUsername')]",
                                  "adminPassword": "[parameters('enterpriseAdminPassword')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[and(parameters('isRoot'), equals(parameters('deployOrBuild'), 'build'))]",
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-07-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'ConfigureRootDC')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "parameters": [
                                  {
                                    "name": "enterpriseAdminUsername",
                                    "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                                  },
                                  {
                                    "name": "enterpriseAdminPassword",
                                    "value": "[parameters('enterpriseAdminPassword')]"
                                  },
                                  {
                                    "name": "domainName",
                                    "value": "[parameters('domainName')]"
                                  },
                                  {
                                    "name": "rootDomainNetBIOSName",
                                    "value": "[parameters('rootDomainNetBIOSName')]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#0')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]"
                              ]
                            },
                            {
                              "condition": "[and(not(parameters('isRoot')), equals(parameters('deployOrBuild'), 'build'))]",
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-07-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'ConfigureSubDC')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "parameters": [
                                  {
                                    "name": "enterpriseAdminUsername",
                                    "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                                  },
                                  {
                                    "name": "enterpriseAdminPassword",
                                    "value": "[parameters('enterpriseAdminPassword')]"
                                  },
                                  {
                                    "name": "domainName",
                                    "value": "[split(parameters('domainName'), '.')[0]]"
                                  },
                                  {
                                    "name": "parentDomainName",
                                    "value": "[variables('parentDomainName')]"
                                  },
                                  {
                                    "name": "rootDomainNetBIOSName",
                                    "value": "[parameters('rootDomainNetBIOSName')]"
                                  },
                                  {
                                    "name": "rootDomainControllerFQDN",
                                    "value": "[parameters('rootDomainControllerFQDN')]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#1')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'ConfigureRootDC')]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-07-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'setupConfigurationFiles')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "parameters": [
                                  {
                                    "name": "targetFiles",
                                    "value": "module"
                                  }
                                ],
                                "source": {
                                  "script": "[replace(variables('$fxv#2'), '__MODULE_CONTENT_PLACEHOLDER__', variables('$fxv#3'))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'ConfigureRootDC')]"
                              ]
                            }
                          ],
                          "outputs": {
                            "debugIsRoot": {
                              "type": "bool",
                              "value": "[parameters('isRoot')]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "vnet10",
                "vnet172",
                "vnet192"
              ]
            },
            "generatedSubDCModules": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "GeneratedSubDCModules",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "windowsVmSize": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "vmDiskType": {
                    "value": "[parameters('vmDiskType')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "domainAndEnterpriseAdminUsername": {
                    "value": "[variables('domainAndEnterpriseAdminUsername')]"
                  },
                  "enterpriseAdminUsername": {
                    "value": "[parameters('enterpriseAdminUsername')]"
                  },
                  "enterpriseAdminPassword": {
                    "value": "[parameters('enterpriseAdminPassword')]"
                  },
                  "deployOrBuild": {
                    "value": "[parameters('deployOrBuild')]"
                  },
                  "rootDomainControllerFQDN": {
                    "value": "[parameters('rootDomainControllerFQDN')]"
                  },
                  "rootDomainControllers": {
                    "value": "[parameters('rootDomainControllers')]"
                  },
                  "jumpboxPrivateIPAddress": {
                    "value": "[parameters('jumpboxPrivateIPAddress')]"
                  },
                  "connectedPrivateIPAddress": {
                    "value": "[parameters('connectedPrivateIPAddress')]"
                  },
                  "isVNet10Required": {
                    "value": "[variables('isVNet10Required')]"
                  },
                  "isVNet172Required": {
                    "value": "[variables('isVNet172Required')]"
                  },
                  "isVNet192Required": {
                    "value": "[variables('isVNet192Required')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "14816379723210790884"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "windowsVmSize": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vmDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainAndEnterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "deployOrBuild": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainNetBIOSName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllerFQDN": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "subDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "callerIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainControllerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "jumpboxPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "connectedPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "isVNet10Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet192Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet172Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "kaliSku": {
                      "type": "string",
                      "defaultValue": "kali-2025-2"
                    },
                    "hasPublicIP": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "resources": []
                }
              },
              "dependsOn": [
                "generatedRootDCModules"
              ]
            },
            "postDCSetup": {
              "condition": "[greater(length(parameters('rootDomainControllers')), 0)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "PostDCSetup",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "domainControllers": {
                    "value": "[variables('allDomainControllers')]"
                  },
                  "enterpriseAdminUsername": {
                    "value": "[parameters('enterpriseAdminUsername')]"
                  },
                  "domainName": {
                    "value": "[join(skip(split(parameters('rootDomainControllerFQDN'), '.'), 1), '.')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "5045382374970348641"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "domainControllers": {
                      "type": "array"
                    },
                    "enterpriseAdminUsername": {
                      "type": "string"
                    },
                    "domainName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "setEnterpriseAdminUPN",
                        "count": "[length(parameters('domainControllers'))]"
                      },
                      "condition": "[parameters('domainControllers')[copyIndex()].isRoot]",
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/SetEnterpriseAdminUPN', parameters('domainControllers')[copyIndex()].name)]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "enterpriseAdminUsername",
                            "value": "[parameters('enterpriseAdminUsername')]"
                          },
                          {
                            "name": "domainName",
                            "value": "[parameters('domainName')]"
                          }
                        ],
                        "source": {
                          "script": "        param(\n          [string]$enterpriseAdminUsername,\n          [string]$domainName\n        )\n\n        $logFilePath = \"C:\\Temp\\logfile.txt\"\n        Add-Content -Path $logFilePath -Value \"PostDCSetup: Setting enterprise admin UPN...\"\n\n        try {\n          # Extract username from domain\\username or username@domain format\n          $username = $enterpriseAdminUsername\n          if ($username -like \"*\\*\") {\n            $username = $username.Split('\\')[1]\n          } elseif ($username -like \"*@*\") {\n            $username = $username.Split('@')[0]\n          }\n\n          $upn = \"$username@$domainName\"\n          Set-ADUser $username -UserPrincipalName $upn\n          Add-Content -Path $logFilePath -Value \"PostDCSetup: Successfully set UPN for $username to $upn\"\n        } catch {\n          Add-Content -Path $logFilePath -Value \"PostDCSetup: Failed to set UPN: $_\"\n        }\n      "
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "generatedRootDCModules"
              ]
            },
            "generatedCAModules": {
              "condition": "[greater(length(parameters('certificateAuthorities')), 0)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "GeneratedCAModules",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "windowsVmSize": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "vmDiskType": {
                    "value": "[parameters('vmDiskType')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "domainAndEnterpriseAdminUsername": {
                    "value": "[variables('domainAndEnterpriseAdminUsername')]"
                  },
                  "enterpriseAdminUsername": {
                    "value": "[parameters('enterpriseAdminUsername')]"
                  },
                  "enterpriseAdminPassword": {
                    "value": "[parameters('enterpriseAdminPassword')]"
                  },
                  "deployOrBuild": {
                    "value": "[parameters('deployOrBuild')]"
                  },
                  "jumpboxPrivateIPAddress": {
                    "value": "[parameters('jumpboxPrivateIPAddress')]"
                  },
                  "connectedPrivateIPAddress": {
                    "value": "[parameters('connectedPrivateIPAddress')]"
                  },
                  "isVNet10Required": {
                    "value": "[variables('isVNet10Required')]"
                  },
                  "isVNet172Required": {
                    "value": "[variables('isVNet172Required')]"
                  },
                  "isVNet192Required": {
                    "value": "[variables('isVNet192Required')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "14297970310298147889"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "windowsVmSize": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vmDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainAndEnterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "deployOrBuild": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainNetBIOSName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllerFQDN": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "subDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "callerIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainControllerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "jumpboxPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "connectedPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "isVNet10Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet192Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet172Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "kaliSku": {
                      "type": "string",
                      "defaultValue": "kali-2025-2"
                    },
                    "hasPublicIP": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "CA_0",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "virtualMachineSize": {
                            "value": "[parameters('windowsVmSize')]"
                          },
                          "virtualMachineHostname": {
                            "value": "CA01"
                          },
                          "resourceGroupName": {
                            "value": "[parameters('resourceGroupName')]"
                          },
                          "osDiskType": {
                            "value": "[parameters('vmDiskType')]"
                          },
                          "privateIPAddress": {
                            "value": "172.16.0.7"
                          },
                          "rootDomainControllerPrivateIp": {
                            "value": "172.16.0.5"
                          },
                          "domainName": {
                            "value": "build.lab"
                          },
                          "domainAndEnterpriseAdminUsername": {
                            "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                          },
                          "enterpriseAdminUsername": {
                            "value": "[parameters('enterpriseAdminUsername')]"
                          },
                          "enterpriseAdminPassword": {
                            "value": "[parameters('enterpriseAdminPassword')]"
                          },
                          "localAdminUsername": {
                            "value": "[parameters('enterpriseAdminUsername')]"
                          },
                          "localAdminPassword": {
                            "value": "[parameters('enterpriseAdminPassword')]"
                          },
                          "deployOrBuild": {
                            "value": "[parameters('deployOrBuild')]"
                          },
                          "oldScenarios": {
                            "value": "[parameters('oldScenarios')]"
                          },
                          "jumpboxPrivateIPAddress": {
                            "value": "[parameters('jumpboxPrivateIPAddress')]"
                          },
                          "connectedPrivateIPAddress": {
                            "value": "[parameters('connectedPrivateIPAddress')]"
                          },
                          "isVNet10Required": {
                            "value": "[parameters('isVNet10Required')]"
                          },
                          "isVNet172Required": {
                            "value": "[parameters('isVNet172Required')]"
                          },
                          "isVNet192Required": {
                            "value": "[parameters('isVNet192Required')]"
                          },
                          "hasPublicIP": {
                            "value": false
                          },
                          "callerIPAddress": {
                            "value": "35.139.98.68"
                          },
                          "skipPeering": {
                            "value": false
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.24.24.22086",
                              "templateHash": "5356460969800015917"
                            }
                          },
                          "parameters": {
                            "virtualMachineSize": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "deployOrBuild": {
                              "type": "string"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "privateIPAddress": {
                              "type": "string"
                            },
                            "rootDomainControllerPrivateIp": {
                              "type": "string"
                            },
                            "virtualMachineHostname": {
                              "type": "string"
                            },
                            "imageReference": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "osDiskType": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "localAdminUsername": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "localAdminPassword": {
                              "type": "securestring",
                              "defaultValue": ""
                            },
                            "enterpriseAdminUsername": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "enterpriseAdminPassword": {
                              "type": "securestring",
                              "defaultValue": ""
                            },
                            "domainName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "domainAndEnterpriseAdminUsername": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "oldScenarios": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "jumpboxPrivateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "connectedPrivateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "isVNet10Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "isVNet172Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "isVNet192Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "hasPublicIP": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "callerIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "skipPeering": {
                              "type": "bool",
                              "defaultValue": false
                            }
                          },
                          "variables": {
                            "$fxv#0": "\r\nparam(\r\n    [string]$targetFiles,\r\n    [string]$domainName\r\n)\r\n\r\n$logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n$domainDN = ($domainName -split '\\.' | ForEach-Object { \"DC=$_\" }) -join ','\r\nAdd-Content -Path $logFilePath -Value \"Domain DN: $domainDN\"\r\n\r\n$targetFilesArray = $targetFiles -split \",\"\r\n\r\nforeach ($file in $targetFilesArray)\r\n{\r\n    switch ($file)\r\n    {\r\n        'module'\r\n        {\r\n            Install-WindowsFeature -Name RSAT-AD-PowerShell\r\n            $localFilePath = \"C:\\Temp\\ADVulnEnvModule\"\r\n            $fileName = \"C:\\Temp\\ADVulnEnvModule\\ADVulnEnvModule.psm1\"\r\n\r\n            # Create directory if it doesn't exist\r\n            New-Item -ItemType Directory -Path $localFilePath -Force | Out-Null\r\n\r\n            Add-Content -Path $logFilePath -Value \"=== EMBEDDED SETUP STARTED ===\"\r\n            Add-Content -Path $logFilePath -Value \"Writing embedded module content to $fileName\"\r\n\r\n            # Module content embedded directly in script (will be replaced by bicep)\r\n            $moduleContent = @'\r\n__MODULE_CONTENT_PLACEHOLDER__\r\n'@\r\n\r\n            Add-Content -Path $logFilePath -Value \"Module content size: $($moduleContent.Length) characters\"\r\n\r\n            # Write the embedded module content to file\r\n            try {\r\n                [System.IO.File]::WriteAllText($fileName, $moduleContent, [System.Text.Encoding]::UTF8)\r\n                Add-Content -Path $logFilePath -Value \"Module content written to $fileName\"\r\n\r\n                # Verify file was created\r\n                if (Test-Path $fileName) {\r\n                    $fileSize = (Get-Item $fileName).Length\r\n                    Add-Content -Path $logFilePath -Value \"Module file verified: $fileSize bytes\"\r\n                } else {\r\n                    Add-Content -Path $logFilePath -Value \"ERROR: Module file was not created at $fileName\"\r\n                }\r\n            }\r\n            catch {\r\n                Add-Content -Path $logFilePath -Value \"ERROR writing module file: $_\"\r\n                Add-Content -Path $logFilePath -Value \"Exception type: $($_.Exception.GetType().FullName)\"\r\n                Add-Content -Path $logFilePath -Value \"Exception message: $($_.Exception.Message)\"\r\n            }\r\n        }\r\n        'esc'\r\n        {\r\n            # Create ADCS files directory\r\n            $adcsPath = \"C:\\Temp\\adcs-files\"\r\n            New-Item -ItemType Directory -Path $adcsPath -Force | Out-Null\r\n            Add-Content -Path $logFilePath -Value \"=== ESC FILES SETUP STARTED ===\"\r\n\r\n            # ESC file contents embedded directly in script (will be replaced by bicep)\r\n            $esc1Vuln = @'\r\n__ESC1_VULN_PLACEHOLDER__\r\n'@\r\n            $esc1VulnSecurityDescriptor = @'\r\n__ESC1_VULN_SD_PLACEHOLDER__\r\n'@\r\n            $esc3VulnAuthSignatures = @'\r\n__ESC3_AUTH_SIG_PLACEHOLDER__\r\n'@\r\n            $esc3VulnRequestAgentSecurityDescriptor = @'\r\n__ESC3_REQ_AGENT_SD_PLACEHOLDER__\r\n'@\r\n            $esc4VulnWrite = @'\r\n__ESC4_VULN_PLACEHOLDER__\r\n'@\r\n            $esc3VulnRequestAgent = @'\r\n__ESC3_REQ_AGENT_PLACEHOLDER__\r\n'@\r\n            $esc3VulnAuthSignaturesSecurityDescriptor = @'\r\n__ESC3_AUTH_SIG_SD_PLACEHOLDER__\r\n'@\r\n            $esc4VulnWriteSecurityDescriptor = @'\r\n__ESC4_VULN_SD_PLACEHOLDER__\r\n'@\r\n\r\n            # Replace hardcoded domain with actual domain DN\r\n            $esc1Vuln = $esc1Vuln -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc1VulnSecurityDescriptor = $esc1VulnSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnAuthSignatures = $esc3VulnAuthSignatures -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnRequestAgentSecurityDescriptor = $esc3VulnRequestAgentSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc4VulnWrite = $esc4VulnWrite -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnRequestAgent = $esc3VulnRequestAgent -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnAuthSignaturesSecurityDescriptor = $esc3VulnAuthSignaturesSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc4VulnWriteSecurityDescriptor = $esc4VulnWriteSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n\r\n            Add-Content -Path $logFilePath -Value \"Replaced hardcoded domain with $domainDN in all ESC templates\"\r\n\r\n            # Write each ESC .ldf file from embedded content\r\n            $esc1Vuln | Set-Content -Path \"$adcsPath\\ESC1Vuln.ldf\" -Force\r\n            $esc1VulnSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC1VulnSecurityDescriptor.ldf\" -Force\r\n            $esc3VulnAuthSignatures | Set-Content -Path \"$adcsPath\\ESC3VulnAuthSignatures.ldf\" -Force\r\n            $esc3VulnRequestAgentSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC3VulnRequestAgentSecurityDescriptor.ldf\" -Force\r\n            $esc4VulnWrite | Set-Content -Path \"$adcsPath\\ESC4VulnWrite.ldf\" -Force\r\n            $esc3VulnRequestAgent | Set-Content -Path \"$adcsPath\\ESC3VulnRequestAgent.ldf\" -Force\r\n            $esc3VulnAuthSignaturesSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC3VulnAuthSignaturesSecurityDescriptor.ldf\" -Force\r\n            $esc4VulnWriteSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC4VulnWriteSecurityDescriptor.ldf\" -Force\r\n\r\n            Add-Content -Path $logFilePath -Value \"Successfully wrote 8 ADCS template files to $adcsPath\"\r\n        }\r\n        Default\r\n        {\r\n            Add-Content -Path $logFilePath -Value \"Error: Unknown target file type '$file'\"\r\n        }\r\n    }\r\n}\r\n",
                            "$fxv#1": "<# =============================\r\n          Creation Functions\r\n    ============================#>\r\n\r\n\r\nFunction GenerateUsers {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Define an array of 25 names\r\n    $userNames = @(\"User1\", \"User2\", \"User3\", \"User4\", \"User5\",\r\n                   \"User6\", \"User7\", \"User8\", \"User9\", \"User10\",\r\n                   \"User11\", \"User12\", \"User13\", \"User14\", \"User15\",\r\n                   \"User16\", \"User17\", \"User18\", \"User19\", \"User20\",\r\n                   \"User21\", \"User22\", \"User23\", \"User24\", \"EntryUser\")\r\n\r\n    # Loop through each name and create a user\r\n    foreach ($name in $userNames) {\r\n        try {\r\n            Add-Type -AssemblyName System.Web\r\n    \r\n            # Assign specific simple passwords for User8(Kerberoast User) and EntryUser\r\n            if ($name -eq \"User8\") {\r\n                $password = \"Password123\"\r\n            } elseif ($name -eq \"EntryUser\" -or $name -eq \"User2\") { # Assign simple passwords for entryuser(user to login with and user2 for responder attack)\r\n                $password = \"Password#1\"\r\n            } else {\r\n                # Generate a random password for other users\r\n                $password = [System.Web.Security.Membership]::GeneratePassword(25, 1)\r\n            }\r\n    \r\n            $description = 'Inspired by secframe.com/badblood.'\r\n            $upn = \"$name@$domainName\"\r\n    \r\n            # Create the user with New-ADUser using the provided credentials\r\n            New-ADUser -Name $name -SamAccountName $name -Surname $name -Enabled $true -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n    \r\n            # Add successful execution in logs\r\n            $successMessage = \"GenerateUsers Function: Successfully created user: $name\"\r\n            Add-Content -Path $logFilePath -Value $successMessage\r\n            Write-Output $successMessage\r\n\r\n            # Add EntryUser and User2 to rdp group (entryuser to be utilize to rdp into domain and User2 used to similate traffic for responder attack)\r\n            if ($name -eq \"EntryUser\") {\r\n                # Add to domain Remote Desktop Users group (DCs don't have local groups)\r\n                Add-ADGroupMember -Identity \"Remote Desktop Users\" -Members $name -Credential $DomainAdminCreds\r\n                $rdpMessage = \"GenerateUsers Function: Added $name to Remote Desktop Users domain group\"\r\n                Add-Content -Path $logFilePath -Value $rdpMessage\r\n                Write-Output $rdpMessage\r\n            }\r\n        } catch {\r\n            # Add failed execution in logs\r\n            Add-Content -Path $logFilePath -Value \"GenerateUsers Function: Error in running function and creating user $name : $_ \"\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\nFunction GenerateRandomUsers {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [int]$numberOfUsers,\r\n        [string]$usernameFormat = \"firstname\"  # Options: \"firstname\", \"firstname.lastname\", \"firstinitial.lastname\"\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    # Log the received parameters for debugging\r\n    Add-Content -Path $logFilePath -Value \"GenerateRandomUsers Function: Received usernameFormat parameter: '$usernameFormat'\"\r\n\r\n    # Read first names from the file\r\n    $fileURL = \"https://raw.githubusercontent.com/davidprowe/BadBlood/master/AD_Users_Create/Names/names.txt\"\r\n    $namesFilePath = \"C:\\temp\\names.txt\"\r\n    Invoke-WebRequest -Uri $fileURL -OutFile $namesFilePath\r\n    if (-Not (Test-Path $namesFilePath)) {\r\n        Write-Error \"Names file not found at $namesFilePath\"\r\n        return\r\n    }\r\n\r\n    $allFirstNames = Get-Content $namesFilePath\r\n\r\n    # Read last names from the file (if needed for format)\r\n    $allLastNames = @()\r\n    if ($usernameFormat -ne \"firstname\") {\r\n        $lastNamesURL = \"https://raw.githubusercontent.com/your-repo/lastnames.txt\"\r\n        $lastNamesFilePath = \"C:\\temp\\lastnames.txt\"\r\n        \r\n        # For now, use a predefined list of common last names\r\n        $allLastNames = @(\r\n            \"smith\", \"johnson\", \"williams\", \"brown\", \"jones\", \"garcia\", \"miller\", \"davis\", \r\n            \"rodriguez\", \"martinez\", \"hernandez\", \"lopez\", \"gonzalez\", \"wilson\", \"anderson\", \r\n            \"thomas\", \"taylor\", \"moore\", \"jackson\", \"martin\", \"lee\", \"perez\", \"thompson\", \r\n            \"white\", \"harris\", \"sanchez\", \"clark\", \"ramirez\", \"lewis\", \"robinson\", \"walker\",\r\n            \"young\", \"allen\", \"king\", \"wright\", \"scott\", \"torres\", \"nguyen\", \"hill\", \"flores\",\r\n            \"green\", \"adams\", \"nelson\", \"baker\", \"hall\", \"rivera\", \"campbell\", \"mitchell\",\r\n            \"carter\", \"roberts\", \"gomez\", \"phillips\", \"evans\", \"turner\", \"diaz\", \"parker\",\r\n            \"cruz\", \"edwards\", \"collins\", \"reyes\", \"stewart\", \"morris\", \"morales\", \"murphy\",\r\n            \"cook\", \"rogers\", \"gutierrez\", \"ortiz\", \"morgan\", \"cooper\", \"peterson\", \"bailey\",\r\n            \"reed\", \"kelly\", \"howard\", \"ramos\", \"kim\", \"cox\", \"ward\", \"richardson\", \"watson\",\r\n            \"brooks\", \"chavez\", \"wood\", \"james\", \"bennett\", \"gray\", \"mendoza\", \"ruiz\", \"hughes\",\r\n            \"price\", \"alvarez\", \"castillo\", \"sanders\", \"patel\", \"myers\", \"long\", \"ross\", \"foster\"\r\n        )\r\n    }\r\n\r\n    # Generate usernames based on format\r\n    $generatedUsernames = @()\r\n    for ($i = 0; $i -lt $numberOfUsers; $i++) {\r\n        $firstName = (Get-Random -InputObject $allFirstNames).ToLower()\r\n        \r\n        switch ($usernameFormat) {\r\n            \"firstname\" {\r\n                $username = $firstName\r\n            }\r\n            \"firstname.lastname\" {\r\n                $lastName = (Get-Random -InputObject $allLastNames).ToLower()\r\n                $username = \"$firstName.$lastName\"\r\n            }\r\n            \"firstinitial.lastname\" {\r\n                $lastName = (Get-Random -InputObject $allLastNames).ToLower()\r\n                $firstInitial = $firstName.Substring(0, 1).ToLower()\r\n                $username = \"$firstInitial$lastName\"\r\n            }\r\n            default {\r\n                $username = $firstName\r\n            }\r\n        }\r\n        \r\n        # Ensure username is unique in this batch\r\n        $counter = 1\r\n        $originalUsername = $username\r\n        while ($generatedUsernames -contains $username) {\r\n            $username = \"$originalUsername$counter\"\r\n            $counter++\r\n        }\r\n        \r\n        $generatedUsernames += $username\r\n    }\r\n\r\n    # Loop through each generated username and create a user\r\n    foreach ($username in $generatedUsernames) {\r\n        try {\r\n            Add-Type -AssemblyName System.Web\r\n\r\n            # Generate a random password for the user\r\n            $password = [System.Web.Security.Membership]::GeneratePassword(25, 1)\r\n\r\n            $description = 'Inspired by secframe.com/badblood.'\r\n            $upn = \"$username@$domainName\"\r\n            \r\n            # Use the username as both the display name and SAM account name\r\n            $displayName = $username\r\n\r\n            # Create the user with New-ADUser using the provided credentials\r\n            New-ADUser -Name $displayName -SamAccountName $username -Surname $username -Enabled $true -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n\r\n            # Add successful execution in logs\r\n            $successMessage = \"GenerateRandomUsers Function: Successfully created user: $username\"\r\n            Add-Content -Path $logFilePath -Value $successMessage\r\n            Write-Output $successMessage\r\n        } catch {\r\n            # Add failed execution in logs\r\n            Add-Content -Path $logFilePath -Value \"GenerateRandomUsers Function: Error in running function and creating user $username : $_ \"\r\n        }\r\n    }\r\n}\r\nFunction CreateSingleUser {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$singleUsername,\r\n        [string]$singleUserPassword\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    $description = 'Single User Creation'\r\n    $upn = \"$singleUsername@$domainName\"\r\n    \r\n    try {\r\n        # Create the user with New-ADUser using the provided credentials\r\n        New-ADUser -Name $singleUsername -SamAccountName $singleUsername -Surname $singleUsername -Enabled $true -AccountPassword (ConvertTo-SecureString $singleUserPassword -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n\r\n        # Add successful execution in logs\r\n        $successMessage = \"CreateSingleUser Function: Successfully created user: $singleUsername\"\r\n        Add-Content -Path $logFilePath -Value $successMessage\r\n        Write-Output $successMessage\r\n\r\n    }\r\n    catch {\r\n        # Add failed execution in logs\r\n        Add-Content -Path $logFilePath -Value \"CreateSingleUser Function: Error in running function and creating user $singleUsername : $_ \"\r\n    }\r\n    \r\n}\r\n\r\nFunction ConfigureUserToRDP {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$targetUser\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    try {\r\n        Add-Type -AssemblyName System.Web\r\n\r\n\r\n        Add-ADGroupMember -Identity \"Remote Desktop Users\" -Members $targetUser -Credential $DomainAdminCreds\r\n        Add-LocalGroupMember -Group \"Remote Desktop Users\" -Member $targetUser \r\n        Add-Content -Path $logFilePath -Value \"ConfigureUserToRDP Function: Added $targetUser to Remote Desktop Users group\"\r\n        \r\n    } catch {\r\n        # Add failed execution in logs\r\n        Add-Content -Path $logFilePath -Value \"ConfigureUserToRDP Function: Error in running function $targetUser : $_ \"\r\n    }\r\n}\r\n\r\nFunction CreateAndOrganizeOUs {\r\n    param (\r\n        [string]$OU1Name,\r\n        [string]$OU2Name,\r\n        [int]$NumberOfUsersInOU1,\r\n        [pscredential]$DomainAdminCreds\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Create the first OU\r\n        New-ADOrganizationalUnit -Name $OU1Name -Credential $DomainAdminCreds\r\n        Add-Content -Path $logFilePath -Value \"Created OU: $OU1Name\"\r\n\r\n        # Create the second OU\r\n        New-ADOrganizationalUnit -Name $OU2Name -Credential $DomainAdminCreds\r\n        Add-Content -Path $logFilePath -Value \"Created OU: $OU2Name\"\r\n\r\n        # Move users to the first OU\r\n        $users = Get-ADUser -Filter * -SearchBase \"CN=Users,DC=redteam,DC=lab\" | Select-Object -First $NumberOfUsersInOU1\r\n        foreach ($user in $users) {\r\n            Move-ADObject -Identity $user.DistinguishedName -TargetPath \"OU=$OU1Name,DC=redteam,DC=lab\"\r\n            Add-Content -Path $logFilePath -Value \"Moved user $($user.Name) to OU: $OU1Name\"\r\n        }\r\n\r\n        # Move the remaining users to the second OU\r\n        $remainingUsers = Get-ADUser -Filter * -SearchBase \"CN=Users,DC=redteam,DC=lab\" \r\n        foreach ($user in $remainingUsers) {\r\n            Move-ADObject -Identity $user.DistinguishedName -TargetPath \"OU=$OU2Name,DC=redteam,DC=lab\"\r\n            Add-Content -Path $logFilePath -Value \"Moved user $($user.Name) to OU: $OU2Name\"\r\n        }\r\n\r\n    } catch {\r\n        Add-Content -Path $logFilePath -Value \"Error in CreateAndOrganizeOUs: $_ \"\r\n    }\r\n}\r\n\r\nFunction CreateComputerObjects {\r\n    param (\r\n        [string]$TargetOU, # Optional: OU to place the computer objects\r\n        [pscredential]$DomainAdminCreds\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Predefined list of computer names\r\n    $ComputerNames = @(\"Computer1\", \"Computer2\", \"Computer3\", \"Computer4\", \"Computer5\")\r\n\r\n    foreach ($name in $ComputerNames) {\r\n        try {\r\n            $params = @{\r\n                Name = $name\r\n                Credential = $DomainAdminCreds\r\n                Path = if ($TargetOU) { \"OU=$TargetOU,DC=redteam,DC=lab\" } else { \"CN=Computers,DC=redteam,DC=lab\" }\r\n            }\r\n\r\n            # Create the computer object\r\n            New-ADComputer @params\r\n\r\n            # Log success\r\n            Add-Content -Path $logFilePath -Value \"CreateComputerObjects: Successfully created computer object: $name\"\r\n        } catch {\r\n            # Log any errors\r\n            Add-Content -Path $logFilePath -Value \"CreateComputerObjects: Error creating computer object $name : $_ \"\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n<# =================================\r\n        Attack Vector Functions\r\n    ================================#>\r\n\r\nFunction Import-VulnerableCertificateTemplate {\r\n    param (\r\n        [string]$domainAdminUsername,\r\n        [string]$domainAdminPassword,\r\n        [string]$domainName,\r\n        [string]$templateName\r\n    )\r\n    $logLocation = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n        ldifde -i -k -f \"C:\\Temp\\adcs-files\\$templateName.ldf\" -b $domainAdminUsername $domainName $domainAdminPassword\r\n        ldifde -i -k -f $(\"C:\\Temp\\adcs-files\\\" + $templateName + \"SecurityDescriptor.ldf\") -b $domainAdminUsername $domainName $domainAdminPassword\r\n\r\n        # For ESC4, grant Domain Users WriteProperty and Enroll permissions\r\n        if ($templateName -eq \"ESC4VulnWrite\") {\r\n            Add-Content -Path $logLocation -Value \"Setting ESC4VulnWrite ACL for Domain Users...\"\r\n            $domain = (Get-ADDomain).NetBIOSName\r\n            $templateDN = \"CN=$templateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=$($domainName.Replace('.', ',DC='))\"\r\n\r\n            # Grant Write Property permission (to modify template attributes)\r\n            $result1 = dsacls $templateDN /G \"${domain}\\Domain Users:RPWP\" 2>&1\r\n            Add-Content -Path $logLocation -Value \"dsacls WriteProperty result: $result1\"\r\n\r\n            # Grant enrollment extended right (GUID 0e10c968-78fb-11d2-90d4-00c04f79dc55)\r\n            $result2 = dsacls $templateDN /G \"${domain}\\Domain Users:CA;0e10c968-78fb-11d2-90d4-00c04f79dc55\" 2>&1\r\n            Add-Content -Path $logLocation -Value \"dsacls Enrollment result: $result2\"\r\n\r\n            Add-Content -Path $logLocation -Value \"ESC4VulnWrite ACL updated successfully\"\r\n        }\r\n\r\n        Restart-Service -Name certsvc -Force\r\n    } catch {\r\n        Add-Content -Path $logLocation -Value \"Error Enabling $templateName : $_ \"\r\n    }\r\n}\r\n\r\nFunction Disable-PreAuth {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Use the credentials for AD operations\r\n        Set-ADAccountControl -Credential $domainAdminCreds -Identity $targetUser -DoesNotRequirePreAuth:$true\r\n\r\n        # Add successfull execution in logs\r\n        Add-Content -Path $logFilePath -Value \"DisablePreAuth Function: Successfully disabled preauth for $targetUser\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"DisablePreAuth Function: Error running Disable-PreAuth: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-User-for-Kerberoast {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Generate unique SPN per user by including username in hostname\r\n        $uniqueSpn = \"MSSQLSvc/sql-$targetUser.$domainName:1433\"\r\n\r\n        # Use the credentials for AD operations\r\n        Set-ADUser -Credential $domainAdminCreds -Identity $targetUser -ServicePrincipalNames @{Add=$uniqueSpn}\r\n\r\n        # Add successfull execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Kerberoast Function: Made $targetUser be kerberoasted with SPN $uniqueSpn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Kerberoast Function: Error running Update-User-for-Kerberoast: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-User-for-Constrained-Delegation {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$userForCDelegation,\r\n        [string]$dcName,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Set the SPN for the DC\r\n        $spn = \"HTTP/$dcName.$domainName\"\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $dcName -ServicePrincipalNames @{ADD=$spn}\r\n        # Use the credentials for AD operations\r\n        Get-ADUser -Credential $domainAdminCreds -Identity $userForCDelegation | Set-ADAccountControl -TrustedToAuthForDelegation $true\r\n        Set-ADUser -Credential $domainAdminCreds -Identity $userForCDelegation -Add @{'msDS-AllowedToDelegateTo'=@($spn)}\r\n        \r\n        # Add successful execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Constrained-Delegation Function: Configured $userForCDelegation for constrained delegation with SPN $spn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Constrained-Delegation Function: Error running Update-User-for-Constrained-Delegation: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-Computer-for-Constrained-Delegation {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$computerForCDelegation,\r\n        [string]$dcName,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n        # Set the SPN for the DC\r\n        $spn = \"HTTP/$dcName.$domainName\"\r\n        #Add spn onto DC\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $dcName -ServicePrincipalNames @{ADD=$spn}\r\n        # set target computer to be able to delegate\r\n        Get-ADComputer -Credential $domainAdminCreds -Identity $computerForCDelegation | Set-ADAccountControl -TrustedToAuthForDelegation $true\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $computerForCDelegation -Add @{'msDS-AllowedToDelegateTo'=@($spn)}\r\n        \r\n        # Add successful execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-Computer-for-Constrained-Delegation Function: Configured $computerForCDelegation for constrained delegation with SPN $spn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-Computer-for-Constrained-Delegation Function: Error running Update-Computer-for-Constrained-Delegation: $_ \"\r\n    }\r\n}\r\n\r\n\r\nFunction Set-ADUserPermissions {\r\n    param (\r\n        [string]$GrantingUser,\r\n        [string]$ReceivingUser,\r\n        [string]$PermissionType\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    try {\r\n        # Get the AD user object for the receiving user\r\n        $user = Get-ADUser -Identity $ReceivingUser\r\n\r\n        # Define the type of access right based on the PermissionType string\r\n        $accessRight = @{\r\n            \"GenericAll\" = [System.DirectoryServices.ActiveDirectoryRights]::GenericAll\r\n            \"GenericWrite\" = [System.DirectoryServices.ActiveDirectoryRights]::WriteProperty\r\n        }\r\n\r\n        # Create an Access Control Entry (ACE)\r\n        $ace = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(\r\n            (New-Object System.Security.Principal.NTAccount($GrantingUser)),\r\n            $accessRight[$PermissionType],\r\n            'Allow'\r\n        )\r\n\r\n        # Get the current ACL for the user\r\n        $acl = Get-Acl \"AD:$($user.DistinguishedName)\"\r\n\r\n        # Add the new ACE to the ACL\r\n        $acl.AddAccessRule($ace)\r\n\r\n        # Set the new ACL on the user object\r\n        Set-Acl \"AD:$($user.DistinguishedName)\" $acl\r\n\r\n        # Log success\r\n        Add-Content -Path $logFilePath -Value \"Set-ADUserPermissions: Successfully set $PermissionType permission for $GrantingUser on $ReceivingUser\"\r\n    } catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Set-ADUserPermissions: Error setting permissions for $GrantingUser on $ReceivingUser : $_ \"\r\n    }\r\n}\r\n\r\nFunction SimulateUserTrafficAsUser2 {\r\n    param (\r\n        [string]$BogusSharePath,\r\n        [int]$IntervalSeconds\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # User2's credentials\r\n    $user2Username = \"redteam.lab\\User2\"\r\n    $user2Password = ConvertTo-SecureString \"Password#1\" -AsPlainText -Force\r\n    $user2Creds = New-Object System.Management.Automation.PSCredential ($user2Username, $user2Password)\r\n\r\n    # Script block to simulate traffic\r\n    $scriptBlock = {\r\n        param($BogusSharePath, $logFilePath, $IntervalSeconds)\r\n        while ($true) {\r\n            try {\r\n                # Attempt to access the bogus file share\r\n                & cmd.exe /c dir $BogusSharePath\r\n\r\n                # Log the attempt\r\n                Add-Content -Path $logFilePath -Value \"SimulateUserTraffic: Attempted to access $BogusSharePath\"\r\n            } catch {\r\n                # Log any errors from the attempt\r\n                Add-Content -Path $logFilePath -Value \"SimulateUserTraffic: Error accessing $BogusSharePath : $_ \"\r\n            }\r\n\r\n            # Wait for the specified interval\r\n            Start-Sleep -Seconds $IntervalSeconds\r\n        }\r\n    }\r\n\r\n    # Start the script block as a background job\r\n    Start-Job -ScriptBlock $scriptBlock -ArgumentList $BogusSharePath, $logFilePath, $IntervalSeconds -Credential $user2Creds\r\n}\r\n\r\nFunction Set-LocalPrivEsc-BinPathWriteAccess {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    # Specify the service you're targeting\r\n    $service = \"wuauserv\"\r\n    $domainUser = \"$domainName\\$targetUser\"\r\n    # File for acl updates\r\n    $downloadUrl =  \"http://web.archive.org/web/20190910062448if_/http://download.microsoft.com/download/1/7/d/17d82b72-bc6a-4dc8-bfaa-98b37b22b367/subinacl.msi\"\r\n    $localPath = \"C:\\Temp\\subinacl.msi\"  \r\n    try {\r\n        # Download subinacl.msi\r\n        Invoke-WebRequest -Uri $downloadUrl -OutFile $localPath  \r\n        # Install it silently to prevent gui\r\n        Start-Process \"msiexec.exe\" -ArgumentList \"/i $localPath /qn /norestart\" -NoNewWindow -Wait  \r\n        $subinaclPath = \"C:\\Program Files (x86)\\Windows Resource Kits\\Tools\\subinacl.exe\"  \r\n        # Grant targetuser full permissions on bin\r\n        & $subinaclPath /service $service /grant=$domainUser=F\r\n        # Log success\r\n        Add-Content -Path $logFilePath -Value \"Grant-ServiceBinPathWriteAccess: Successfully granted write access to binPath of $service for $targetUser.\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Grant-ServiceBinPathWriteAccess: Error granting write access to binPath of $service for $targetUser : $_\"\r\n    }\r\n}\r\n\r\n\r\nFunction Set-UnquotedServicePathVulnerability {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$vulnerablePath = \"C:\\Program Files\\My Vulnerable App\"\r\n    )\r\n\r\n    # Define the benign executable and service details\r\n    $benignExecutable = \"C:\\Windows\\System32\\notepad.exe\" # Example benign executable\r\n    $serviceName = \"BenignService\"\r\n    $serviceDisplayName = \"Benign Service\"\r\n    $servicePath = \"$vulnerablePath\\service.exe\" # Construct the service path with spaces\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\unquotedServicePathVulnerabilityLog.txt\"\r\n\r\n    try {\r\n        # Ensure the vulnerable directory path exists\r\n        New-Item -ItemType Directory -Path $vulnerablePath -Force\r\n\r\n        # Copy the benign executable to the service path (simulating a service installation)\r\n        Copy-Item -Path $benignExecutable -Destination $servicePath -Force\r\n\r\n        # Create the new service using sc.exe to bypass PowerShell cmdlet limitations on path quoting\r\n        $scArgs = \"create $serviceName binPath= `\"$servicePath`\" DisplayName= `\"$serviceDisplayName`\"\"\r\n        $scCreateResult = Start-Process sc.exe -ArgumentList $scArgs -Wait -PassThru -NoNewWindow\r\n\r\n        # Verify service creation was successful\r\n        if ($scCreateResult.ExitCode -eq 0) {\r\n            Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Service '$serviceName' created successfully.\"\r\n        } else {\r\n            throw \"Failed to create service. Exit Code: $($scCreateResult.ExitCode)\"\r\n        }\r\n\r\n        # Grant write access to the target user for the vulnerable part of the path\r\n        $acl = Get-Acl $vulnerablePath\r\n        $permission = \"$targetUser\",\"Modify\",\"Allow\"\r\n        $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission\r\n        $acl.AddAccessRule($accessRule)\r\n        Set-Acl -Path $vulnerablePath -AclObject $acl\r\n\r\n        Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Granted Modify access to '$targetUser' on '$vulnerablePath'.\"\r\n    }\r\n    catch {\r\n        Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Error encountered: $_ \"\r\n    }\r\n}\r\n\r\n\r\n<#\r\nFunction Set-DomainAdminStoredCreds {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n\r\n    # Generate a simple password for the target user\r\n    $newPassword = \"Password123!\"\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\domainAdminStoredCredsLog.txt\"\r\n\r\n    try {\r\n        # Change the password of the target user\r\n        Set-ADAccountPassword -Identity $targetUser -NewPassword (ConvertTo-SecureString $newPassword -AsPlainText -Force) -Credential $domainAdminCreds\r\n\r\n        # Extract domain admin credentials\r\n        $domainAdminUser = $domainAdminCreds.UserName\r\n        $domainAdminPassword = $domainAdminCreds.GetNetworkCredential().Password\r\n\r\n        # Use cmdkey to add stored credentials\r\n        $targetUserFQDN = \"$domainName\\$targetUser\"\r\n\r\n        Start-Process -FilePath \"cmdkey\" -ArgumentList \"/generic:$targetUserFQDN /user:$targetUserFQDN /pass:$newPassword\" -Credential $adminCreds -NoNewWindow -Wait\r\n\r\n        # Logging the action\r\n        Add-Content -Path $logFilePath -Value \"Set-DomainAdminStoredCreds: Successfully changed password and added stored credentials for '$targetUser'.\"\r\n    }\r\n    catch {\r\n        Add-Content -Path $logFilePath -Value \"Set-DomainAdminStoredCreds: Error encountered: $_ \"\r\n    }\r\n}\r\n#>\r\nFunction Add-CredsForMimikatz {\r\n    param (\r\n        [string]$userForMimikatz,\r\n        [string]$singleUserPassword,\r\n        [string]$domainName,\r\n        [string]$computerForMimikatz\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n       # Need to add user to local admin group in order to be able to psremote in and provide creds.\r\n       #Add-LocalGroupMember -Group \"Administrators\" -Member $userForMimikatz\r\n \r\n       $username = \"$domainName\\$userForMimikatz\"\r\n       $password = ConvertTo-SecureString $singleUserPassword -AsPlainText -Force\r\n       $credential = New-Object System.Management.Automation.PSCredential ($username, $password)\r\n       Invoke-Command -Credential $credential -ComputerName $computerForMimikatz -ScriptBlock {Start-Process powershell.exe}\r\n       Add-Content -Path $logFilePath -Value \"Add-CredsForMimikatz: Configured $userForMimikatz to have hash within the targetbox\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Add-CredsForMimikatz Function: Error running Add-CredsForMimikatz: $_ \"\r\n    }\r\n\r\n\r\n}\r\n\r\n\r\nFunction GenerateRandomCTF {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$dcName,\r\n        [int]$numberOfUsers,\r\n        [string]$targetBox,\r\n        [string]$difficulty\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Generate random users\r\n    GenerateRandomUsers -DomainAdminCreds $DomainAdminCreds -domainName $domainName -numberOfUsers $numberOfUsers\r\n\r\n    # Get all generated users\r\n    $randomUsers = Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName\r\n\r\n    # Assign RDP permissions to a random user\r\n    $entryUser = Get-Random -InputObject $randomUsers\r\n    ConfigureUserToRDP -DomainAdminCreds $DomainAdminCreds -domainName $domainName -targetUser $entryUser\r\n    Set-ADAccountPassword -Identity $entryUser -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n\r\n    # Determine attack count based on difficulty\r\n    $attackCount = switch ($difficulty) {\r\n        \"easy\" { 2 }\r\n        \"medium\" { 3 }\r\n        \"hard\" { 4 }\r\n        default { 2 }\r\n    }\r\n\r\n    # Define all attacks\r\n    $attacks = @(\r\n        \"Disable-PreAuth\", \r\n        \"Update-User-for-Kerberoast\", \r\n        \"Update-User-for-Constrained-Delegation\", \r\n        \"Update-Computer-for-Constrained-Delegation\", \r\n        \"Set-LocalPrivEsc-BinPathWriteAccess\", \r\n        \"Set-UnquotedServicePathVulnerability\", \r\n        \"Add-CredsForMimikatz\"\r\n    )\r\n\r\n    # Select the first attack\r\n    $firstAttackOptions = $attacks | Where-Object { $_ -in @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\", \"Disable-PreAuth\", \"Update-User-for-Kerberoast\") }\r\n    $firstAttack = Get-Random -InputObject $firstAttackOptions\r\n\r\n    # Remove first attack from remaining attacks\r\n    $remainingAttacks = $attacks | Where-Object { $_ -ne $firstAttack }\r\n\r\n    # Ensure the last attack leads to domain admin\r\n    $lastAttackOptions = @(\"Update-User-for-Constrained-Delegation\", \"Update-Computer-for-Constrained-Delegation\", \"Add-CredsForMimikatz\")\r\n    $lastAttack = Get-Random -InputObject $lastAttackOptions\r\n\r\n    # Adjust attack count to ensure it's valid\r\n    $countToSelect = [math]::Max($attackCount - 2, 0)\r\n    if ($countToSelect -gt 0) {\r\n        $selectedAttacks = @($firstAttack) + (Get-Random -InputObject $remainingAttacks -Count $countToSelect) + $lastAttack\r\n    } else {\r\n        $selectedAttacks = @($firstAttack, $lastAttack)\r\n    }\r\n\r\n    # Ensure Mimikatz or Update-Computer-for-Constrained-Delegation follows a priv esc attack and adjust selection if necessary\r\n    if ($selectedAttacks[-1] -in @(\"Add-CredsForMimikatz\", \"Update-Computer-for-Constrained-Delegation\") -and $firstAttack -notin @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\")) {\r\n        $firstAttack = Get-Random -InputObject @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\")\r\n        $selectedAttacks[0] = $firstAttack\r\n    }\r\n\r\n    # Initialize applied attacks array and previous user\r\n    $appliedAttacks = @()\r\n    $previousUser = $null\r\n\r\n    # Process attacks\r\n    foreach ($attack in $selectedAttacks) {\r\n        switch ($attack) {\r\n            \"Disable-PreAuth\" {\r\n                $user = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                Disable-PreAuth -domainAdminCreds $DomainAdminCreds -targetUser $user\r\n                Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                $appliedAttacks += \"Disable-PreAuth\"\r\n                $previousUser = $user\r\n            }\r\n            \"Update-User-for-Kerberoast\" {\r\n                $user = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                Update-User-for-Kerberoast -domainAdminCreds $DomainAdminCreds -targetUser $user -domainName $domainName\r\n                Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                $appliedAttacks += \"Update-User-for-Kerberoast\"\r\n                $previousUser = $user\r\n            }\r\n            \"Update-User-for-Constrained-Delegation\" {\r\n                if ($previousUser -ne $null -and $appliedAttacks -contains \"Disable-PreAuth\" -or $appliedAttacks -contains \"Update-User-for-Kerberoast\" -or $appliedAttacks -contains \"Add-CredsForMimikatz\") {\r\n                    Update-User-for-Constrained-Delegation -domainAdminCreds $DomainAdminCreds -userForCDelegation $previousUser -dcName $dcName -domainName $domainName\r\n                    $appliedAttacks += \"Update-User-for-Constrained-Delegation\"\r\n                }\r\n            }\r\n            \"Update-Computer-for-Constrained-Delegation\" {\r\n                if ($appliedAttacks -contains \"Set-LocalPrivEsc-BinPathWriteAccess\" -or $appliedAttacks -contains \"Set-UnquotedServicePathVulnerability\") {\r\n                    Update-Computer-for-Constrained-Delegation -domainAdminCreds $DomainAdminCreds -computerForCDelegation $targetBox -dcName $dcName -domainName $domainName\r\n                    $appliedAttacks += \"Update-Computer-for-Constrained-Delegation\"\r\n                }\r\n            }\r\n            \"Set-LocalPrivEsc-BinPathWriteAccess\" {\r\n                Set-LocalPrivEsc-BinPathWriteAccess -domainAdminCreds $DomainAdminCreds -targetUser $entryUser -domainName $domainName\r\n                $appliedAttacks += \"Set-LocalPrivEsc-BinPathWriteAccess\"\r\n            }\r\n            \"Set-UnquotedServicePathVulnerability\" {\r\n                Set-UnquotedServicePathVulnerability -domainAdminCreds $DomainAdminCreds -targetUser $entryUser\r\n                $appliedAttacks += \"Set-UnquotedServicePathVulnerability\"\r\n            }\r\n            \"Add-CredsForMimikatz\" {\r\n                if ($appliedAttacks -contains \"Set-LocalPrivEsc-BinPathWriteAccess\" -or $appliedAttacks -contains \"Set-UnquotedServicePathVulnerability\") {\r\n                    $mimikatzUser = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                    Set-ADAccountPassword -Identity $mimikatzUser -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                    Add-CredsForMimikatz -userForMimikatz $mimikatzUser -singleUserPassword \"Password123\" -domainName $domainName -computerForMimikatz $targetBox\r\n                    $appliedAttacks += \"Add-CredsForMimikatz\"\r\n                    $previousUser = $mimikatzUser\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    # Log applied attacks\r\n    Add-Content -Path $logFilePath -Value \"GenerateRandomCTF: Successfully generated a random CTF with $($appliedAttacks.Count) attacks: $($appliedAttacks -join ', ')\"\r\n}\r\n\r\n\r\n\r\n",
                            "$fxv#10": "param(\n    [string]$domainName,                   # The FQDN of the domain to join (e.g., dev.build.lab or build.lab\n    [string]$domainAndEnterpriseAdminUsername,      # Domain admin user e.g., build\\admin\n    [string]$enterpriseAdminPassword                # Plain text password for domain join\n)\n\n\n[securestring]$enterpriseAdminPassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n[pscredential]$enterpriseAdminCreds = New-Object System.Management.Automation.PSCredential ($domainAndEnterpriseAdminUsername, $enterpriseAdminPassword)\n\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n\n# Ensure C:\\Temp directory exists\nif (!(Test-Path \"C:\\Temp\")) {\n    New-Item -ItemType Directory -Path \"C:\\Temp\" -Force | Out-Null\n}\n\nAdd-Content -Path $logFilePath -Value \"=== JoinDomain.ps1 Script Started ===\"\nAdd-Content -Path $logFilePath -Value \"Target domain: $domainName\"\n\n$joinedDomain = $false\n$maxAttempts = 10\n$attempt = 0\n\nwhile (!$joinedDomain -and $attempt -lt $maxAttempts){\n\t$attempt++\n\tAdd-Content -Path $logFilePath -Value \"Attempt $attempt of $maxAttempts to join domain...\"\n\n\ttry {\n\t\t# Join domain WITHOUT automatic restart to maintain run-command control\n\t\tAdd-Computer -DomainName $domainName -Credential $enterpriseAdminCreds -Force -ErrorAction Stop\n\t\tAdd-Content -Path $logFilePath -Value \"Add-Computer command completed successfully\"\n\n\t\t# Verify the join was successful\n\t\t$currentDomain = (Get-CimInstance Win32_ComputerSystem).Domain\n\t\tAdd-Content -Path $logFilePath -Value \"Current domain after join: $currentDomain\"\n\n\t\tif ($currentDomain -eq $domainName){\n\t\t\t$joinedDomain = $true\n\t\t\tAdd-Content -Path $logFilePath -Value \"Successfully joined domain $domainName\"\n\n\t\t\t# Now restart the computer for domain join to take full effect\n\t\t\tAdd-Content -Path $logFilePath -Value \"Restarting computer to complete domain join...\"\n\t\t\tRestart-Computer -Force\n\t\t\tbreak\n\t\t} else {\n\t\t\tAdd-Content -Path $logFilePath -Value \"Domain join command completed but domain is $currentDomain, not $domainName. Retrying...\"\n\t\t\tStart-Sleep -Seconds 30\n\t\t}\n\t} catch {\n\t\tAdd-Content -Path $logFilePath -Value \"Error joining the $domainName domain (attempt $attempt): $_\"\n\t\tAdd-Content -Path $logFilePath -Value \"Exception Type: $($_.Exception.GetType().FullName)\"\n\t\tStart-Sleep -Seconds 30\n\t}\n}\n\nif (!$joinedDomain) {\n\tAdd-Content -Path $logFilePath -Value \"FATAL: Failed to join domain after $maxAttempts attempts\"\n\texit 1\n}\n\nAdd-Content -Path $logFilePath -Value \"=== JoinDomain.ps1 Script Completed ===\"\n",
                            "$fxv#11": "param(\n\t[string]$enterpriseAdminUsername,\n\t[string]$enterpriseAdminPassword\n)\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n\n# Ensure C:\\Temp directory exists\nif (!(Test-Path \"C:\\Temp\")) {\n    New-Item -ItemType Directory -Path \"C:\\Temp\" -Force | Out-Null\n}\n\ntry {\n    Add-Content -Path $logFilePath -Value \"=== ConfigureCA.ps1 Script Started ===\"\n    Add-Content -Path $logFilePath -Value \"Received username: $enterpriseAdminUsername\"\n    Add-Content -Path $logFilePath -Value \"Password received: $($enterpriseAdminPassword.Length) characters\"\n\n    Add-Content -Path $logFilePath -Value \"Creating credentials...\"\n    [securestring]$secureEnterpriseAdminPassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n    [pscredential]$enterpriseAdminCreds = New-Object System.Management.Automation.PSCredential ($enterpriseAdminUsername, $secureEnterpriseAdminPassword)\n    Add-Content -Path $logFilePath -Value \"Credentials created successfully\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"FATAL: Failed to create credentials. $_\"\n    exit 1\n}\n\ntry {\n    Add-Content -Path $logFilePath -Value \"Installing ADCS Windows Feature...\"\n    Add-WindowsFeature Adcs-Cert-Authority -IncludeManagementTools\n    Add-Content -Path $logFilePath -Value \"ADCS Windows Feature installed\"\n\n    Add-Content -Path $logFilePath -Value \"Installing ADCS Certification Authority...\"\n    Install-AdcsCertificationAuthority -CAType EnterpriseRootCA -Credential $enterpriseAdminCreds -Force\n    Add-Content -Path $logFilePath -Value \"Successfully Installed ADCS.\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"Failed Installing ADCS. $_\"\n    Add-Content -Path $logFilePath -Value \"Exception Type: $($_.Exception.GetType().FullName)\"\n}\ntry {\n    Add-Content -Path $logFilePath -Value \"Installing ADLDS Windows Feature...\"\n    Install-WindowsFeature ADLDS -IncludeManagementTools\n    Add-Content -Path $logFilePath -Value \"Successfully Installed ADLDS.\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"Failed installing ADLDS. $_\"\n}\n\nAdd-Content -Path $logFilePath -Value \"=== ConfigureCA.ps1 Script Completed ===\"\n",
                            "$fxv#2": "dn: CN=ESC1Vuln,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\nchangetype: add\ncn: ESC1Vuln\ndisplayName: ESC1Vuln\ndistinguishedName: \n CN=ESC1Vuln,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Con\n figuration,DC=redteam,DC=lab\ndSCorePropagationData: 20240207204330.0Z\ndSCorePropagationData: 16010101000000.0Z\ndSCorePropagationData: 17130709023336.0Z\nflags: 131649\ninstanceType: 4\nmsPKI-Cert-Template-OID: \n 1.3.6.1.4.1.311.21.8.1958530.2366506.14305465.6392049.15594681.131.12125312.52\n 91900\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.1\nmsPKI-Certificate-Name-Flag: 134217729\nmsPKI-Enrollment-Flag: 0\nmsPKI-Minimal-Key-Size: 2048\nmsPKI-Private-Key-Flag: 16842752\nmsPKI-RA-Signature: 0\nmsPKI-Template-Minor-Revision: 5\nmsPKI-Template-Schema-Version: 2\nname: ESC1Vuln\nobjectCategory: \n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\nobjectClass: top\nobjectClass: pKICertificateTemplate\npKICriticalExtensions: 2.5.29.15\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\npKIDefaultKeySpec: 1\npKIExpirationPeriod:: AIByDl3C/f8=\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.2\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.1\npKIKeyUsage:: oAA=\npKIMaxIssuingDepth: 0\npKIOverlapPeriod:: AICmCv/e//8=\nrevision: 100\nshowInAdvancedViewOnly: TRUE\nuSNChanged: 45189\nuSNCreated: 45157\nwhenChanged: 20240207204332.0Z\nwhenCreated: 20240207203957.0Z\n\n",
                            "$fxv#3": "dn: CN=ESC1Vuln,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\nchangetype: modify\nreplace:nTSecurityDescriptor\nnTSecurityDescriptor:: \n AQAEjNgAAAD0AAAAAAAAABQAAAAEAMQABgAAAAUAKAAAAQAAAQAAAGjJEA77eNIRkNQAwE953FUBAQ\n AAAAAABQsAAAAAACQA/wEPAAEFAAAAAAAFFQAAAIVrTN0IKzmH3Rhi7QACAAAAABQAlAACAAEBAAAA\n AAAFCwAAAAAAFAD/AQ8AAQEAAAAAAAUSAAAAABIkAP8BDwABBQAAAAAABRUAAACFa0zdCCs5h90YYu\n 0HAgAAABIkAL0BDwABBQAAAAAABRUAAACFa0zdCCs5h90YYu0AAgAAAQUAAAAAAAUVAAAAhWtM3Qgr\n OYfdGGLtBwIAAAEFAAAAAAAFFQAAAIVrTN0IKzmH3Rhi7QcCAAA=\n-\n\n",
                            "$fxv#4": "dn: CN=ESC3VulnAuthSignatures,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: add\r\ncn: ESC3VulnAuthSignatures\r\ndisplayName: ESC3VulnAuthSignatures\r\ndistinguishedName: \r\n CN=ESC3VulnAuthSignatures,CN=Certificate Templates,CN=Public Key Servic\r\n es,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\ndSCorePropagationData: 16010101000000.0Z\r\nflags: 131649\r\ninstanceType: 4\r\nmsPKI-Cert-Template-OID: \r\n 1.3.6.1.4.1.311.21.8.1958530.2366506.14305465.6392049.15594681.131.12906934.52\r\n 08534\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\r\nmsPKI-Certificate-Name-Flag: 33554432\r\nmsPKI-Enrollment-Flag: 32\r\nmsPKI-Minimal-Key-Size: 2048\r\nmsPKI-Private-Key-Flag: 16842752\r\nmsPKI-RA-Application-Policies: 1.3.6.1.4.1.311.20.2.1\r\nmsPKI-RA-Signature: 1\r\nmsPKI-Template-Minor-Revision: 6\r\nmsPKI-Template-Schema-Version: 2\r\nname: ESC3VulnAuthSignatures\r\nobjectCategory: \r\n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\r\nobjectClass: top\r\nobjectClass: pKICertificateTemplate\r\npKICriticalExtensions: 2.5.29.15\r\npKICriticalExtensions: 2.5.29.7\r\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\r\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\r\npKIDefaultKeySpec: 1\r\npKIExpirationPeriod:: AIByDl3C/f8=\r\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.2\r\npKIKeyUsage:: oAA=\r\npKIMaxIssuingDepth: 0\r\npKIOverlapPeriod:: AICmCv/e//8=\r\nrevision: 100\r\nshowInAdvancedViewOnly: TRUE\r\nuSNChanged: 45209\r\nuSNCreated: 45207\r\nwhenChanged: 20240213221056.0Z\r\nwhenCreated: 20240213221055.0Z\r\n\r\n",
                            "$fxv#5": "dn: CN=ESC3VulnRequestAgent,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: modify\r\nreplace:nTSecurityDescriptor\r\nnTSecurityDescriptor:: \r\n AQAEnDQBAABQAQAAAAAAABQAAAAEACABBwAAAAUAOAAwAQAAAQAAAGjJEA77eNIRkNQAwE953FUBBQ\r\n AAAAAABRUAAACFa0zdCCs5h90YYu0AAgAABQA4ADABAAABAAAAaMkQDvt40hGQ1ADAT3ncVQEFAAAA\r\n AAAFFQAAAIVrTN0IKzmH3Rhi7QcCAAAFACgAAAEAAAEAAABoyRAO+3jSEZDUAMBPedxVAQEAAAAAAA\r\n ULAAAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu0AAgAAAAAkAP8ADwABBQAAAAAABRUA\r\n AACFa0zdCCs5h90YYu0HAgAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAAAUAJ\r\n QAAgABAQAAAAAABQsAAAABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAQUAAAAAAAUVAAAAhWtM\r\n 3QgrOYfdGGLtBwIAAA==\r\n-\r\n",
                            "$fxv#6": "dn: CN=ESC4VulnWrite,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: add\r\ncn: ESC4VulnWrite\r\ndisplayName: ESC4VulnWrite\r\ndistinguishedName:\r\n CN=ESC4VulnWrite,CN=Certificate Templates,CN=Public Key Services,CN=Services,C\r\n N=Configuration,DC=redteam,DC=lab\r\ndSCorePropagationData: 20240214220029.0Z\r\ndSCorePropagationData: 16010101000000.0Z\r\nflags: 131649\r\ninstanceType: 4\r\nmsPKI-Cert-Template-OID:\r\n 1.3.6.1.4.1.311.21.8.7095186.10767367.6704308.10313546.8444657.192.8811968.127\r\n 77348\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.1\r\nmsPKI-Certificate-Name-Flag: 134217728\r\nmsPKI-Enrollment-Flag: 2\r\nmsPKI-Minimal-Key-Size: 2048\r\nmsPKI-Private-Key-Flag: 16842752\r\nmsPKI-RA-Signature: 0\r\nmsPKI-Template-Minor-Revision: 5\r\nmsPKI-Template-Schema-Version: 2\r\nname: ESC4VulnWrite\r\nobjectCategory:\r\n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\r\nobjectClass: top\r\nobjectClass: pKICertificateTemplate\r\npKICriticalExtensions: 2.5.29.15\r\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\r\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\r\npKIDefaultKeySpec: 1\r\npKIExpirationPeriod:: AIByDl3C/f8=\r\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.2\r\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.1\r\npKIKeyUsage:: oAA=\r\npKIMaxIssuingDepth: 0\r\npKIOverlapPeriod:: AICmCv/e//8=\r\nrevision: 100\r\nshowInAdvancedViewOnly: TRUE\r\nuSNChanged: 16495\r\nuSNCreated: 16443\r\nwhenChanged: 20240214220029.0Z\r\nwhenCreated: 20240214214918.0Z\r\n\r\n",
                            "$fxv#7": "dn: CN=ESC3VulnRequestAgent,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: add\r\ncn: ESC3VulnRequestAgent\r\ndisplayName: ESC3VulnRequestAgent\r\ndistinguishedName: \r\n CN=ESC3VulnRequestAgent,CN=Certificate Templates,CN=Public Key Services\r\n ,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\ndSCorePropagationData: 20240213215736.0Z\r\ndSCorePropagationData: 16010101000000.0Z\r\nflags: 131649\r\ninstanceType: 4\r\nmsPKI-Cert-Template-OID: \r\n 1.3.6.1.4.1.311.21.8.1958530.2366506.14305465.6392049.15594681.131.12316097.88\r\n 85348\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.4.1.311.20.2.1\r\nmsPKI-Certificate-Name-Flag: 33554432\r\nmsPKI-Enrollment-Flag: 32\r\nmsPKI-Minimal-Key-Size: 2048\r\nmsPKI-Private-Key-Flag: 16842752\r\nmsPKI-RA-Signature: 0\r\nmsPKI-Template-Minor-Revision: 4\r\nmsPKI-Template-Schema-Version: 2\r\nname: ESC3VulnRequestAgent\r\nobjectCategory: \r\n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\r\nobjectClass: top\r\nobjectClass: pKICertificateTemplate\r\npKICriticalExtensions: 2.5.29.7\r\npKICriticalExtensions: 2.5.29.15\r\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\r\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\r\npKIDefaultKeySpec: 1\r\npKIExpirationPeriod:: AIByDl3C/f8=\r\npKIExtendedKeyUsage: 1.3.6.1.4.1.311.20.2.1\r\npKIKeyUsage:: oAA=\r\npKIMaxIssuingDepth: 0\r\npKIOverlapPeriod:: AICmCv/e//8=\r\nrevision: 100\r\nshowInAdvancedViewOnly: TRUE\r\nuSNChanged: 45157\r\nuSNCreated: 45150\r\nwhenChanged: 20240213220051.0Z\r\nwhenCreated: 20240213215724.0Z\r\n\r\n",
                            "$fxv#8": "dn: CN=ESC3VulnAuthSignatures,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: modify\r\nreplace:nTSecurityDescriptor\r\nnTSecurityDescriptor:: \r\n AQAEnDQBAABQAQAAAAAAABQAAAAEACABBwAAAAUAOAAwAQAAAQAAAGjJEA77eNIRkNQAwE953FUBBQ\r\n AAAAAABRUAAACFa0zdCCs5h90YYu0AAgAABQA4ADABAAABAAAAaMkQDvt40hGQ1ADAT3ncVQEFAAAA\r\n AAAFFQAAAIVrTN0IKzmH3Rhi7QcCAAAFACgAAAEAAAEAAABoyRAO+3jSEZDUAMBPedxVAQEAAAAAAA\r\n ULAAAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu0AAgAAAAAkAP8ADwABBQAAAAAABRUA\r\n AACFa0zdCCs5h90YYu0HAgAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAAAUAJ\r\n QAAgABAQAAAAAABQsAAAABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAQUAAAAAAAUVAAAAhWtM\r\n 3QgrOYfdGGLtBwIAAA==\r\n-\r\n",
                            "$fxv#9": "dn: CN=ESC4VulnWrite,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: modify\r\nreplace:nTSecurityDescriptor\r\nnTSecurityDescriptor:: \r\n AQAEnDQBAABQAQAAAAAAABQAAAAEACABBwAAAAYAKAAAAQAAAQAAAMKMW6C8FwJIpxDnwVq4ZqIBAQ\r\n AAAAAABQsAAAAFADgAMAEAAAEAAABoyRAO+3jSEZDUAMBPedxVAQUAAAAAAAUVAAAAX/H53KXtdAw6\r\n 4UyHAAIAAAUAOAAwAQAAAQAAAGjJEA77eNIRkNQAwE953FUBBQAAAAAABRUAAABf8fncpe10DDrhTI\r\n cHAgAAAAAkAP8ADwABBQAAAAAABRUAAABf8fncpe10DDrhTIcAAgAAAAAkAP8ADwABBQAAAAAABRUA\r\n AABf8fncpe10DDrhTIcHAgAAAAAkAP8ADwABBQAAAAAABRUAAABf8fncpe10DDrhTIf0AQAAAAAUAL\r\n QADgABAQAAAAAABQsAAAABBQAAAAAABRUAAABf8fncpe10DDrhTIf0AQAAAQUAAAAAAAUVAAAAX/H5\r\n 3KXtdAw64UyHBwIAAA==\r\n-\r\n\r\n",
                            "isIP10": "[startsWith(parameters('privateIPAddress'), '10.10.')]",
                            "isIP172": "[startsWith(parameters('privateIPAddress'), '172.16.')]",
                            "isIP192": "[startsWith(parameters('privateIPAddress'), '192.168.')]",
                            "vName": "[if(parameters('oldScenarios'), 'lab-network', if(variables('isIP10'), 'vnet-10', if(variables('isIP172'), 'vnet-172', 'vnet-192')))]",
                            "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(variables('isIP10'), 'vnet-10/subnet-10', if(variables('isIP172'), 'vnet-172/subnet-172', 'vnet-192/subnet-192')))]",
                            "currentNetwork": "[if(startsWith(parameters('privateIPAddress'), '10.10.'), '10', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172', '192'))]",
                            "dcNetwork": "[if(startsWith(parameters('rootDomainControllerPrivateIp'), '10.10.'), '10', if(startsWith(parameters('rootDomainControllerPrivateIp'), '172.16.'), '172', '192'))]",
                            "requiresPeering": "[and(and(not(empty(parameters('rootDomainControllerPrivateIp'))), not(equals(variables('currentNetwork'), variables('dcNetwork')))), not(parameters('skipPeering')))]",
                            "jumpboxNetwork": "[if(empty(parameters('jumpboxPrivateIPAddress')), '00', if(startsWith(parameters('jumpboxPrivateIPAddress'), '10.10.'), '10', if(startsWith(parameters('jumpboxPrivateIPAddress'), '172.16.'), '172', '192')))]",
                            "isJumpbox": "[if(and(and(and(not(empty(parameters('privateIPAddress'))), not(empty(parameters('connectedPrivateIPAddress')))), not(empty(variables('currentNetwork')))), not(empty(variables('jumpboxNetwork')))), and(equals(parameters('privateIPAddress'), parameters('connectedPrivateIPAddress')), not(equals(variables('currentNetwork'), variables('jumpboxNetwork')))), false())]",
                            "caPeeringRules": "[if(variables('requiresPeering'), createArray(createObject('name', 'Allow-DC-to-CA-Inbound', 'properties', createObject('description', 'Allows inbound traffic from Domain Controller', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('rootDomainControllerPrivateIp'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 100, 'direction', 'Inbound')), createObject('name', 'Allow-CA-to-DC-Outbound', 'properties', createObject('description', 'Allows outbound traffic to Domain Controller', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('privateIPAddress'), 'destinationAddressPrefix', parameters('rootDomainControllerPrivateIp'), 'access', 'Allow', 'priority', 100, 'direction', 'Outbound')), createObject('name', 'Allow-IntraSubnet-Inbound', 'properties', createObject('description', 'Allows all inbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Inbound')), createObject('name', 'Allow-IntraSubnet-Outbound', 'properties', createObject('description', 'Allows all outbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Outbound')), createObject('name', 'Deny-CrossSubnet-Inbound', 'properties', createObject('description', 'Denies all other inbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('rootDomainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('rootDomainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Inbound')), createObject('name', 'Deny-CrossSubnet-Outbound', 'properties', createObject('description', 'Denies all other outbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('rootDomainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('rootDomainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Outbound'))), createArray())]",
                            "jumpboxRules": "[if(variables('isJumpbox'), createArray(createObject('name', 'Allow-Jumpbox-Communication-Inbound', 'properties', createObject('description', 'Allows inbound traffic from jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 150, 'direction', 'Inbound')), createObject('name', 'Allow-Jumpbox-Communication-Outbound', 'properties', createObject('description', 'Allows outbound traffic to jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('privateIPAddress'), 'destinationAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'access', 'Allow', 'priority', 150, 'direction', 'Outbound'))), createArray())]",
                            "publicIPRules": "[if(parameters('hasPublicIP'), createArray(createObject('name', 'Allow-RDP-From-Public', 'properties', createObject('description', 'Allows RDP from caller IP', 'protocol', 'Tcp', 'sourcePortRange', '*', 'destinationPortRange', '3389', 'sourceAddressPrefix', parameters('callerIPAddress'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 102, 'direction', 'Inbound'))), createArray())]",
                            "allNSGRules": "[concat(variables('caPeeringRules'), variables('jumpboxRules'), variables('publicIPRules'))]"
                          },
                          "resources": [
                            {
                              "condition": "[not(empty(variables('allNSGRules')))]",
                              "type": "Microsoft.Network/networkSecurityGroups",
                              "apiVersion": "2023-05-01",
                              "name": "[format('ca-nsg-{0}', parameters('virtualMachineHostname'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "securityRules": "[variables('allNSGRules')]"
                              }
                            },
                            {
                              "condition": "[parameters('hasPublicIP')]",
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}-pip', parameters('virtualMachineHostname'))]",
                              "location": "[parameters('location')]",
                              "sku": {
                                "name": "Basic"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "Dynamic",
                                "dnsSettings": {
                                  "domainNameLabel": "[toLower(format('{0}-{1}', parameters('virtualMachineHostname'), uniqueString(resourceGroup().id)))]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}-NIC', parameters('virtualMachineHostname'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "dnsSettings": {
                                  "dnsServers": [
                                    "[parameters('rootDomainControllerPrivateIp')]",
                                    "8.8.8.8"
                                  ]
                                },
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfigCA",
                                    "properties": {
                                      "privateIPAllocationMethod": "Static",
                                      "privateIPAddress": "[parameters('privateIPAddress')]",
                                      "subnet": {
                                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', split(variables('subnetName'), '/')[0], split(variables('subnetName'), '/')[1])]"
                                      },
                                      "publicIPAddress": "[if(parameters('hasPublicIP'), createObject('id', resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('virtualMachineHostname')))), null())]"
                                    }
                                  }
                                ],
                                "networkSecurityGroup": "[if(not(empty(variables('allNSGRules'))), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', format('ca-nsg-{0}', parameters('virtualMachineHostname')))), null())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkSecurityGroups', format('ca-nsg-{0}', parameters('virtualMachineHostname')))]",
                                "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[variables('requiresPeering')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('dcNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('dcNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[variables('requiresPeering')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('dcNetwork'), variables('currentNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('currentNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]",
                                "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('dcNetwork')), '/')[0], split(format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('dcNetwork')), '/')[1])]"
                              ]
                            },
                            {
                              "condition": "[variables('isJumpbox')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('jumpboxNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('jumpboxNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'deploy')]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2023-07-01",
                              "name": "[parameters('virtualMachineHostname')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('CA:{0}', parameters('resourceGroupName'))]"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "id": "[parameters('imageReference')]"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2023-07-01",
                              "name": "[parameters('virtualMachineHostname')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('CA:{0}', parameters('resourceGroupName'))]"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "osDisk": {
                                    "createOption": "fromImage",
                                    "managedDisk": {
                                      "storageAccountType": "[parameters('osDiskType')]"
                                    }
                                  },
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2022-datacenter-g2",
                                    "version": "latest"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                                    }
                                  ]
                                },
                                "osProfile": {
                                  "computerName": "[parameters('virtualMachineHostname')]",
                                  "adminUsername": "[parameters('localAdminUsername')]",
                                  "adminPassword": "[parameters('localAdminPassword')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-07-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'setupConfigurationFilesCA')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "parameters": [
                                  {
                                    "name": "targetFiles",
                                    "value": "module,esc"
                                  },
                                  {
                                    "name": "domainName",
                                    "value": "[parameters('domainName')]"
                                  }
                                ],
                                "source": {
                                  "script": "[replace(replace(replace(replace(replace(replace(replace(replace(replace(variables('$fxv#0'), '__MODULE_CONTENT_PLACEHOLDER__', variables('$fxv#1')), '__ESC1_VULN_PLACEHOLDER__', variables('$fxv#2')), '__ESC1_VULN_SD_PLACEHOLDER__', variables('$fxv#3')), '__ESC3_AUTH_SIG_PLACEHOLDER__', variables('$fxv#4')), '__ESC3_REQ_AGENT_SD_PLACEHOLDER__', variables('$fxv#5')), '__ESC4_VULN_PLACEHOLDER__', variables('$fxv#6')), '__ESC3_REQ_AGENT_PLACEHOLDER__', variables('$fxv#7')), '__ESC3_AUTH_SIG_SD_PLACEHOLDER__', variables('$fxv#8')), '__ESC4_VULN_SD_PLACEHOLDER__', variables('$fxv#9'))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-07-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'JoinDomain')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "parameters": [
                                  {
                                    "name": "domainAndEnterpriseAdminUsername",
                                    "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                                  },
                                  {
                                    "name": "enterpriseAdminPassword",
                                    "value": "[parameters('enterpriseAdminPassword')]"
                                  },
                                  {
                                    "name": "domainName",
                                    "value": "[parameters('domainName')]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#10')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'setupConfigurationFilesCA')]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-07-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'CertificateAuthorityConfigurationScript')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "parameters": [
                                  {
                                    "name": "enterpriseAdminUsername",
                                    "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                                  },
                                  {
                                    "name": "enterpriseAdminPassword",
                                    "value": "[parameters('enterpriseAdminPassword')]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#11')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'JoinDomain')]"
                              ]
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "generatedRootDCModules"
              ]
            },
            "triggerDCCertEnrollment": {
              "condition": "[greater(length(parameters('certificateAuthorities')), 0)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "TriggerDCCertEnrollment",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "domainControllers": {
                    "value": "[variables('allDomainControllers')]"
                  },
                  "caHostname": {
                    "value": "[parameters('certificateAuthorities')[0].name]"
                  },
                  "domainFQDN": {
                    "value": "[join(skip(split(parameters('rootDomainControllerFQDN'), '.'), 1), '.')]"
                  },
                  "domainNetBIOS": {
                    "value": "[parameters('rootDomainNetBIOSName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "16102334664291768943"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "domainControllers": {
                      "type": "array"
                    },
                    "caHostname": {
                      "type": "string"
                    },
                    "domainFQDN": {
                      "type": "string"
                    },
                    "domainNetBIOS": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "triggerDCEnrollment",
                        "count": "[length(parameters('domainControllers'))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/TriggerCertEnrollment', parameters('domainControllers')[copyIndex()].name)]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "caHostname",
                            "value": "[parameters('caHostname')]"
                          },
                          {
                            "name": "domainFQDN",
                            "value": "[parameters('domainFQDN')]"
                          },
                          {
                            "name": "domainNetBIOS",
                            "value": "[parameters('domainNetBIOS')]"
                          }
                        ],
                        "source": {
                          "script": "        param(\n          [string]$caHostname,\n          [string]$domainFQDN,\n          [string]$domainNetBIOS\n        )\n\n        $logFilePath = \"C:\\Temp\\logfile.txt\"\n        Add-Content -Path $logFilePath -Value \"Post-CA: Requesting Domain Controller certificate for PKINIT support\"\n\n        gpupdate /force | Out-Null\n        Start-Sleep -Seconds 5\n\n        # Request the DomainControllerAuthentication template with explicit CA config (non-interactive)\n        $caConfig = \"$caHostname.$domainFQDN\\$domainNetBIOS-$caHostname-CA\"\n        Add-Content -Path $logFilePath -Value \"Post-CA: Using CA config: $caConfig\"\n        certreq -enroll -machine -q -config $caConfig DomainControllerAuthentication\n\n        Add-Content -Path $logFilePath -Value \"Post-CA: Domain Controller certificate enrollment completed\"\n      "
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "generatedCAModules"
              ]
            },
            "CreateAndConfigureCA": {
              "condition": "[not(empty(parameters('caName')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "CreateAndConfigureCA",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "virtualMachineSize": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "virtualMachineHostname": {
                    "value": "[parameters('caName')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "osDiskType": {
                    "value": "[parameters('vmDiskType')]"
                  },
                  "rootDomainControllerPrivateIp": {
                    "value": "[parameters('rootDomainControllerPrivateIp')]"
                  },
                  "domainAndEnterpriseAdminUsername": {
                    "value": "[variables('domainAndEnterpriseAdminUsername')]"
                  },
                  "enterpriseAdminUsername": {
                    "value": "[parameters('enterpriseAdminUsername')]"
                  },
                  "enterpriseAdminPassword": {
                    "value": "[parameters('enterpriseAdminPassword')]"
                  },
                  "domainName": {
                    "value": "[parameters('domainName')]"
                  },
                  "deployOrBuild": {
                    "value": "[parameters('deployOrBuild')]"
                  },
                  "privateIPAddress": {
                    "value": "[parameters('certificateAuthorityPrivateIp')]"
                  },
                  "localAdminUsername": {
                    "value": "[parameters('caAdminUsername')]"
                  },
                  "localAdminPassword": {
                    "value": "[parameters('caAdminPassword')]"
                  },
                  "jumpboxPrivateIPAddress": {
                    "value": "[parameters('jumpboxPrivateIPAddress')]"
                  },
                  "connectedPrivateIPAddress": {
                    "value": "[parameters('connectedPrivateIPAddress')]"
                  },
                  "isVNet10Required": {
                    "value": "[variables('isVNet10Required')]"
                  },
                  "isVNet172Required": {
                    "value": "[variables('isVNet172Required')]"
                  },
                  "isVNet192Required": {
                    "value": "[variables('isVNet192Required')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "5356460969800015917"
                    }
                  },
                  "parameters": {
                    "virtualMachineSize": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "deployOrBuild": {
                      "type": "string"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "privateIPAddress": {
                      "type": "string"
                    },
                    "rootDomainControllerPrivateIp": {
                      "type": "string"
                    },
                    "virtualMachineHostname": {
                      "type": "string"
                    },
                    "imageReference": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "localAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "localAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "enterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "domainName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainAndEnterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "jumpboxPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "connectedPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "isVNet10Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet172Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet192Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "hasPublicIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "callerIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "skipPeering": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "variables": {
                    "$fxv#0": "\r\nparam(\r\n    [string]$targetFiles,\r\n    [string]$domainName\r\n)\r\n\r\n$logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n$domainDN = ($domainName -split '\\.' | ForEach-Object { \"DC=$_\" }) -join ','\r\nAdd-Content -Path $logFilePath -Value \"Domain DN: $domainDN\"\r\n\r\n$targetFilesArray = $targetFiles -split \",\"\r\n\r\nforeach ($file in $targetFilesArray)\r\n{\r\n    switch ($file)\r\n    {\r\n        'module'\r\n        {\r\n            Install-WindowsFeature -Name RSAT-AD-PowerShell\r\n            $localFilePath = \"C:\\Temp\\ADVulnEnvModule\"\r\n            $fileName = \"C:\\Temp\\ADVulnEnvModule\\ADVulnEnvModule.psm1\"\r\n\r\n            # Create directory if it doesn't exist\r\n            New-Item -ItemType Directory -Path $localFilePath -Force | Out-Null\r\n\r\n            Add-Content -Path $logFilePath -Value \"=== EMBEDDED SETUP STARTED ===\"\r\n            Add-Content -Path $logFilePath -Value \"Writing embedded module content to $fileName\"\r\n\r\n            # Module content embedded directly in script (will be replaced by bicep)\r\n            $moduleContent = @'\r\n__MODULE_CONTENT_PLACEHOLDER__\r\n'@\r\n\r\n            Add-Content -Path $logFilePath -Value \"Module content size: $($moduleContent.Length) characters\"\r\n\r\n            # Write the embedded module content to file\r\n            try {\r\n                [System.IO.File]::WriteAllText($fileName, $moduleContent, [System.Text.Encoding]::UTF8)\r\n                Add-Content -Path $logFilePath -Value \"Module content written to $fileName\"\r\n\r\n                # Verify file was created\r\n                if (Test-Path $fileName) {\r\n                    $fileSize = (Get-Item $fileName).Length\r\n                    Add-Content -Path $logFilePath -Value \"Module file verified: $fileSize bytes\"\r\n                } else {\r\n                    Add-Content -Path $logFilePath -Value \"ERROR: Module file was not created at $fileName\"\r\n                }\r\n            }\r\n            catch {\r\n                Add-Content -Path $logFilePath -Value \"ERROR writing module file: $_\"\r\n                Add-Content -Path $logFilePath -Value \"Exception type: $($_.Exception.GetType().FullName)\"\r\n                Add-Content -Path $logFilePath -Value \"Exception message: $($_.Exception.Message)\"\r\n            }\r\n        }\r\n        'esc'\r\n        {\r\n            # Create ADCS files directory\r\n            $adcsPath = \"C:\\Temp\\adcs-files\"\r\n            New-Item -ItemType Directory -Path $adcsPath -Force | Out-Null\r\n            Add-Content -Path $logFilePath -Value \"=== ESC FILES SETUP STARTED ===\"\r\n\r\n            # ESC file contents embedded directly in script (will be replaced by bicep)\r\n            $esc1Vuln = @'\r\n__ESC1_VULN_PLACEHOLDER__\r\n'@\r\n            $esc1VulnSecurityDescriptor = @'\r\n__ESC1_VULN_SD_PLACEHOLDER__\r\n'@\r\n            $esc3VulnAuthSignatures = @'\r\n__ESC3_AUTH_SIG_PLACEHOLDER__\r\n'@\r\n            $esc3VulnRequestAgentSecurityDescriptor = @'\r\n__ESC3_REQ_AGENT_SD_PLACEHOLDER__\r\n'@\r\n            $esc4VulnWrite = @'\r\n__ESC4_VULN_PLACEHOLDER__\r\n'@\r\n            $esc3VulnRequestAgent = @'\r\n__ESC3_REQ_AGENT_PLACEHOLDER__\r\n'@\r\n            $esc3VulnAuthSignaturesSecurityDescriptor = @'\r\n__ESC3_AUTH_SIG_SD_PLACEHOLDER__\r\n'@\r\n            $esc4VulnWriteSecurityDescriptor = @'\r\n__ESC4_VULN_SD_PLACEHOLDER__\r\n'@\r\n\r\n            # Replace hardcoded domain with actual domain DN\r\n            $esc1Vuln = $esc1Vuln -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc1VulnSecurityDescriptor = $esc1VulnSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnAuthSignatures = $esc3VulnAuthSignatures -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnRequestAgentSecurityDescriptor = $esc3VulnRequestAgentSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc4VulnWrite = $esc4VulnWrite -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnRequestAgent = $esc3VulnRequestAgent -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc3VulnAuthSignaturesSecurityDescriptor = $esc3VulnAuthSignaturesSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n            $esc4VulnWriteSecurityDescriptor = $esc4VulnWriteSecurityDescriptor -replace 'DC=redteam,DC=lab', $domainDN\r\n\r\n            Add-Content -Path $logFilePath -Value \"Replaced hardcoded domain with $domainDN in all ESC templates\"\r\n\r\n            # Write each ESC .ldf file from embedded content\r\n            $esc1Vuln | Set-Content -Path \"$adcsPath\\ESC1Vuln.ldf\" -Force\r\n            $esc1VulnSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC1VulnSecurityDescriptor.ldf\" -Force\r\n            $esc3VulnAuthSignatures | Set-Content -Path \"$adcsPath\\ESC3VulnAuthSignatures.ldf\" -Force\r\n            $esc3VulnRequestAgentSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC3VulnRequestAgentSecurityDescriptor.ldf\" -Force\r\n            $esc4VulnWrite | Set-Content -Path \"$adcsPath\\ESC4VulnWrite.ldf\" -Force\r\n            $esc3VulnRequestAgent | Set-Content -Path \"$adcsPath\\ESC3VulnRequestAgent.ldf\" -Force\r\n            $esc3VulnAuthSignaturesSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC3VulnAuthSignaturesSecurityDescriptor.ldf\" -Force\r\n            $esc4VulnWriteSecurityDescriptor | Set-Content -Path \"$adcsPath\\ESC4VulnWriteSecurityDescriptor.ldf\" -Force\r\n\r\n            Add-Content -Path $logFilePath -Value \"Successfully wrote 8 ADCS template files to $adcsPath\"\r\n        }\r\n        Default\r\n        {\r\n            Add-Content -Path $logFilePath -Value \"Error: Unknown target file type '$file'\"\r\n        }\r\n    }\r\n}\r\n",
                    "$fxv#1": "<# =============================\r\n          Creation Functions\r\n    ============================#>\r\n\r\n\r\nFunction GenerateUsers {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Define an array of 25 names\r\n    $userNames = @(\"User1\", \"User2\", \"User3\", \"User4\", \"User5\",\r\n                   \"User6\", \"User7\", \"User8\", \"User9\", \"User10\",\r\n                   \"User11\", \"User12\", \"User13\", \"User14\", \"User15\",\r\n                   \"User16\", \"User17\", \"User18\", \"User19\", \"User20\",\r\n                   \"User21\", \"User22\", \"User23\", \"User24\", \"EntryUser\")\r\n\r\n    # Loop through each name and create a user\r\n    foreach ($name in $userNames) {\r\n        try {\r\n            Add-Type -AssemblyName System.Web\r\n    \r\n            # Assign specific simple passwords for User8(Kerberoast User) and EntryUser\r\n            if ($name -eq \"User8\") {\r\n                $password = \"Password123\"\r\n            } elseif ($name -eq \"EntryUser\" -or $name -eq \"User2\") { # Assign simple passwords for entryuser(user to login with and user2 for responder attack)\r\n                $password = \"Password#1\"\r\n            } else {\r\n                # Generate a random password for other users\r\n                $password = [System.Web.Security.Membership]::GeneratePassword(25, 1)\r\n            }\r\n    \r\n            $description = 'Inspired by secframe.com/badblood.'\r\n            $upn = \"$name@$domainName\"\r\n    \r\n            # Create the user with New-ADUser using the provided credentials\r\n            New-ADUser -Name $name -SamAccountName $name -Surname $name -Enabled $true -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n    \r\n            # Add successful execution in logs\r\n            $successMessage = \"GenerateUsers Function: Successfully created user: $name\"\r\n            Add-Content -Path $logFilePath -Value $successMessage\r\n            Write-Output $successMessage\r\n\r\n            # Add EntryUser and User2 to rdp group (entryuser to be utilize to rdp into domain and User2 used to similate traffic for responder attack)\r\n            if ($name -eq \"EntryUser\") {\r\n                # Add to domain Remote Desktop Users group (DCs don't have local groups)\r\n                Add-ADGroupMember -Identity \"Remote Desktop Users\" -Members $name -Credential $DomainAdminCreds\r\n                $rdpMessage = \"GenerateUsers Function: Added $name to Remote Desktop Users domain group\"\r\n                Add-Content -Path $logFilePath -Value $rdpMessage\r\n                Write-Output $rdpMessage\r\n            }\r\n        } catch {\r\n            # Add failed execution in logs\r\n            Add-Content -Path $logFilePath -Value \"GenerateUsers Function: Error in running function and creating user $name : $_ \"\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\nFunction GenerateRandomUsers {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [int]$numberOfUsers,\r\n        [string]$usernameFormat = \"firstname\"  # Options: \"firstname\", \"firstname.lastname\", \"firstinitial.lastname\"\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    # Log the received parameters for debugging\r\n    Add-Content -Path $logFilePath -Value \"GenerateRandomUsers Function: Received usernameFormat parameter: '$usernameFormat'\"\r\n\r\n    # Read first names from the file\r\n    $fileURL = \"https://raw.githubusercontent.com/davidprowe/BadBlood/master/AD_Users_Create/Names/names.txt\"\r\n    $namesFilePath = \"C:\\temp\\names.txt\"\r\n    Invoke-WebRequest -Uri $fileURL -OutFile $namesFilePath\r\n    if (-Not (Test-Path $namesFilePath)) {\r\n        Write-Error \"Names file not found at $namesFilePath\"\r\n        return\r\n    }\r\n\r\n    $allFirstNames = Get-Content $namesFilePath\r\n\r\n    # Read last names from the file (if needed for format)\r\n    $allLastNames = @()\r\n    if ($usernameFormat -ne \"firstname\") {\r\n        $lastNamesURL = \"https://raw.githubusercontent.com/your-repo/lastnames.txt\"\r\n        $lastNamesFilePath = \"C:\\temp\\lastnames.txt\"\r\n        \r\n        # For now, use a predefined list of common last names\r\n        $allLastNames = @(\r\n            \"smith\", \"johnson\", \"williams\", \"brown\", \"jones\", \"garcia\", \"miller\", \"davis\", \r\n            \"rodriguez\", \"martinez\", \"hernandez\", \"lopez\", \"gonzalez\", \"wilson\", \"anderson\", \r\n            \"thomas\", \"taylor\", \"moore\", \"jackson\", \"martin\", \"lee\", \"perez\", \"thompson\", \r\n            \"white\", \"harris\", \"sanchez\", \"clark\", \"ramirez\", \"lewis\", \"robinson\", \"walker\",\r\n            \"young\", \"allen\", \"king\", \"wright\", \"scott\", \"torres\", \"nguyen\", \"hill\", \"flores\",\r\n            \"green\", \"adams\", \"nelson\", \"baker\", \"hall\", \"rivera\", \"campbell\", \"mitchell\",\r\n            \"carter\", \"roberts\", \"gomez\", \"phillips\", \"evans\", \"turner\", \"diaz\", \"parker\",\r\n            \"cruz\", \"edwards\", \"collins\", \"reyes\", \"stewart\", \"morris\", \"morales\", \"murphy\",\r\n            \"cook\", \"rogers\", \"gutierrez\", \"ortiz\", \"morgan\", \"cooper\", \"peterson\", \"bailey\",\r\n            \"reed\", \"kelly\", \"howard\", \"ramos\", \"kim\", \"cox\", \"ward\", \"richardson\", \"watson\",\r\n            \"brooks\", \"chavez\", \"wood\", \"james\", \"bennett\", \"gray\", \"mendoza\", \"ruiz\", \"hughes\",\r\n            \"price\", \"alvarez\", \"castillo\", \"sanders\", \"patel\", \"myers\", \"long\", \"ross\", \"foster\"\r\n        )\r\n    }\r\n\r\n    # Generate usernames based on format\r\n    $generatedUsernames = @()\r\n    for ($i = 0; $i -lt $numberOfUsers; $i++) {\r\n        $firstName = (Get-Random -InputObject $allFirstNames).ToLower()\r\n        \r\n        switch ($usernameFormat) {\r\n            \"firstname\" {\r\n                $username = $firstName\r\n            }\r\n            \"firstname.lastname\" {\r\n                $lastName = (Get-Random -InputObject $allLastNames).ToLower()\r\n                $username = \"$firstName.$lastName\"\r\n            }\r\n            \"firstinitial.lastname\" {\r\n                $lastName = (Get-Random -InputObject $allLastNames).ToLower()\r\n                $firstInitial = $firstName.Substring(0, 1).ToLower()\r\n                $username = \"$firstInitial$lastName\"\r\n            }\r\n            default {\r\n                $username = $firstName\r\n            }\r\n        }\r\n        \r\n        # Ensure username is unique in this batch\r\n        $counter = 1\r\n        $originalUsername = $username\r\n        while ($generatedUsernames -contains $username) {\r\n            $username = \"$originalUsername$counter\"\r\n            $counter++\r\n        }\r\n        \r\n        $generatedUsernames += $username\r\n    }\r\n\r\n    # Loop through each generated username and create a user\r\n    foreach ($username in $generatedUsernames) {\r\n        try {\r\n            Add-Type -AssemblyName System.Web\r\n\r\n            # Generate a random password for the user\r\n            $password = [System.Web.Security.Membership]::GeneratePassword(25, 1)\r\n\r\n            $description = 'Inspired by secframe.com/badblood.'\r\n            $upn = \"$username@$domainName\"\r\n            \r\n            # Use the username as both the display name and SAM account name\r\n            $displayName = $username\r\n\r\n            # Create the user with New-ADUser using the provided credentials\r\n            New-ADUser -Name $displayName -SamAccountName $username -Surname $username -Enabled $true -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n\r\n            # Add successful execution in logs\r\n            $successMessage = \"GenerateRandomUsers Function: Successfully created user: $username\"\r\n            Add-Content -Path $logFilePath -Value $successMessage\r\n            Write-Output $successMessage\r\n        } catch {\r\n            # Add failed execution in logs\r\n            Add-Content -Path $logFilePath -Value \"GenerateRandomUsers Function: Error in running function and creating user $username : $_ \"\r\n        }\r\n    }\r\n}\r\nFunction CreateSingleUser {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$singleUsername,\r\n        [string]$singleUserPassword\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    $description = 'Single User Creation'\r\n    $upn = \"$singleUsername@$domainName\"\r\n    \r\n    try {\r\n        # Create the user with New-ADUser using the provided credentials\r\n        New-ADUser -Name $singleUsername -SamAccountName $singleUsername -Surname $singleUsername -Enabled $true -AccountPassword (ConvertTo-SecureString $singleUserPassword -AsPlainText -Force) -UserPrincipalName $upn -Description $description -Credential $DomainAdminCreds\r\n\r\n        # Add successful execution in logs\r\n        $successMessage = \"CreateSingleUser Function: Successfully created user: $singleUsername\"\r\n        Add-Content -Path $logFilePath -Value $successMessage\r\n        Write-Output $successMessage\r\n\r\n    }\r\n    catch {\r\n        # Add failed execution in logs\r\n        Add-Content -Path $logFilePath -Value \"CreateSingleUser Function: Error in running function and creating user $singleUsername : $_ \"\r\n    }\r\n    \r\n}\r\n\r\nFunction ConfigureUserToRDP {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$targetUser\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    try {\r\n        Add-Type -AssemblyName System.Web\r\n\r\n\r\n        Add-ADGroupMember -Identity \"Remote Desktop Users\" -Members $targetUser -Credential $DomainAdminCreds\r\n        Add-LocalGroupMember -Group \"Remote Desktop Users\" -Member $targetUser \r\n        Add-Content -Path $logFilePath -Value \"ConfigureUserToRDP Function: Added $targetUser to Remote Desktop Users group\"\r\n        \r\n    } catch {\r\n        # Add failed execution in logs\r\n        Add-Content -Path $logFilePath -Value \"ConfigureUserToRDP Function: Error in running function $targetUser : $_ \"\r\n    }\r\n}\r\n\r\nFunction CreateAndOrganizeOUs {\r\n    param (\r\n        [string]$OU1Name,\r\n        [string]$OU2Name,\r\n        [int]$NumberOfUsersInOU1,\r\n        [pscredential]$DomainAdminCreds\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Create the first OU\r\n        New-ADOrganizationalUnit -Name $OU1Name -Credential $DomainAdminCreds\r\n        Add-Content -Path $logFilePath -Value \"Created OU: $OU1Name\"\r\n\r\n        # Create the second OU\r\n        New-ADOrganizationalUnit -Name $OU2Name -Credential $DomainAdminCreds\r\n        Add-Content -Path $logFilePath -Value \"Created OU: $OU2Name\"\r\n\r\n        # Move users to the first OU\r\n        $users = Get-ADUser -Filter * -SearchBase \"CN=Users,DC=redteam,DC=lab\" | Select-Object -First $NumberOfUsersInOU1\r\n        foreach ($user in $users) {\r\n            Move-ADObject -Identity $user.DistinguishedName -TargetPath \"OU=$OU1Name,DC=redteam,DC=lab\"\r\n            Add-Content -Path $logFilePath -Value \"Moved user $($user.Name) to OU: $OU1Name\"\r\n        }\r\n\r\n        # Move the remaining users to the second OU\r\n        $remainingUsers = Get-ADUser -Filter * -SearchBase \"CN=Users,DC=redteam,DC=lab\" \r\n        foreach ($user in $remainingUsers) {\r\n            Move-ADObject -Identity $user.DistinguishedName -TargetPath \"OU=$OU2Name,DC=redteam,DC=lab\"\r\n            Add-Content -Path $logFilePath -Value \"Moved user $($user.Name) to OU: $OU2Name\"\r\n        }\r\n\r\n    } catch {\r\n        Add-Content -Path $logFilePath -Value \"Error in CreateAndOrganizeOUs: $_ \"\r\n    }\r\n}\r\n\r\nFunction CreateComputerObjects {\r\n    param (\r\n        [string]$TargetOU, # Optional: OU to place the computer objects\r\n        [pscredential]$DomainAdminCreds\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Predefined list of computer names\r\n    $ComputerNames = @(\"Computer1\", \"Computer2\", \"Computer3\", \"Computer4\", \"Computer5\")\r\n\r\n    foreach ($name in $ComputerNames) {\r\n        try {\r\n            $params = @{\r\n                Name = $name\r\n                Credential = $DomainAdminCreds\r\n                Path = if ($TargetOU) { \"OU=$TargetOU,DC=redteam,DC=lab\" } else { \"CN=Computers,DC=redteam,DC=lab\" }\r\n            }\r\n\r\n            # Create the computer object\r\n            New-ADComputer @params\r\n\r\n            # Log success\r\n            Add-Content -Path $logFilePath -Value \"CreateComputerObjects: Successfully created computer object: $name\"\r\n        } catch {\r\n            # Log any errors\r\n            Add-Content -Path $logFilePath -Value \"CreateComputerObjects: Error creating computer object $name : $_ \"\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n<# =================================\r\n        Attack Vector Functions\r\n    ================================#>\r\n\r\nFunction Import-VulnerableCertificateTemplate {\r\n    param (\r\n        [string]$domainAdminUsername,\r\n        [string]$domainAdminPassword,\r\n        [string]$domainName,\r\n        [string]$templateName\r\n    )\r\n    $logLocation = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n        ldifde -i -k -f \"C:\\Temp\\adcs-files\\$templateName.ldf\" -b $domainAdminUsername $domainName $domainAdminPassword\r\n        ldifde -i -k -f $(\"C:\\Temp\\adcs-files\\\" + $templateName + \"SecurityDescriptor.ldf\") -b $domainAdminUsername $domainName $domainAdminPassword\r\n\r\n        # For ESC4, grant Domain Users WriteProperty and Enroll permissions\r\n        if ($templateName -eq \"ESC4VulnWrite\") {\r\n            Add-Content -Path $logLocation -Value \"Setting ESC4VulnWrite ACL for Domain Users...\"\r\n            $domain = (Get-ADDomain).NetBIOSName\r\n            $templateDN = \"CN=$templateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=$($domainName.Replace('.', ',DC='))\"\r\n\r\n            # Grant Write Property permission (to modify template attributes)\r\n            $result1 = dsacls $templateDN /G \"${domain}\\Domain Users:RPWP\" 2>&1\r\n            Add-Content -Path $logLocation -Value \"dsacls WriteProperty result: $result1\"\r\n\r\n            # Grant enrollment extended right (GUID 0e10c968-78fb-11d2-90d4-00c04f79dc55)\r\n            $result2 = dsacls $templateDN /G \"${domain}\\Domain Users:CA;0e10c968-78fb-11d2-90d4-00c04f79dc55\" 2>&1\r\n            Add-Content -Path $logLocation -Value \"dsacls Enrollment result: $result2\"\r\n\r\n            Add-Content -Path $logLocation -Value \"ESC4VulnWrite ACL updated successfully\"\r\n        }\r\n\r\n        Restart-Service -Name certsvc -Force\r\n    } catch {\r\n        Add-Content -Path $logLocation -Value \"Error Enabling $templateName : $_ \"\r\n    }\r\n}\r\n\r\nFunction Disable-PreAuth {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Use the credentials for AD operations\r\n        Set-ADAccountControl -Credential $domainAdminCreds -Identity $targetUser -DoesNotRequirePreAuth:$true\r\n\r\n        # Add successfull execution in logs\r\n        Add-Content -Path $logFilePath -Value \"DisablePreAuth Function: Successfully disabled preauth for $targetUser\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"DisablePreAuth Function: Error running Disable-PreAuth: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-User-for-Kerberoast {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Generate unique SPN per user by including username in hostname\r\n        $uniqueSpn = \"MSSQLSvc/sql-$targetUser.$domainName:1433\"\r\n\r\n        # Use the credentials for AD operations\r\n        Set-ADUser -Credential $domainAdminCreds -Identity $targetUser -ServicePrincipalNames @{Add=$uniqueSpn}\r\n\r\n        # Add successfull execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Kerberoast Function: Made $targetUser be kerberoasted with SPN $uniqueSpn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Kerberoast Function: Error running Update-User-for-Kerberoast: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-User-for-Constrained-Delegation {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$userForCDelegation,\r\n        [string]$dcName,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    try {\r\n        # Set the SPN for the DC\r\n        $spn = \"HTTP/$dcName.$domainName\"\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $dcName -ServicePrincipalNames @{ADD=$spn}\r\n        # Use the credentials for AD operations\r\n        Get-ADUser -Credential $domainAdminCreds -Identity $userForCDelegation | Set-ADAccountControl -TrustedToAuthForDelegation $true\r\n        Set-ADUser -Credential $domainAdminCreds -Identity $userForCDelegation -Add @{'msDS-AllowedToDelegateTo'=@($spn)}\r\n        \r\n        # Add successful execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Constrained-Delegation Function: Configured $userForCDelegation for constrained delegation with SPN $spn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-User-for-Constrained-Delegation Function: Error running Update-User-for-Constrained-Delegation: $_ \"\r\n    }\r\n}\r\n\r\nFunction Update-Computer-for-Constrained-Delegation {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$computerForCDelegation,\r\n        [string]$dcName,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n        # Set the SPN for the DC\r\n        $spn = \"HTTP/$dcName.$domainName\"\r\n        #Add spn onto DC\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $dcName -ServicePrincipalNames @{ADD=$spn}\r\n        # set target computer to be able to delegate\r\n        Get-ADComputer -Credential $domainAdminCreds -Identity $computerForCDelegation | Set-ADAccountControl -TrustedToAuthForDelegation $true\r\n        Set-ADComputer -Credential $domainAdminCreds -Identity $computerForCDelegation -Add @{'msDS-AllowedToDelegateTo'=@($spn)}\r\n        \r\n        # Add successful execution in logs\r\n        Add-Content -Path $logFilePath -Value \"Update-Computer-for-Constrained-Delegation Function: Configured $computerForCDelegation for constrained delegation with SPN $spn\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Update-Computer-for-Constrained-Delegation Function: Error running Update-Computer-for-Constrained-Delegation: $_ \"\r\n    }\r\n}\r\n\r\n\r\nFunction Set-ADUserPermissions {\r\n    param (\r\n        [string]$GrantingUser,\r\n        [string]$ReceivingUser,\r\n        [string]$PermissionType\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    \r\n    try {\r\n        # Get the AD user object for the receiving user\r\n        $user = Get-ADUser -Identity $ReceivingUser\r\n\r\n        # Define the type of access right based on the PermissionType string\r\n        $accessRight = @{\r\n            \"GenericAll\" = [System.DirectoryServices.ActiveDirectoryRights]::GenericAll\r\n            \"GenericWrite\" = [System.DirectoryServices.ActiveDirectoryRights]::WriteProperty\r\n        }\r\n\r\n        # Create an Access Control Entry (ACE)\r\n        $ace = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(\r\n            (New-Object System.Security.Principal.NTAccount($GrantingUser)),\r\n            $accessRight[$PermissionType],\r\n            'Allow'\r\n        )\r\n\r\n        # Get the current ACL for the user\r\n        $acl = Get-Acl \"AD:$($user.DistinguishedName)\"\r\n\r\n        # Add the new ACE to the ACL\r\n        $acl.AddAccessRule($ace)\r\n\r\n        # Set the new ACL on the user object\r\n        Set-Acl \"AD:$($user.DistinguishedName)\" $acl\r\n\r\n        # Log success\r\n        Add-Content -Path $logFilePath -Value \"Set-ADUserPermissions: Successfully set $PermissionType permission for $GrantingUser on $ReceivingUser\"\r\n    } catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Set-ADUserPermissions: Error setting permissions for $GrantingUser on $ReceivingUser : $_ \"\r\n    }\r\n}\r\n\r\nFunction SimulateUserTrafficAsUser2 {\r\n    param (\r\n        [string]$BogusSharePath,\r\n        [int]$IntervalSeconds\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # User2's credentials\r\n    $user2Username = \"redteam.lab\\User2\"\r\n    $user2Password = ConvertTo-SecureString \"Password#1\" -AsPlainText -Force\r\n    $user2Creds = New-Object System.Management.Automation.PSCredential ($user2Username, $user2Password)\r\n\r\n    # Script block to simulate traffic\r\n    $scriptBlock = {\r\n        param($BogusSharePath, $logFilePath, $IntervalSeconds)\r\n        while ($true) {\r\n            try {\r\n                # Attempt to access the bogus file share\r\n                & cmd.exe /c dir $BogusSharePath\r\n\r\n                # Log the attempt\r\n                Add-Content -Path $logFilePath -Value \"SimulateUserTraffic: Attempted to access $BogusSharePath\"\r\n            } catch {\r\n                # Log any errors from the attempt\r\n                Add-Content -Path $logFilePath -Value \"SimulateUserTraffic: Error accessing $BogusSharePath : $_ \"\r\n            }\r\n\r\n            # Wait for the specified interval\r\n            Start-Sleep -Seconds $IntervalSeconds\r\n        }\r\n    }\r\n\r\n    # Start the script block as a background job\r\n    Start-Job -ScriptBlock $scriptBlock -ArgumentList $BogusSharePath, $logFilePath, $IntervalSeconds -Credential $user2Creds\r\n}\r\n\r\nFunction Set-LocalPrivEsc-BinPathWriteAccess {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    # Specify the service you're targeting\r\n    $service = \"wuauserv\"\r\n    $domainUser = \"$domainName\\$targetUser\"\r\n    # File for acl updates\r\n    $downloadUrl =  \"http://web.archive.org/web/20190910062448if_/http://download.microsoft.com/download/1/7/d/17d82b72-bc6a-4dc8-bfaa-98b37b22b367/subinacl.msi\"\r\n    $localPath = \"C:\\Temp\\subinacl.msi\"  \r\n    try {\r\n        # Download subinacl.msi\r\n        Invoke-WebRequest -Uri $downloadUrl -OutFile $localPath  \r\n        # Install it silently to prevent gui\r\n        Start-Process \"msiexec.exe\" -ArgumentList \"/i $localPath /qn /norestart\" -NoNewWindow -Wait  \r\n        $subinaclPath = \"C:\\Program Files (x86)\\Windows Resource Kits\\Tools\\subinacl.exe\"  \r\n        # Grant targetuser full permissions on bin\r\n        & $subinaclPath /service $service /grant=$domainUser=F\r\n        # Log success\r\n        Add-Content -Path $logFilePath -Value \"Grant-ServiceBinPathWriteAccess: Successfully granted write access to binPath of $service for $targetUser.\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Grant-ServiceBinPathWriteAccess: Error granting write access to binPath of $service for $targetUser : $_\"\r\n    }\r\n}\r\n\r\n\r\nFunction Set-UnquotedServicePathVulnerability {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$vulnerablePath = \"C:\\Program Files\\My Vulnerable App\"\r\n    )\r\n\r\n    # Define the benign executable and service details\r\n    $benignExecutable = \"C:\\Windows\\System32\\notepad.exe\" # Example benign executable\r\n    $serviceName = \"BenignService\"\r\n    $serviceDisplayName = \"Benign Service\"\r\n    $servicePath = \"$vulnerablePath\\service.exe\" # Construct the service path with spaces\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\unquotedServicePathVulnerabilityLog.txt\"\r\n\r\n    try {\r\n        # Ensure the vulnerable directory path exists\r\n        New-Item -ItemType Directory -Path $vulnerablePath -Force\r\n\r\n        # Copy the benign executable to the service path (simulating a service installation)\r\n        Copy-Item -Path $benignExecutable -Destination $servicePath -Force\r\n\r\n        # Create the new service using sc.exe to bypass PowerShell cmdlet limitations on path quoting\r\n        $scArgs = \"create $serviceName binPath= `\"$servicePath`\" DisplayName= `\"$serviceDisplayName`\"\"\r\n        $scCreateResult = Start-Process sc.exe -ArgumentList $scArgs -Wait -PassThru -NoNewWindow\r\n\r\n        # Verify service creation was successful\r\n        if ($scCreateResult.ExitCode -eq 0) {\r\n            Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Service '$serviceName' created successfully.\"\r\n        } else {\r\n            throw \"Failed to create service. Exit Code: $($scCreateResult.ExitCode)\"\r\n        }\r\n\r\n        # Grant write access to the target user for the vulnerable part of the path\r\n        $acl = Get-Acl $vulnerablePath\r\n        $permission = \"$targetUser\",\"Modify\",\"Allow\"\r\n        $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission\r\n        $acl.AddAccessRule($accessRule)\r\n        Set-Acl -Path $vulnerablePath -AclObject $acl\r\n\r\n        Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Granted Modify access to '$targetUser' on '$vulnerablePath'.\"\r\n    }\r\n    catch {\r\n        Add-Content -Path $logFilePath -Value \"Create-UnquotedServicePathVulnerability: Error encountered: $_ \"\r\n    }\r\n}\r\n\r\n\r\n<#\r\nFunction Set-DomainAdminStoredCreds {\r\n    param (\r\n        [PSCredential]$domainAdminCreds,\r\n        [string]$targetUser,\r\n        [string]$domainName\r\n    )\r\n\r\n    # Generate a simple password for the target user\r\n    $newPassword = \"Password123!\"\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\domainAdminStoredCredsLog.txt\"\r\n\r\n    try {\r\n        # Change the password of the target user\r\n        Set-ADAccountPassword -Identity $targetUser -NewPassword (ConvertTo-SecureString $newPassword -AsPlainText -Force) -Credential $domainAdminCreds\r\n\r\n        # Extract domain admin credentials\r\n        $domainAdminUser = $domainAdminCreds.UserName\r\n        $domainAdminPassword = $domainAdminCreds.GetNetworkCredential().Password\r\n\r\n        # Use cmdkey to add stored credentials\r\n        $targetUserFQDN = \"$domainName\\$targetUser\"\r\n\r\n        Start-Process -FilePath \"cmdkey\" -ArgumentList \"/generic:$targetUserFQDN /user:$targetUserFQDN /pass:$newPassword\" -Credential $adminCreds -NoNewWindow -Wait\r\n\r\n        # Logging the action\r\n        Add-Content -Path $logFilePath -Value \"Set-DomainAdminStoredCreds: Successfully changed password and added stored credentials for '$targetUser'.\"\r\n    }\r\n    catch {\r\n        Add-Content -Path $logFilePath -Value \"Set-DomainAdminStoredCreds: Error encountered: $_ \"\r\n    }\r\n}\r\n#>\r\nFunction Add-CredsForMimikatz {\r\n    param (\r\n        [string]$userForMimikatz,\r\n        [string]$singleUserPassword,\r\n        [string]$domainName,\r\n        [string]$computerForMimikatz\r\n    )\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n    try {\r\n       # Need to add user to local admin group in order to be able to psremote in and provide creds.\r\n       #Add-LocalGroupMember -Group \"Administrators\" -Member $userForMimikatz\r\n \r\n       $username = \"$domainName\\$userForMimikatz\"\r\n       $password = ConvertTo-SecureString $singleUserPassword -AsPlainText -Force\r\n       $credential = New-Object System.Management.Automation.PSCredential ($username, $password)\r\n       Invoke-Command -Credential $credential -ComputerName $computerForMimikatz -ScriptBlock {Start-Process powershell.exe}\r\n       Add-Content -Path $logFilePath -Value \"Add-CredsForMimikatz: Configured $userForMimikatz to have hash within the targetbox\"\r\n    }\r\n    catch {\r\n        # Log any errors\r\n        Add-Content -Path $logFilePath -Value \"Add-CredsForMimikatz Function: Error running Add-CredsForMimikatz: $_ \"\r\n    }\r\n\r\n\r\n}\r\n\r\n\r\nFunction GenerateRandomCTF {\r\n    param (\r\n        [pscredential]$DomainAdminCreds,\r\n        [string]$domainName,\r\n        [string]$dcName,\r\n        [int]$numberOfUsers,\r\n        [string]$targetBox,\r\n        [string]$difficulty\r\n    )\r\n\r\n    # Define the log file path\r\n    $logFilePath = \"C:\\Temp\\logfile.txt\"\r\n\r\n    # Generate random users\r\n    GenerateRandomUsers -DomainAdminCreds $DomainAdminCreds -domainName $domainName -numberOfUsers $numberOfUsers\r\n\r\n    # Get all generated users\r\n    $randomUsers = Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName\r\n\r\n    # Assign RDP permissions to a random user\r\n    $entryUser = Get-Random -InputObject $randomUsers\r\n    ConfigureUserToRDP -DomainAdminCreds $DomainAdminCreds -domainName $domainName -targetUser $entryUser\r\n    Set-ADAccountPassword -Identity $entryUser -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n\r\n    # Determine attack count based on difficulty\r\n    $attackCount = switch ($difficulty) {\r\n        \"easy\" { 2 }\r\n        \"medium\" { 3 }\r\n        \"hard\" { 4 }\r\n        default { 2 }\r\n    }\r\n\r\n    # Define all attacks\r\n    $attacks = @(\r\n        \"Disable-PreAuth\", \r\n        \"Update-User-for-Kerberoast\", \r\n        \"Update-User-for-Constrained-Delegation\", \r\n        \"Update-Computer-for-Constrained-Delegation\", \r\n        \"Set-LocalPrivEsc-BinPathWriteAccess\", \r\n        \"Set-UnquotedServicePathVulnerability\", \r\n        \"Add-CredsForMimikatz\"\r\n    )\r\n\r\n    # Select the first attack\r\n    $firstAttackOptions = $attacks | Where-Object { $_ -in @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\", \"Disable-PreAuth\", \"Update-User-for-Kerberoast\") }\r\n    $firstAttack = Get-Random -InputObject $firstAttackOptions\r\n\r\n    # Remove first attack from remaining attacks\r\n    $remainingAttacks = $attacks | Where-Object { $_ -ne $firstAttack }\r\n\r\n    # Ensure the last attack leads to domain admin\r\n    $lastAttackOptions = @(\"Update-User-for-Constrained-Delegation\", \"Update-Computer-for-Constrained-Delegation\", \"Add-CredsForMimikatz\")\r\n    $lastAttack = Get-Random -InputObject $lastAttackOptions\r\n\r\n    # Adjust attack count to ensure it's valid\r\n    $countToSelect = [math]::Max($attackCount - 2, 0)\r\n    if ($countToSelect -gt 0) {\r\n        $selectedAttacks = @($firstAttack) + (Get-Random -InputObject $remainingAttacks -Count $countToSelect) + $lastAttack\r\n    } else {\r\n        $selectedAttacks = @($firstAttack, $lastAttack)\r\n    }\r\n\r\n    # Ensure Mimikatz or Update-Computer-for-Constrained-Delegation follows a priv esc attack and adjust selection if necessary\r\n    if ($selectedAttacks[-1] -in @(\"Add-CredsForMimikatz\", \"Update-Computer-for-Constrained-Delegation\") -and $firstAttack -notin @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\")) {\r\n        $firstAttack = Get-Random -InputObject @(\"Set-LocalPrivEsc-BinPathWriteAccess\", \"Set-UnquotedServicePathVulnerability\")\r\n        $selectedAttacks[0] = $firstAttack\r\n    }\r\n\r\n    # Initialize applied attacks array and previous user\r\n    $appliedAttacks = @()\r\n    $previousUser = $null\r\n\r\n    # Process attacks\r\n    foreach ($attack in $selectedAttacks) {\r\n        switch ($attack) {\r\n            \"Disable-PreAuth\" {\r\n                $user = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                Disable-PreAuth -domainAdminCreds $DomainAdminCreds -targetUser $user\r\n                Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                $appliedAttacks += \"Disable-PreAuth\"\r\n                $previousUser = $user\r\n            }\r\n            \"Update-User-for-Kerberoast\" {\r\n                $user = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                Update-User-for-Kerberoast -domainAdminCreds $DomainAdminCreds -targetUser $user -domainName $domainName\r\n                Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                $appliedAttacks += \"Update-User-for-Kerberoast\"\r\n                $previousUser = $user\r\n            }\r\n            \"Update-User-for-Constrained-Delegation\" {\r\n                if ($previousUser -ne $null -and $appliedAttacks -contains \"Disable-PreAuth\" -or $appliedAttacks -contains \"Update-User-for-Kerberoast\" -or $appliedAttacks -contains \"Add-CredsForMimikatz\") {\r\n                    Update-User-for-Constrained-Delegation -domainAdminCreds $DomainAdminCreds -userForCDelegation $previousUser -dcName $dcName -domainName $domainName\r\n                    $appliedAttacks += \"Update-User-for-Constrained-Delegation\"\r\n                }\r\n            }\r\n            \"Update-Computer-for-Constrained-Delegation\" {\r\n                if ($appliedAttacks -contains \"Set-LocalPrivEsc-BinPathWriteAccess\" -or $appliedAttacks -contains \"Set-UnquotedServicePathVulnerability\") {\r\n                    Update-Computer-for-Constrained-Delegation -domainAdminCreds $DomainAdminCreds -computerForCDelegation $targetBox -dcName $dcName -domainName $domainName\r\n                    $appliedAttacks += \"Update-Computer-for-Constrained-Delegation\"\r\n                }\r\n            }\r\n            \"Set-LocalPrivEsc-BinPathWriteAccess\" {\r\n                Set-LocalPrivEsc-BinPathWriteAccess -domainAdminCreds $DomainAdminCreds -targetUser $entryUser -domainName $domainName\r\n                $appliedAttacks += \"Set-LocalPrivEsc-BinPathWriteAccess\"\r\n            }\r\n            \"Set-UnquotedServicePathVulnerability\" {\r\n                Set-UnquotedServicePathVulnerability -domainAdminCreds $DomainAdminCreds -targetUser $entryUser\r\n                $appliedAttacks += \"Set-UnquotedServicePathVulnerability\"\r\n            }\r\n            \"Add-CredsForMimikatz\" {\r\n                if ($appliedAttacks -contains \"Set-LocalPrivEsc-BinPathWriteAccess\" -or $appliedAttacks -contains \"Set-UnquotedServicePathVulnerability\") {\r\n                    $mimikatzUser = Get-Random -InputObject ($randomUsers | Where-Object { $_ -ne $entryUser })\r\n                    Set-ADAccountPassword -Identity $mimikatzUser -NewPassword (ConvertTo-SecureString \"Password123\" -AsPlainText -Force) -Credential $DomainAdminCreds\r\n                    Add-CredsForMimikatz -userForMimikatz $mimikatzUser -singleUserPassword \"Password123\" -domainName $domainName -computerForMimikatz $targetBox\r\n                    $appliedAttacks += \"Add-CredsForMimikatz\"\r\n                    $previousUser = $mimikatzUser\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    # Log applied attacks\r\n    Add-Content -Path $logFilePath -Value \"GenerateRandomCTF: Successfully generated a random CTF with $($appliedAttacks.Count) attacks: $($appliedAttacks -join ', ')\"\r\n}\r\n\r\n\r\n\r\n",
                    "$fxv#10": "param(\n    [string]$domainName,                   # The FQDN of the domain to join (e.g., dev.build.lab or build.lab\n    [string]$domainAndEnterpriseAdminUsername,      # Domain admin user e.g., build\\admin\n    [string]$enterpriseAdminPassword                # Plain text password for domain join\n)\n\n\n[securestring]$enterpriseAdminPassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n[pscredential]$enterpriseAdminCreds = New-Object System.Management.Automation.PSCredential ($domainAndEnterpriseAdminUsername, $enterpriseAdminPassword)\n\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n\n# Ensure C:\\Temp directory exists\nif (!(Test-Path \"C:\\Temp\")) {\n    New-Item -ItemType Directory -Path \"C:\\Temp\" -Force | Out-Null\n}\n\nAdd-Content -Path $logFilePath -Value \"=== JoinDomain.ps1 Script Started ===\"\nAdd-Content -Path $logFilePath -Value \"Target domain: $domainName\"\n\n$joinedDomain = $false\n$maxAttempts = 10\n$attempt = 0\n\nwhile (!$joinedDomain -and $attempt -lt $maxAttempts){\n\t$attempt++\n\tAdd-Content -Path $logFilePath -Value \"Attempt $attempt of $maxAttempts to join domain...\"\n\n\ttry {\n\t\t# Join domain WITHOUT automatic restart to maintain run-command control\n\t\tAdd-Computer -DomainName $domainName -Credential $enterpriseAdminCreds -Force -ErrorAction Stop\n\t\tAdd-Content -Path $logFilePath -Value \"Add-Computer command completed successfully\"\n\n\t\t# Verify the join was successful\n\t\t$currentDomain = (Get-CimInstance Win32_ComputerSystem).Domain\n\t\tAdd-Content -Path $logFilePath -Value \"Current domain after join: $currentDomain\"\n\n\t\tif ($currentDomain -eq $domainName){\n\t\t\t$joinedDomain = $true\n\t\t\tAdd-Content -Path $logFilePath -Value \"Successfully joined domain $domainName\"\n\n\t\t\t# Now restart the computer for domain join to take full effect\n\t\t\tAdd-Content -Path $logFilePath -Value \"Restarting computer to complete domain join...\"\n\t\t\tRestart-Computer -Force\n\t\t\tbreak\n\t\t} else {\n\t\t\tAdd-Content -Path $logFilePath -Value \"Domain join command completed but domain is $currentDomain, not $domainName. Retrying...\"\n\t\t\tStart-Sleep -Seconds 30\n\t\t}\n\t} catch {\n\t\tAdd-Content -Path $logFilePath -Value \"Error joining the $domainName domain (attempt $attempt): $_\"\n\t\tAdd-Content -Path $logFilePath -Value \"Exception Type: $($_.Exception.GetType().FullName)\"\n\t\tStart-Sleep -Seconds 30\n\t}\n}\n\nif (!$joinedDomain) {\n\tAdd-Content -Path $logFilePath -Value \"FATAL: Failed to join domain after $maxAttempts attempts\"\n\texit 1\n}\n\nAdd-Content -Path $logFilePath -Value \"=== JoinDomain.ps1 Script Completed ===\"\n",
                    "$fxv#11": "param(\n\t[string]$enterpriseAdminUsername,\n\t[string]$enterpriseAdminPassword\n)\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n\n# Ensure C:\\Temp directory exists\nif (!(Test-Path \"C:\\Temp\")) {\n    New-Item -ItemType Directory -Path \"C:\\Temp\" -Force | Out-Null\n}\n\ntry {\n    Add-Content -Path $logFilePath -Value \"=== ConfigureCA.ps1 Script Started ===\"\n    Add-Content -Path $logFilePath -Value \"Received username: $enterpriseAdminUsername\"\n    Add-Content -Path $logFilePath -Value \"Password received: $($enterpriseAdminPassword.Length) characters\"\n\n    Add-Content -Path $logFilePath -Value \"Creating credentials...\"\n    [securestring]$secureEnterpriseAdminPassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n    [pscredential]$enterpriseAdminCreds = New-Object System.Management.Automation.PSCredential ($enterpriseAdminUsername, $secureEnterpriseAdminPassword)\n    Add-Content -Path $logFilePath -Value \"Credentials created successfully\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"FATAL: Failed to create credentials. $_\"\n    exit 1\n}\n\ntry {\n    Add-Content -Path $logFilePath -Value \"Installing ADCS Windows Feature...\"\n    Add-WindowsFeature Adcs-Cert-Authority -IncludeManagementTools\n    Add-Content -Path $logFilePath -Value \"ADCS Windows Feature installed\"\n\n    Add-Content -Path $logFilePath -Value \"Installing ADCS Certification Authority...\"\n    Install-AdcsCertificationAuthority -CAType EnterpriseRootCA -Credential $enterpriseAdminCreds -Force\n    Add-Content -Path $logFilePath -Value \"Successfully Installed ADCS.\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"Failed Installing ADCS. $_\"\n    Add-Content -Path $logFilePath -Value \"Exception Type: $($_.Exception.GetType().FullName)\"\n}\ntry {\n    Add-Content -Path $logFilePath -Value \"Installing ADLDS Windows Feature...\"\n    Install-WindowsFeature ADLDS -IncludeManagementTools\n    Add-Content -Path $logFilePath -Value \"Successfully Installed ADLDS.\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"Failed installing ADLDS. $_\"\n}\n\nAdd-Content -Path $logFilePath -Value \"=== ConfigureCA.ps1 Script Completed ===\"\n",
                    "$fxv#2": "dn: CN=ESC1Vuln,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\nchangetype: add\ncn: ESC1Vuln\ndisplayName: ESC1Vuln\ndistinguishedName: \n CN=ESC1Vuln,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Con\n figuration,DC=redteam,DC=lab\ndSCorePropagationData: 20240207204330.0Z\ndSCorePropagationData: 16010101000000.0Z\ndSCorePropagationData: 17130709023336.0Z\nflags: 131649\ninstanceType: 4\nmsPKI-Cert-Template-OID: \n 1.3.6.1.4.1.311.21.8.1958530.2366506.14305465.6392049.15594681.131.12125312.52\n 91900\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.1\nmsPKI-Certificate-Name-Flag: 134217729\nmsPKI-Enrollment-Flag: 0\nmsPKI-Minimal-Key-Size: 2048\nmsPKI-Private-Key-Flag: 16842752\nmsPKI-RA-Signature: 0\nmsPKI-Template-Minor-Revision: 5\nmsPKI-Template-Schema-Version: 2\nname: ESC1Vuln\nobjectCategory: \n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\nobjectClass: top\nobjectClass: pKICertificateTemplate\npKICriticalExtensions: 2.5.29.15\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\npKIDefaultKeySpec: 1\npKIExpirationPeriod:: AIByDl3C/f8=\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.2\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.1\npKIKeyUsage:: oAA=\npKIMaxIssuingDepth: 0\npKIOverlapPeriod:: AICmCv/e//8=\nrevision: 100\nshowInAdvancedViewOnly: TRUE\nuSNChanged: 45189\nuSNCreated: 45157\nwhenChanged: 20240207204332.0Z\nwhenCreated: 20240207203957.0Z\n\n",
                    "$fxv#3": "dn: CN=ESC1Vuln,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\nchangetype: modify\nreplace:nTSecurityDescriptor\nnTSecurityDescriptor:: \n AQAEjNgAAAD0AAAAAAAAABQAAAAEAMQABgAAAAUAKAAAAQAAAQAAAGjJEA77eNIRkNQAwE953FUBAQ\n AAAAAABQsAAAAAACQA/wEPAAEFAAAAAAAFFQAAAIVrTN0IKzmH3Rhi7QACAAAAABQAlAACAAEBAAAA\n AAAFCwAAAAAAFAD/AQ8AAQEAAAAAAAUSAAAAABIkAP8BDwABBQAAAAAABRUAAACFa0zdCCs5h90YYu\n 0HAgAAABIkAL0BDwABBQAAAAAABRUAAACFa0zdCCs5h90YYu0AAgAAAQUAAAAAAAUVAAAAhWtM3Qgr\n OYfdGGLtBwIAAAEFAAAAAAAFFQAAAIVrTN0IKzmH3Rhi7QcCAAA=\n-\n\n",
                    "$fxv#4": "dn: CN=ESC3VulnAuthSignatures,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: add\r\ncn: ESC3VulnAuthSignatures\r\ndisplayName: ESC3VulnAuthSignatures\r\ndistinguishedName: \r\n CN=ESC3VulnAuthSignatures,CN=Certificate Templates,CN=Public Key Servic\r\n es,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\ndSCorePropagationData: 16010101000000.0Z\r\nflags: 131649\r\ninstanceType: 4\r\nmsPKI-Cert-Template-OID: \r\n 1.3.6.1.4.1.311.21.8.1958530.2366506.14305465.6392049.15594681.131.12906934.52\r\n 08534\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\r\nmsPKI-Certificate-Name-Flag: 33554432\r\nmsPKI-Enrollment-Flag: 32\r\nmsPKI-Minimal-Key-Size: 2048\r\nmsPKI-Private-Key-Flag: 16842752\r\nmsPKI-RA-Application-Policies: 1.3.6.1.4.1.311.20.2.1\r\nmsPKI-RA-Signature: 1\r\nmsPKI-Template-Minor-Revision: 6\r\nmsPKI-Template-Schema-Version: 2\r\nname: ESC3VulnAuthSignatures\r\nobjectCategory: \r\n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\r\nobjectClass: top\r\nobjectClass: pKICertificateTemplate\r\npKICriticalExtensions: 2.5.29.15\r\npKICriticalExtensions: 2.5.29.7\r\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\r\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\r\npKIDefaultKeySpec: 1\r\npKIExpirationPeriod:: AIByDl3C/f8=\r\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.2\r\npKIKeyUsage:: oAA=\r\npKIMaxIssuingDepth: 0\r\npKIOverlapPeriod:: AICmCv/e//8=\r\nrevision: 100\r\nshowInAdvancedViewOnly: TRUE\r\nuSNChanged: 45209\r\nuSNCreated: 45207\r\nwhenChanged: 20240213221056.0Z\r\nwhenCreated: 20240213221055.0Z\r\n\r\n",
                    "$fxv#5": "dn: CN=ESC3VulnRequestAgent,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: modify\r\nreplace:nTSecurityDescriptor\r\nnTSecurityDescriptor:: \r\n AQAEnDQBAABQAQAAAAAAABQAAAAEACABBwAAAAUAOAAwAQAAAQAAAGjJEA77eNIRkNQAwE953FUBBQ\r\n AAAAAABRUAAACFa0zdCCs5h90YYu0AAgAABQA4ADABAAABAAAAaMkQDvt40hGQ1ADAT3ncVQEFAAAA\r\n AAAFFQAAAIVrTN0IKzmH3Rhi7QcCAAAFACgAAAEAAAEAAABoyRAO+3jSEZDUAMBPedxVAQEAAAAAAA\r\n ULAAAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu0AAgAAAAAkAP8ADwABBQAAAAAABRUA\r\n AACFa0zdCCs5h90YYu0HAgAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAAAUAJ\r\n QAAgABAQAAAAAABQsAAAABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAQUAAAAAAAUVAAAAhWtM\r\n 3QgrOYfdGGLtBwIAAA==\r\n-\r\n",
                    "$fxv#6": "dn: CN=ESC4VulnWrite,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: add\r\ncn: ESC4VulnWrite\r\ndisplayName: ESC4VulnWrite\r\ndistinguishedName:\r\n CN=ESC4VulnWrite,CN=Certificate Templates,CN=Public Key Services,CN=Services,C\r\n N=Configuration,DC=redteam,DC=lab\r\ndSCorePropagationData: 20240214220029.0Z\r\ndSCorePropagationData: 16010101000000.0Z\r\nflags: 131649\r\ninstanceType: 4\r\nmsPKI-Cert-Template-OID:\r\n 1.3.6.1.4.1.311.21.8.7095186.10767367.6704308.10313546.8444657.192.8811968.127\r\n 77348\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.1\r\nmsPKI-Certificate-Name-Flag: 134217728\r\nmsPKI-Enrollment-Flag: 2\r\nmsPKI-Minimal-Key-Size: 2048\r\nmsPKI-Private-Key-Flag: 16842752\r\nmsPKI-RA-Signature: 0\r\nmsPKI-Template-Minor-Revision: 5\r\nmsPKI-Template-Schema-Version: 2\r\nname: ESC4VulnWrite\r\nobjectCategory:\r\n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\r\nobjectClass: top\r\nobjectClass: pKICertificateTemplate\r\npKICriticalExtensions: 2.5.29.15\r\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\r\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\r\npKIDefaultKeySpec: 1\r\npKIExpirationPeriod:: AIByDl3C/f8=\r\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.2\r\npKIExtendedKeyUsage: 1.3.6.1.5.5.7.3.1\r\npKIKeyUsage:: oAA=\r\npKIMaxIssuingDepth: 0\r\npKIOverlapPeriod:: AICmCv/e//8=\r\nrevision: 100\r\nshowInAdvancedViewOnly: TRUE\r\nuSNChanged: 16495\r\nuSNCreated: 16443\r\nwhenChanged: 20240214220029.0Z\r\nwhenCreated: 20240214214918.0Z\r\n\r\n",
                    "$fxv#7": "dn: CN=ESC3VulnRequestAgent,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: add\r\ncn: ESC3VulnRequestAgent\r\ndisplayName: ESC3VulnRequestAgent\r\ndistinguishedName: \r\n CN=ESC3VulnRequestAgent,CN=Certificate Templates,CN=Public Key Services\r\n ,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\ndSCorePropagationData: 20240213215736.0Z\r\ndSCorePropagationData: 16010101000000.0Z\r\nflags: 131649\r\ninstanceType: 4\r\nmsPKI-Cert-Template-OID: \r\n 1.3.6.1.4.1.311.21.8.1958530.2366506.14305465.6392049.15594681.131.12316097.88\r\n 85348\r\nmsPKI-Certificate-Application-Policy: 1.3.6.1.4.1.311.20.2.1\r\nmsPKI-Certificate-Name-Flag: 33554432\r\nmsPKI-Enrollment-Flag: 32\r\nmsPKI-Minimal-Key-Size: 2048\r\nmsPKI-Private-Key-Flag: 16842752\r\nmsPKI-RA-Signature: 0\r\nmsPKI-Template-Minor-Revision: 4\r\nmsPKI-Template-Schema-Version: 2\r\nname: ESC3VulnRequestAgent\r\nobjectCategory: \r\n CN=PKI-Certificate-Template,CN=Schema,CN=Configuration,DC=redteam,DC=lab\r\nobjectClass: top\r\nobjectClass: pKICertificateTemplate\r\npKICriticalExtensions: 2.5.29.7\r\npKICriticalExtensions: 2.5.29.15\r\npKIDefaultCSPs: 2,Microsoft DH SChannel Cryptographic Provider\r\npKIDefaultCSPs: 1,Microsoft RSA SChannel Cryptographic Provider\r\npKIDefaultKeySpec: 1\r\npKIExpirationPeriod:: AIByDl3C/f8=\r\npKIExtendedKeyUsage: 1.3.6.1.4.1.311.20.2.1\r\npKIKeyUsage:: oAA=\r\npKIMaxIssuingDepth: 0\r\npKIOverlapPeriod:: AICmCv/e//8=\r\nrevision: 100\r\nshowInAdvancedViewOnly: TRUE\r\nuSNChanged: 45157\r\nuSNCreated: 45150\r\nwhenChanged: 20240213220051.0Z\r\nwhenCreated: 20240213215724.0Z\r\n\r\n",
                    "$fxv#8": "dn: CN=ESC3VulnAuthSignatures,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: modify\r\nreplace:nTSecurityDescriptor\r\nnTSecurityDescriptor:: \r\n AQAEnDQBAABQAQAAAAAAABQAAAAEACABBwAAAAUAOAAwAQAAAQAAAGjJEA77eNIRkNQAwE953FUBBQ\r\n AAAAAABRUAAACFa0zdCCs5h90YYu0AAgAABQA4ADABAAABAAAAaMkQDvt40hGQ1ADAT3ncVQEFAAAA\r\n AAAFFQAAAIVrTN0IKzmH3Rhi7QcCAAAFACgAAAEAAAEAAABoyRAO+3jSEZDUAMBPedxVAQEAAAAAAA\r\n ULAAAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu0AAgAAAAAkAP8ADwABBQAAAAAABRUA\r\n AACFa0zdCCs5h90YYu0HAgAAAAAkAP8ADwABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAAAUAJ\r\n QAAgABAQAAAAAABQsAAAABBQAAAAAABRUAAACFa0zdCCs5h90YYu1PBAAAAQUAAAAAAAUVAAAAhWtM\r\n 3QgrOYfdGGLtBwIAAA==\r\n-\r\n",
                    "$fxv#9": "dn: CN=ESC4VulnWrite,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=redteam,DC=lab\r\nchangetype: modify\r\nreplace:nTSecurityDescriptor\r\nnTSecurityDescriptor:: \r\n AQAEnDQBAABQAQAAAAAAABQAAAAEACABBwAAAAYAKAAAAQAAAQAAAMKMW6C8FwJIpxDnwVq4ZqIBAQ\r\n AAAAAABQsAAAAFADgAMAEAAAEAAABoyRAO+3jSEZDUAMBPedxVAQUAAAAAAAUVAAAAX/H53KXtdAw6\r\n 4UyHAAIAAAUAOAAwAQAAAQAAAGjJEA77eNIRkNQAwE953FUBBQAAAAAABRUAAABf8fncpe10DDrhTI\r\n cHAgAAAAAkAP8ADwABBQAAAAAABRUAAABf8fncpe10DDrhTIcAAgAAAAAkAP8ADwABBQAAAAAABRUA\r\n AABf8fncpe10DDrhTIcHAgAAAAAkAP8ADwABBQAAAAAABRUAAABf8fncpe10DDrhTIf0AQAAAAAUAL\r\n QADgABAQAAAAAABQsAAAABBQAAAAAABRUAAABf8fncpe10DDrhTIf0AQAAAQUAAAAAAAUVAAAAX/H5\r\n 3KXtdAw64UyHBwIAAA==\r\n-\r\n\r\n",
                    "isIP10": "[startsWith(parameters('privateIPAddress'), '10.10.')]",
                    "isIP172": "[startsWith(parameters('privateIPAddress'), '172.16.')]",
                    "isIP192": "[startsWith(parameters('privateIPAddress'), '192.168.')]",
                    "vName": "[if(parameters('oldScenarios'), 'lab-network', if(variables('isIP10'), 'vnet-10', if(variables('isIP172'), 'vnet-172', 'vnet-192')))]",
                    "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(variables('isIP10'), 'vnet-10/subnet-10', if(variables('isIP172'), 'vnet-172/subnet-172', 'vnet-192/subnet-192')))]",
                    "currentNetwork": "[if(startsWith(parameters('privateIPAddress'), '10.10.'), '10', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172', '192'))]",
                    "dcNetwork": "[if(startsWith(parameters('rootDomainControllerPrivateIp'), '10.10.'), '10', if(startsWith(parameters('rootDomainControllerPrivateIp'), '172.16.'), '172', '192'))]",
                    "requiresPeering": "[and(and(not(empty(parameters('rootDomainControllerPrivateIp'))), not(equals(variables('currentNetwork'), variables('dcNetwork')))), not(parameters('skipPeering')))]",
                    "jumpboxNetwork": "[if(empty(parameters('jumpboxPrivateIPAddress')), '00', if(startsWith(parameters('jumpboxPrivateIPAddress'), '10.10.'), '10', if(startsWith(parameters('jumpboxPrivateIPAddress'), '172.16.'), '172', '192')))]",
                    "isJumpbox": "[if(and(and(and(not(empty(parameters('privateIPAddress'))), not(empty(parameters('connectedPrivateIPAddress')))), not(empty(variables('currentNetwork')))), not(empty(variables('jumpboxNetwork')))), and(equals(parameters('privateIPAddress'), parameters('connectedPrivateIPAddress')), not(equals(variables('currentNetwork'), variables('jumpboxNetwork')))), false())]",
                    "caPeeringRules": "[if(variables('requiresPeering'), createArray(createObject('name', 'Allow-DC-to-CA-Inbound', 'properties', createObject('description', 'Allows inbound traffic from Domain Controller', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('rootDomainControllerPrivateIp'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 100, 'direction', 'Inbound')), createObject('name', 'Allow-CA-to-DC-Outbound', 'properties', createObject('description', 'Allows outbound traffic to Domain Controller', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('privateIPAddress'), 'destinationAddressPrefix', parameters('rootDomainControllerPrivateIp'), 'access', 'Allow', 'priority', 100, 'direction', 'Outbound')), createObject('name', 'Allow-IntraSubnet-Inbound', 'properties', createObject('description', 'Allows all inbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Inbound')), createObject('name', 'Allow-IntraSubnet-Outbound', 'properties', createObject('description', 'Allows all outbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Outbound')), createObject('name', 'Deny-CrossSubnet-Inbound', 'properties', createObject('description', 'Denies all other inbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('rootDomainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('rootDomainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Inbound')), createObject('name', 'Deny-CrossSubnet-Outbound', 'properties', createObject('description', 'Denies all other outbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('privateIPAddress'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('privateIPAddress'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('rootDomainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('rootDomainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Outbound'))), createArray())]",
                    "jumpboxRules": "[if(variables('isJumpbox'), createArray(createObject('name', 'Allow-Jumpbox-Communication-Inbound', 'properties', createObject('description', 'Allows inbound traffic from jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 150, 'direction', 'Inbound')), createObject('name', 'Allow-Jumpbox-Communication-Outbound', 'properties', createObject('description', 'Allows outbound traffic to jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('privateIPAddress'), 'destinationAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'access', 'Allow', 'priority', 150, 'direction', 'Outbound'))), createArray())]",
                    "publicIPRules": "[if(parameters('hasPublicIP'), createArray(createObject('name', 'Allow-RDP-From-Public', 'properties', createObject('description', 'Allows RDP from caller IP', 'protocol', 'Tcp', 'sourcePortRange', '*', 'destinationPortRange', '3389', 'sourceAddressPrefix', parameters('callerIPAddress'), 'destinationAddressPrefix', parameters('privateIPAddress'), 'access', 'Allow', 'priority', 102, 'direction', 'Inbound'))), createArray())]",
                    "allNSGRules": "[concat(variables('caPeeringRules'), variables('jumpboxRules'), variables('publicIPRules'))]"
                  },
                  "resources": [
                    {
                      "condition": "[not(empty(variables('allNSGRules')))]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2023-05-01",
                      "name": "[format('ca-nsg-{0}', parameters('virtualMachineHostname'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "securityRules": "[variables('allNSGRules')]"
                      }
                    },
                    {
                      "condition": "[parameters('hasPublicIP')]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}-pip', parameters('virtualMachineHostname'))]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Basic"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic",
                        "dnsSettings": {
                          "domainNameLabel": "[toLower(format('{0}-{1}', parameters('virtualMachineHostname'), uniqueString(resourceGroup().id)))]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}-NIC', parameters('virtualMachineHostname'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "dnsSettings": {
                          "dnsServers": [
                            "[parameters('rootDomainControllerPrivateIp')]",
                            "8.8.8.8"
                          ]
                        },
                        "ipConfigurations": [
                          {
                            "name": "ipconfigCA",
                            "properties": {
                              "privateIPAllocationMethod": "Static",
                              "privateIPAddress": "[parameters('privateIPAddress')]",
                              "subnet": {
                                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', split(variables('subnetName'), '/')[0], split(variables('subnetName'), '/')[1])]"
                              },
                              "publicIPAddress": "[if(parameters('hasPublicIP'), createObject('id', resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('virtualMachineHostname')))), null())]"
                            }
                          }
                        ],
                        "networkSecurityGroup": "[if(not(empty(variables('allNSGRules'))), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', format('ca-nsg-{0}', parameters('virtualMachineHostname')))), null())]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', format('ca-nsg-{0}', parameters('virtualMachineHostname')))]",
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('virtualMachineHostname')))]"
                      ]
                    },
                    {
                      "condition": "[variables('requiresPeering')]",
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2023-05-01",
                      "name": "[format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('dcNetwork'))]",
                      "properties": {
                        "allowVirtualNetworkAccess": true,
                        "allowForwardedTraffic": true,
                        "allowGatewayTransit": true,
                        "useRemoteGateways": false,
                        "remoteVirtualNetwork": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('dcNetwork')))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                      ]
                    },
                    {
                      "condition": "[variables('requiresPeering')]",
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2023-05-01",
                      "name": "[format('vnet-{0}/peer-to-{1}', variables('dcNetwork'), variables('currentNetwork'))]",
                      "properties": {
                        "allowVirtualNetworkAccess": true,
                        "allowForwardedTraffic": true,
                        "allowGatewayTransit": true,
                        "useRemoteGateways": false,
                        "remoteVirtualNetwork": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('currentNetwork')))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('dcNetwork')), '/')[0], split(format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('dcNetwork')), '/')[1])]"
                      ]
                    },
                    {
                      "condition": "[variables('isJumpbox')]",
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2023-05-01",
                      "name": "[format('vnet-{0}/peer-to-{1}', variables('currentNetwork'), variables('jumpboxNetwork'))]",
                      "properties": {
                        "allowVirtualNetworkAccess": true,
                        "allowForwardedTraffic": true,
                        "allowGatewayTransit": true,
                        "useRemoteGateways": false,
                        "remoteVirtualNetwork": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('jumpboxNetwork')))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('deployOrBuild'), 'deploy')]",
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-07-01",
                      "name": "[parameters('virtualMachineHostname')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "VM": "[format('CA:{0}', parameters('resourceGroupName'))]"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('virtualMachineSize')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "id": "[parameters('imageReference')]"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2023-07-01",
                      "name": "[parameters('virtualMachineHostname')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "VM": "[format('CA:{0}', parameters('resourceGroupName'))]"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('virtualMachineSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "createOption": "fromImage",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            }
                          },
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2022-datacenter-g2",
                            "version": "latest"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('virtualMachineHostname')]",
                          "adminUsername": "[parameters('localAdminUsername')]",
                          "adminPassword": "[parameters('localAdminPassword')]",
                          "windowsConfiguration": {
                            "provisionVMAgent": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'setupConfigurationFilesCA')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "targetFiles",
                            "value": "module,esc"
                          },
                          {
                            "name": "domainName",
                            "value": "[parameters('domainName')]"
                          }
                        ],
                        "source": {
                          "script": "[replace(replace(replace(replace(replace(replace(replace(replace(replace(variables('$fxv#0'), '__MODULE_CONTENT_PLACEHOLDER__', variables('$fxv#1')), '__ESC1_VULN_PLACEHOLDER__', variables('$fxv#2')), '__ESC1_VULN_SD_PLACEHOLDER__', variables('$fxv#3')), '__ESC3_AUTH_SIG_PLACEHOLDER__', variables('$fxv#4')), '__ESC3_REQ_AGENT_SD_PLACEHOLDER__', variables('$fxv#5')), '__ESC4_VULN_PLACEHOLDER__', variables('$fxv#6')), '__ESC3_REQ_AGENT_PLACEHOLDER__', variables('$fxv#7')), '__ESC3_AUTH_SIG_SD_PLACEHOLDER__', variables('$fxv#8')), '__ESC4_VULN_SD_PLACEHOLDER__', variables('$fxv#9'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'JoinDomain')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "domainAndEnterpriseAdminUsername",
                            "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                          },
                          {
                            "name": "enterpriseAdminPassword",
                            "value": "[parameters('enterpriseAdminPassword')]"
                          },
                          {
                            "name": "domainName",
                            "value": "[parameters('domainName')]"
                          }
                        ],
                        "source": {
                          "script": "[variables('$fxv#10')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'setupConfigurationFilesCA')]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'CertificateAuthorityConfigurationScript')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "parameters": [
                          {
                            "name": "enterpriseAdminUsername",
                            "value": "[parameters('domainAndEnterpriseAdminUsername')]"
                          },
                          {
                            "name": "enterpriseAdminPassword",
                            "value": "[parameters('enterpriseAdminPassword')]"
                          }
                        ],
                        "source": {
                          "script": "[variables('$fxv#11')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'JoinDomain')]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "generatedRootDCModules"
              ]
            },
            "generatedStandaloneModules": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "GeneratedStandaloneModules",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "windowsVmSize": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "vmDiskType": {
                    "value": "[parameters('vmDiskType')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "domainAndEnterpriseAdminUsername": {
                    "value": "[variables('domainAndEnterpriseAdminUsername')]"
                  },
                  "enterpriseAdminPassword": {
                    "value": "[parameters('enterpriseAdminPassword')]"
                  },
                  "deployOrBuild": {
                    "value": "[parameters('deployOrBuild')]"
                  },
                  "jumpboxPrivateIPAddress": {
                    "value": "[parameters('jumpboxPrivateIPAddress')]"
                  },
                  "connectedPrivateIPAddress": {
                    "value": "[parameters('connectedPrivateIPAddress')]"
                  },
                  "isVNet10Required": {
                    "value": "[variables('isVNet10Required')]"
                  },
                  "isVNet172Required": {
                    "value": "[variables('isVNet172Required')]"
                  },
                  "isVNet192Required": {
                    "value": "[variables('isVNet192Required')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "14816379723210790884"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "windowsVmSize": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vmDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainAndEnterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "deployOrBuild": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainNetBIOSName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllerFQDN": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "subDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "callerIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainControllerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "jumpboxPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "connectedPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "isVNet10Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet192Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet172Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "kaliSku": {
                      "type": "string",
                      "defaultValue": "kali-2025-2"
                    },
                    "hasPublicIP": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "resources": []
                }
              },
              "dependsOn": [
                "generatedSubDCModules"
              ]
            },
            "generatedJumpboxModules": {
              "condition": "[greater(length(parameters('jumpboxConfig')), 0)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "GeneratedJumpboxModules",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "resourceGroupName": {
                    "value": "[parameters('resourceGroupName')]"
                  },
                  "deployOrBuild": {
                    "value": "[parameters('deployOrBuild')]"
                  },
                  "isVNet10Required": {
                    "value": "[variables('isVNet10Required')]"
                  },
                  "isVNet172Required": {
                    "value": "[variables('isVNet172Required')]"
                  },
                  "isVNet192Required": {
                    "value": "[variables('isVNet192Required')]"
                  },
                  "kaliSku": {
                    "value": "[parameters('kaliSku')]"
                  },
                  "jumpboxPrivateIPAddress": {
                    "value": "[parameters('jumpboxConfig')[0].jumpboxPrivateIPAddress]"
                  },
                  "connectedPrivateIPAddress": {
                    "value": "[parameters('jumpboxConfig')[0].connectedPrivateIPAddress]"
                  },
                  "osDiskType": {
                    "value": "[parameters('vmDiskType')]"
                  },
                  "jumpboxAdminUsername": {
                    "value": "redteamer"
                  },
                  "jumpboxAdminPassword": {
                    "value": "Password#123"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "7153505810221126992"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "windowsVmSize": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "vmDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainAndEnterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "enterpriseAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "deployOrBuild": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainNetBIOSName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllerFQDN": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "rootDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "subDomainControllers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "standaloneServerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "callerIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainControllerPrivateIp": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "oldScenarios": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "jumpboxPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "connectedPrivateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "isVNet10Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet192Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "isVNet172Required": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "osDiskType": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminUsername": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "jumpboxAdminPassword": {
                      "type": "securestring",
                      "defaultValue": ""
                    },
                    "kaliSku": {
                      "type": "string",
                      "defaultValue": "kali-2025-2"
                    },
                    "hasPublicIP": {
                      "type": "bool",
                      "defaultValue": false
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "Jumpbox",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "vmName": {
                            "value": "BuildJumpbox"
                          },
                          "vmSize": {
                            "value": "Standard_B2s"
                          },
                          "resourceGroupName": {
                            "value": "[parameters('resourceGroupName')]"
                          },
                          "jumpboxPrivateIPAddress": {
                            "value": "10.10.0.10"
                          },
                          "osDiskType": {
                            "value": "[parameters('vmDiskType')]"
                          },
                          "deployOrBuild": {
                            "value": "build"
                          },
                          "oldScenarios": {
                            "value": "[parameters('oldScenarios')]"
                          },
                          "connectedPrivateIPAddress": {
                            "value": "[parameters('connectedPrivateIPAddress')]"
                          },
                          "isVNet10Required": {
                            "value": "[parameters('isVNet10Required')]"
                          },
                          "isVNet192Required": {
                            "value": "[parameters('isVNet192Required')]"
                          },
                          "isVNet172Required": {
                            "value": "[parameters('isVNet172Required')]"
                          },
                          "jumpboxAdminUsername": {
                            "value": "redteamer"
                          },
                          "jumpboxAdminPassword": {
                            "value": "Password#123"
                          },
                          "kaliSku": {
                            "value": "kali-2025-4"
                          },
                          "callerIPAddress": {
                            "value": "35.139.98.68"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.24.24.22086",
                              "templateHash": "15874120280308459737"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Location for resources to be deployed"
                              }
                            },
                            "vmName": {
                              "type": "string",
                              "metadata": {
                                "description": "VM Name"
                              }
                            },
                            "vmSize": {
                              "type": "string",
                              "metadata": {
                                "description": "VM Size"
                              }
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Resouce group name to deploy to"
                              }
                            },
                            "referenceID": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "jumpboxPrivateIPAddress": {
                              "type": "string",
                              "defaultValue": "10.10.0.45",
                              "metadata": {
                                "description": "Private IP Address for the Jumpbox"
                              }
                            },
                            "connectedPrivateIPAddress": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Connected Private IP Address for peering"
                              }
                            },
                            "deployOrBuild": {
                              "type": "string",
                              "defaultValue": "build"
                            },
                            "osDiskType": {
                              "type": "string",
                              "defaultValue": "Standard_LRS"
                            },
                            "kaliSku": {
                              "type": "string",
                              "defaultValue": "kali-2025-2",
                              "metadata": {
                                "description": "Kali Linux SKU version (e.g., kali-2025-2)"
                              }
                            },
                            "imageReference": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Image reference ID for custom Jumpbox snapshot (optional - if provided, uses snapshot instead of marketplace)"
                              }
                            },
                            "oldScenarios": {
                              "type": "bool",
                              "defaultValue": false,
                              "metadata": {
                                "description": "Flag for old scenarios"
                              }
                            },
                            "isVNet10Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "isVNet172Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "isVNet192Required": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "jumpboxAdminUsername": {
                              "type": "string",
                              "defaultValue": "redteamer"
                            },
                            "jumpboxAdminPassword": {
                              "type": "securestring",
                              "defaultValue": "Password#123"
                            },
                            "callerIPAddress": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "IP address of the caller initiating the build - will be granted full access"
                              }
                            }
                          },
                          "variables": {
                            "$fxv#0": "#cloud-config\nwrite_files:\n  - path: /usr/local/bin/jumpbox-setup.sh\n    permissions: \"0755\"\n    owner: root:root\n    content: |\n      #!/bin/bash\n      set -e\n      export DEBIAN_FRONTEND=noninteractive\n\n      LOGFILE=\"/var/log/kali-provisioning.log\"\n      exec > >(tee -a \"$LOGFILE\") 2>&1\n\n      apt-get update\n      apt-get upgrade -y\n\n      apt-get install -y kali-desktop-xfce kali-system-gui xserver-xorg xfce4 xfce4-goodies\n      apt-get install -y kali-linux-default\n      apt-get install -y docker.io docker-compose rdesktop freerdp3-x11 xrdp\n\n      # Configure and start xrdp\n      systemctl enable xrdp\n      systemctl start xrdp\n\n      # Allow console login for xrdp\n      echo \"allowed_users=anybody\" > /etc/X11/Xwrapper.config\n\n      mkdir -p /opt/bloodhoundce\n      wget https://github.com/SpecterOps/bloodhound-cli/releases/latest/download/bloodhound-cli-linux-amd64.tar.gz -O /opt/bloodhoundce/bloodhound-cli-linux-amd64.tar.gz\n      tar -xf /opt/bloodhoundce/bloodhound-cli-linux-amd64.tar.gz -C /opt/bloodhoundce\n      /opt/bloodhoundce/bloodhound-cli install\n      /opt/bloodhoundce/bloodhound-cli config get default_password > /opt/bloodhoundce/admin-password.txt\n\nruncmd:\n  - [bash, /usr/local/bin/jumpbox-setup.sh]\n",
                            "$fxv#1": "#cloud-config\nwrite_files:\n  - path: /usr/local/bin/jumpbox-setup.sh\n    permissions: \"0755\"\n    owner: root:root\n    content: |\n      #!/bin/bash\n      set -e\n      export DEBIAN_FRONTEND=noninteractive\n\n      LOGFILE=\"/var/log/kali-provisioning.log\"\n      exec > >(tee -a \"$LOGFILE\") 2>&1\n\n      apt-get update\n      apt-get upgrade -y\n\n      apt-get install -y kali-desktop-xfce kali-system-gui xserver-xorg xfce4 xfce4-goodies\n      apt-get install -y kali-linux-default\n      apt-get install -y docker.io docker-compose rdesktop freerdp3-x11 xrdp\n\n      # Configure and start xrdp\n      systemctl enable xrdp\n      systemctl start xrdp\n\n      # Allow console login for xrdp\n      echo \"allowed_users=anybody\" > /etc/X11/Xwrapper.config\n\n      mkdir -p /opt/bloodhoundce\n      wget https://github.com/SpecterOps/bloodhound-cli/releases/latest/download/bloodhound-cli-linux-amd64.tar.gz -O /opt/bloodhoundce/bloodhound-cli-linux-amd64.tar.gz\n      tar -xf /opt/bloodhoundce/bloodhound-cli-linux-amd64.tar.gz -C /opt/bloodhoundce\n      /opt/bloodhoundce/bloodhound-cli install\n      /opt/bloodhoundce/bloodhound-cli config get default_password > /opt/bloodhoundce/admin-password.txt\n\nruncmd:\n  - [bash, /usr/local/bin/jumpbox-setup.sh]\n",
                            "isIP10": "[startsWith(parameters('jumpboxPrivateIPAddress'), '10.10.')]",
                            "isIP172": "[startsWith(parameters('jumpboxPrivateIPAddress'), '172.16.')]",
                            "isIP192": "[startsWith(parameters('jumpboxPrivateIPAddress'), '192.168.')]",
                            "vName": "[if(parameters('oldScenarios'), 'lab-network', if(variables('isIP10'), 'vnet-10', if(variables('isIP172'), 'vnet-172', 'vnet-192')))]",
                            "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(variables('isIP10'), 'vnet-10/subnet-10', if(variables('isIP172'), 'vnet-172/subnet-172', 'vnet-192/subnet-192')))]",
                            "jumpboxNetwork": "[if(parameters('oldScenarios'), '', if(startsWith(parameters('jumpboxPrivateIPAddress'), '10.10.'), '10', if(startsWith(parameters('jumpboxPrivateIPAddress'), '172.16.'), '172', '192')))]",
                            "connectedNetwork": "[if(parameters('oldScenarios'), '', if(startsWith(parameters('connectedPrivateIPAddress'), '10.10.'), '10', if(startsWith(parameters('connectedPrivateIPAddress'), '172.16.'), '172', '192')))]",
                            "requiresPeering": "[if(parameters('oldScenarios'), false(), not(equals(variables('jumpboxNetwork'), variables('connectedNetwork'))))]",
                            "oldScenarioIP": "[if(parameters('oldScenarios'), '10.10.0.37', '')]",
                            "privateIPAddress": "[if(parameters('oldScenarios'), variables('oldScenarioIP'), parameters('jumpboxPrivateIPAddress'))]",
                            "baseSecurityRules": [
                              {
                                "name": "Inbound-SSH-from-Caller",
                                "properties": {
                                  "description": "Allows SSH access from the caller IP address",
                                  "protocol": "TCP",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "22",
                                  "sourceAddressPrefix": "[if(not(empty(parameters('callerIPAddress'))), parameters('callerIPAddress'), '0.0.0.0/0')]",
                                  "destinationAddressPrefix": "*",
                                  "access": "Allow",
                                  "priority": 100,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "Inbound-RDP-from-Caller",
                                "properties": {
                                  "description": "Allows RDP access from the caller IP address",
                                  "protocol": "TCP",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "3389",
                                  "sourceAddressPrefix": "[if(not(empty(parameters('callerIPAddress'))), parameters('callerIPAddress'), '0.0.0.0/0')]",
                                  "destinationAddressPrefix": "*",
                                  "access": "Allow",
                                  "priority": 101,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "Outbound-Internet-Access",
                                "properties": {
                                  "description": "Allows outbound internet access for apt-install and updates",
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "*",
                                  "sourceAddressPrefix": "*",
                                  "destinationAddressPrefix": "Internet",
                                  "access": "Allow",
                                  "priority": 100,
                                  "direction": "Outbound"
                                }
                              }
                            ],
                            "peeringSecurityRules": [
                              {
                                "name": "Allow-ConnectedIP-All-Inbound",
                                "properties": {
                                  "description": "Allows all inbound traffic from connected private IP",
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "*",
                                  "sourceAddressPrefix": "[parameters('connectedPrivateIPAddress')]",
                                  "destinationAddressPrefix": "[parameters('jumpboxPrivateIPAddress')]",
                                  "access": "Allow",
                                  "priority": 105,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "Allow-ConnectedIP-All-Outbound",
                                "properties": {
                                  "description": "Allows all outbound traffic to connected private IP",
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "*",
                                  "sourceAddressPrefix": "[parameters('jumpboxPrivateIPAddress')]",
                                  "destinationAddressPrefix": "[parameters('connectedPrivateIPAddress')]",
                                  "access": "Allow",
                                  "priority": 105,
                                  "direction": "Outbound"
                                }
                              },
                              {
                                "name": "Deny-All-Inbound",
                                "properties": {
                                  "description": "Denies all other inbound traffic",
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "*",
                                  "sourceAddressPrefix": "*",
                                  "destinationAddressPrefix": "[parameters('jumpboxPrivateIPAddress')]",
                                  "access": "Deny",
                                  "priority": 4000,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "Deny-All-Outbound",
                                "properties": {
                                  "description": "Denies all other outbound traffic",
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "destinationPortRange": "*",
                                  "sourceAddressPrefix": "[parameters('jumpboxPrivateIPAddress')]",
                                  "destinationAddressPrefix": "*",
                                  "access": "Deny",
                                  "priority": 4000,
                                  "direction": "Outbound"
                                }
                              }
                            ],
                            "allSecurityRules": "[if(and(variables('requiresPeering'), not(empty(parameters('connectedPrivateIPAddress')))), concat(variables('baseSecurityRules'), variables('peeringSecurityRules')), variables('baseSecurityRules'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2023-05-01",
                              "name": "jumpbox-public-ip",
                              "location": "[parameters('location')]",
                              "sku": {
                                "name": "Basic",
                                "tier": "Regional"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "Dynamic"
                              }
                            },
                            {
                              "type": "Microsoft.Network/networkSecurityGroups",
                              "apiVersion": "2023-05-01",
                              "name": "[format('jumpbox-nsg-{0}', parameters('vmName'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "securityRules": "[variables('allSecurityRules')]"
                              }
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2023-05-01",
                              "name": "test-nic-JUMPBOX",
                              "location": "[parameters('location')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfigJumpbox",
                                    "properties": {
                                      "privateIPAllocationMethod": "Static",
                                      "privateIPAddress": "[variables('privateIPAddress')]",
                                      "publicIPAddress": {
                                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'jumpbox-public-ip')]"
                                      },
                                      "subnet": {
                                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', split(variables('subnetName'), '/')[0], split(variables('subnetName'), '/')[1])]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "networkSecurityGroup": {
                                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('jumpbox-nsg-{0}', parameters('vmName')))]"
                                },
                                "nicType": "Standard"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkSecurityGroups', format('jumpbox-nsg-{0}', parameters('vmName')))]",
                                "[resourceId('Microsoft.Network/publicIPAddresses', 'jumpbox-public-ip')]"
                              ]
                            },
                            {
                              "condition": "[variables('requiresPeering')]",
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2023-05-01",
                              "name": "[format('vnet-{0}/peer-to-{1}', variables('jumpboxNetwork'), variables('connectedNetwork'))]",
                              "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": true,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('connectedNetwork')))]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                              ]
                            },
                            {
                              "condition": "[and(equals(parameters('deployOrBuild'), 'deploy'), empty(parameters('imageReference')))]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2023-07-01",
                              "name": "[parameters('vmName')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('Jumpbox:{0}', parameters('resourceGroupName'))]"
                              },
                              "plan": {
                                "name": "[parameters('kaliSku')]",
                                "publisher": "kali-linux",
                                "product": "kali"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('vmSize')]"
                                },
                                "osProfile": {
                                  "computerName": "[parameters('vmName')]",
                                  "adminUsername": "[parameters('jumpboxAdminUsername')]",
                                  "adminPassword": "[parameters('jumpboxAdminPassword')]",
                                  "linuxConfiguration": {
                                    "disablePasswordAuthentication": false,
                                    "provisionVMAgent": true
                                  },
                                  "customData": "[base64(variables('$fxv#0'))]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "kali-linux",
                                    "offer": "kali",
                                    "sku": "[parameters('kaliSku')]",
                                    "version": "latest"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                              ]
                            },
                            {
                              "condition": "[and(equals(parameters('deployOrBuild'), 'deploy'), not(empty(parameters('imageReference'))))]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2023-07-01",
                              "name": "[parameters('vmName')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('Jumpbox:{0}', parameters('resourceGroupName'))]"
                              },
                              "plan": {
                                "name": "[parameters('kaliSku')]",
                                "publisher": "kali-linux",
                                "product": "kali"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('vmSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "id": "[parameters('imageReference')]"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('deployOrBuild'), 'build')]",
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2023-07-01",
                              "name": "[parameters('vmName')]",
                              "location": "[parameters('location')]",
                              "tags": {
                                "VM": "[format('Jumpbox:{0}', parameters('resourceGroupName'))]"
                              },
                              "plan": {
                                "name": "[parameters('kaliSku')]",
                                "publisher": "kali-linux",
                                "product": "kali"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('vmSize')]"
                                },
                                "osProfile": {
                                  "computerName": "Jumpbox",
                                  "adminUsername": "redteamer",
                                  "adminPassword": "Password#123",
                                  "linuxConfiguration": {
                                    "disablePasswordAuthentication": false,
                                    "provisionVMAgent": true
                                  },
                                  "customData": "[base64(variables('$fxv#1'))]"
                                },
                                "storageProfile": {
                                  "osDisk": {
                                    "createOption": "FromImage",
                                    "managedDisk": {
                                      "storageAccountType": "[parameters('osDiskType')]"
                                    }
                                  },
                                  "imageReference": {
                                    "publisher": "kali-linux",
                                    "offer": "kali",
                                    "sku": "[parameters('kaliSku')]",
                                    "version": "latest"
                                  }
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', 'test-nic-JUMPBOX')]"
                              ]
                            }
                          ],
                          "outputs": {
                            "debugDeployOrBuild": {
                              "type": "string",
                              "value": "[parameters('deployOrBuild')]"
                            },
                            "debugJumpboxIP": {
                              "type": "string",
                              "value": "[parameters('jumpboxPrivateIPAddress')]"
                            },
                            "debugConnectedIP": {
                              "type": "string",
                              "value": "[parameters('connectedPrivateIPAddress')]"
                            },
                            "debugRequiresPeering": {
                              "type": "bool",
                              "value": "[variables('requiresPeering')]"
                            },
                            "debugJumpboxNetwork": {
                              "type": "string",
                              "value": "[variables('jumpboxNetwork')]"
                            },
                            "debugConnectedNetwork": {
                              "type": "string",
                              "value": "[variables('connectedNetwork')]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "vnet10",
                "vnet172",
                "vnet192"
              ]
            },
            "RunPostBuild": {
              "condition": "[not(empty(parameters('caName')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "RunPostBuild",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vmName": {
                    "value": "[parameters('rootDCName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.24.24.22086",
                      "templateHash": "5447930278520366988"
                    }
                  },
                  "parameters": {
                    "vmName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "$logFilePath = \"C:\\Temp\\logfile.txt\"\n\nFunction Test-ADWebServices {\n    param(\n        [int]$MaxRetries\n    )\n    for ($i=0; $i -lt $MaxRetries; $i++){\n        try {\n            $adwsService = Get-Service -Name ADWS\n        } catch {\n            Add-Content -Path $logFilePath -Value \"Iteration ${i}: ERROR retrieving ADWS service.\"\n        }\n        if ($adwsService -and $adwsService.Status -eq 'Running') {\n            # Confirm that ADWS is listening on port 9389\n            $testConnection = Test-NetConnection -ComputerName localhost -Port 9389 -InformationLevel Quiet\n            if ($testConnection) {\n                Add-Content -Path $logFilePath -Value \"ADWS is running and responsive on port 9389.\"\n                return $true\n            } else {\n                Add-Content -Path $logFilePath -Value \"ADWS is running, but not responding on port 9389. Waiting longer...\"\n                Start-Sleep -Seconds 30\n            }\n        } else {\n            Add-Content -Path $logFilePath -Value \"ADWS is NOT running yet. Sleeping and waiting for initialization.\"\n            #Start-Service -Name ADWS -ErrorAction SilentlyContinue\n            Start-Sleep -Seconds 30\n        }\n    }\n    Add-Content -Path $logFilePath -Value \"ADWS is not running or responsive after $MaxRetries attempts.\"\n    return $false\n}\n\n#Create a base user\ntry {\n    #$adwsTest = Test-ADWebServices -MaxRetries 10\n    $pw = ConvertTo-SecureString -String \"Password#1\" -AsPlaintext -Force\n    New-AdUser -UserPrincipalName \"redteamuser@redteam.lab\" -SamAccountName \"redteamuser\" -AccountPassword $pw -PasswordNeverExpires $true -Name \"redteamuser\" -Enabled $true\n\n} catch {\n   Add-Content -Path $logFilePath -Value \"Failed adding user. $_\" \n}\n\n# Double-check user addition\n$user = Get-ADUser -Filter {SamAccountName -eq \"redteamuser\"}\nif ($user) {\n    Add-Content -Path $logFilePath -Value \"User added successfully.\"\n} else {\n    Add-Content -Path $logFilePath -Value  \"User not found.\"\n}\n\n# Try to run gpupdate\ntry {\n    # Force group policy update\n    gpupdate /force\n    Add-Content -Path $logFilePath -Value \"Ran gpupdate\"\n} catch {\n    Add-Content -Path $logFilePath -Value \"Failed running gpupdate. $_\"\n}\n"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/runPostBuild', parameters('vmName'))]",
                      "location": "eastus",
                      "properties": {
                        "source": {
                          "script": "[variables('$fxv#0')]"
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "CreateAndConfigureCA"
              ]
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "debugJumpboxConfigReceived": {
      "type": "array",
      "value": "[parameters('jumpboxConfig')]"
    },
    "debugConnectedPrivateIPAddress": {
      "type": "string",
      "value": "[variables('connectedPrivateIPAddress')]"
    },
    "debugJumpboxPrivateIPAddress": {
      "type": "string",
      "value": "[variables('jumpboxPrivateIPAddress')]"
    }
  }
}