{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.34.44.8038",
      "templateHash": "15906849096101493704"
    }
  },
  "parameters": {
    "virtualMachineSize": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "deployOrBuild": {
      "type": "string"
    },
    "standaloneServerPrivateIp": {
      "type": "string",
      "defaultValue": ""
    },
    "resourceGroupName": {
      "type": "string"
    },
    "virtualMachineHostname": {
      "type": "string"
    },
    "rootDomainControllerPrivateIp": {
      "type": "string",
      "defaultValue": ""
    },
    "imageReference": {
      "type": "string",
      "defaultValue": ""
    },
    "osDiskType": {
      "type": "string",
      "defaultValue": ""
    },
    "localAdminUsername": {
      "type": "string",
      "defaultValue": "localAdmin"
    },
    "localAdminPassword": {
      "type": "securestring",
      "defaultValue": "localPassword#123"
    },
    "enterpriseAdminPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "domainName": {
      "type": "string",
      "defaultValue": ""
    },
    "domainAndEnterpriseAdminUsername": {
      "type": "string",
      "defaultValue": ""
    },
    "rootOrSub": {
      "type": "string",
      "defaultValue": ""
    },
    "rootDomainFqdn": {
      "type": "string",
      "defaultValue": ""
    },
    "oldScenarios": {
      "type": "bool",
      "defaultValue": false
    },
    "domainControllerPrivateIp": {
      "type": "string",
      "defaultValue": ""
    },
    "jumpboxPrivateIPAddress": {
      "type": "string",
      "defaultValue": ""
    },
    "connectedPrivateIPAddress": {
      "type": "string",
      "defaultValue": ""
    },
    "isVNet10Required": {
      "type": "bool",
      "defaultValue": false
    },
    "isVNet172Required": {
      "type": "bool",
      "defaultValue": false
    },
    "isVNet192Required": {
      "type": "bool",
      "defaultValue": false
    }
  },
  "variables": {
    "$fxv#0": "param(\n    [string]$domainName,                   # The FQDN of the domain to join (e.g., dev.build.lab or build.lab\n    [string]$domainAndEnterpriseAdminUsername,      # Domain admin user e.g., build\\admin\n    [string]$enterpriseAdminPassword                # Plain text password for domain join\n)\n\n\n[securestring]$enterpriseAdminPassword = ConvertTo-SecureString $enterpriseAdminPassword -AsPlainText -Force\n[pscredential]$enterpriseAdminCreds = New-Object System.Management.Automation.PSCredential ($domainAndEnterpriseAdminUsername, $enterpriseAdminPassword)\n\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n# Sleep this to allow the domain controller time to initialize DNS \nAdd-Content -Path $logFilePath -Value \"Sleeping for 30 seconds to give the Domain Controller time to initialize DNS.\"\n#Start-Sleep -Seconds 30\n#Add-Content -Path $logFilePath -Value \"Woke up! Continuing...\"\n\n$joinedDomain = $false\n\nwhile (!$joinedDomain){\n\ttry {\n\t\tAdd-Computer -DomainName $domainName -Restart -Credential $enterpriseAdminCreds -Force\n\t\t$currentDomain = (Get-CimInstance Win32_ComputerSystem).Domain\n\t\tif ($currentDomain -eq $domainName){\n\t\t\t$joinedDomain = $true\n\t\t\tbreak\n\t\t} else {\n\t\t\tStart-Sleep -Seconds 30\n\t\t}\n\t} catch {\n\t\tAdd-Content -Path $logFilePath -Value \"Error joining the $domainName domain. $_\"\n\t\tStart-Sleep -Seconds 30\n\t}\n}\n",
    "$fxv#1": "\nparam(\n    [string]$targetFiles,\n    [string]$domainAdminUsername,\n    [string]$domainAdminPassword,\n    [string]$targetBox\n)\n\n# Convert the password to a secure string\n[securestring]$securedomainAdminPassword = ConvertTo-SecureString $domainAdminPassword -AsPlainText -Force\n\n# Create a PSCredential object using the domain admin username and password\n[pscredential]$domainAdminCreds = New-Object System.Management.Automation.PSCredential ($domainAdminUsername, $securedomainAdminPassword)\n\n$logFilePath = \"C:\\Temp\\logfile.txt\"\n\n# Function that handles creating the directory and downloading the files\nFunction Get-FilesFromStorage {\n    param(\n        [string]$fileURL,\n        [string]$localFilePath,\n        [string]$fileName\n    )\n    \n    New-Item -ItemType Directory -Path $localFilePath -Force\n    $fsConnection = Test-FileStorageConnection -MaxRetries 10\n    if ($fsConnection){\n        try\n        {\n            Add-Content -Path $logFilePath -Value \"Attempting to download $fileName from $fileURL\"\n            Invoke-WebRequest -Uri $fileURL -OutFile $fileName\n        }\n        catch\n        {\n            Add-Content -Path $logFilePath -Value \"Error downloading files: $_\"\n        }\n    }\n}\n\n# check if we have internet connectivity\nFunction Test-FileStorageConnection {\n    param(\n        [int]$MaxRetries\n    )\n    for ($i=0; $i -lt $MaxRetries; $i++){\n        $testConn = Test-NetConnection -ComputerName \"filestorageaccount0.blob.core.windows.net\" -Port 443\n        if ($testConn.TcpTestSucceeded) {\n            Add-Content -Path $logFilePath -Value \"Connected to file storage.\"\n            return $true\n        } else{\n            Add-Content -Path $logFilePath -Value \"No connectivity to file storage yet. Sleeping and retrying..\"\n            Start-Sleep -Seconds 20\n        }\n    }\n    Add-Content -Path $logFilePath -Value \"No connectivity to file storage after $MaxRetries attempts\"\n    return $false\n}\n\n# pass a comma-delimited string and split it\n$targetFilesArray = $targetFiles -split \",\"\n\nforeach ($file in $targetFilesArray) \n{\n    switch ($file) \n    {\n        'module'\n        {\n            Install-WindowsFeature -Name RSAT-AD-PowerShell\n            $fileURL = \"https://filestorageaccount0.blob.core.windows.net/modulecontainer/ADVulnEnvModule.psm1?sp=r&st=2025-01-17T19:27:33Z&se=2026-01-02T03:27:33Z&spr=https&sv=2022-11-02&sr=b&sig=5pa5e0CN83lSMvvAM25HKLY3QPBo8UiSuzokPN%2FPkco%3D\"\n            $localFilePath = \"C:\\Temp\\ADVulnEnvModule\"\n            $fileName = \"C:\\Temp\\ADVulnEnvModule\\ADVulnEnvModule.psm1\"\n            Get-FilesFromStorage -fileURL $fileURL -localFilePath $localFilePath -fileName $fileName\n            Add-Content -Path $logFilePath -Value \"Downloading module\"\n        }\n        'esc' \n        { \n            $fileURL = \"https://filestorageaccount0.blob.core.windows.net/adcs-templates/adcs-files.zip?sp=r&st=2025-01-17T19:32:20Z&se=2026-01-02T03:32:20Z&spr=https&sv=2022-11-02&sr=b&sig=mJZRjz2O71Y%2BmztE1ltiiJVB5pwhiqnzACSnOAW3jcc%3D\"\n            $localFilePath = \"C:\\Temp\"\n            $fileName = \"C:\\Temp\\adcs-files.zip\"\n            Get-FilesFromStorage -fileURL $fileURL -localFilePath $localFilePath -fileName $fileName\n            Add-Content -Path $logFilePath -Value \"Downloading ADCS files..\"\n            Expand-Archive -LiteralPath 'C:\\Temp\\adcs-files.zip' -DestinationPath 'C:\\Temp\\'\n        }\n        'tools'\n        {\n            Add-Content -Path $logFilePath -Value \"Downloading tools\"\n            $fileURL = \"https://filestorageaccount0.blob.core.windows.net/modulecontainer/Windows_attack_tools2.zip?sp=r&st=2025-01-17T19:34:40Z&se=2026-01-02T03:34:40Z&spr=https&sv=2022-11-02&sr=b&sig=o1%2B6lNeldUCZLAtuCyqf%2FpVWZw%2FQNNNFsRJphjcnlw8%3D\"\n            $localFilePath = \"C:\\Temp\\Tools\"\n            Invoke-Command -ComputerName $targetBox -Credential $domainAdminCreds -ScriptBlock {Set-MpPreference -DisableRealTimeMonitoring $true}\n            $fileName = \"C:\\Temp\\PowerView.ps1\"\n            $fileName2 = \"C:\\Temp\\PowerUp.ps1\"\n            Invoke-WebRequest -Uri \"https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1\" -Outfile $fileName -Credential $domainAdminCreds\n            Invoke-WebRequest -Uri \"https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1\" -Outfile $fileName2 -Credential $domainAdminCreds\n            Invoke-WebRequest -Uri $fileURL -Method \"GET\" -Outfile (-join($localFilePath,\".zip\")) -Credential $domainAdminCreds\n            Expand-Archive -Path C:\\Temp\\Tools.zip -DestinationPath C:\\Temp\\Tools\n\n        }\n        Default \n        { \n            Add-Content -Path $logFilePath -Value \"Error downloading files: No files to download!\"\n        }\n    }\n}\n",
    "parentJoinDomain": "[if(equals(parameters('rootOrSub'), 'sub'), parameters('rootDomainFqdn'), '')]",
    "isIP10": "[startsWith(parameters('standaloneServerPrivateIp'), '10.10.')]",
    "isIP172": "[startsWith(parameters('standaloneServerPrivateIp'), '172.16.')]",
    "isIP192": "[startsWith(parameters('standaloneServerPrivateIp'), '192.168.')]",
    "vName": "[if(parameters('oldScenarios'), 'lab-network', if(variables('isIP10'), 'vnet-10', if(variables('isIP172'), 'vnet-172', 'vnet-192')))]",
    "subnetName": "[if(parameters('oldScenarios'), 'root-subnet', if(variables('isIP10'), 'vnet-10/subnet-10', if(variables('isIP172'), 'vnet-172/subnet-172', 'vnet-192/subnet-192')))]",
    "serverNetwork": "[if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172', '192'))]",
    "dcNetwork": "[if(startsWith(parameters('domainControllerPrivateIp'), '10.10.'), '10', if(startsWith(parameters('domainControllerPrivateIp'), '172.16.'), '172', '192'))]",
    "requiresPeering": "[not(equals(variables('serverNetwork'), variables('dcNetwork')))]",
    "jumpboxNetwork": "[if(empty(parameters('jumpboxPrivateIPAddress')), '00', if(startsWith(parameters('jumpboxPrivateIPAddress'), '10.10.'), '10', if(startsWith(parameters('jumpboxPrivateIPAddress'), '172.16.'), '172', '192')))]",
    "isJumpbox": "[if(and(and(and(not(empty(parameters('standaloneServerPrivateIp'))), not(empty(parameters('connectedPrivateIPAddress')))), not(empty(variables('serverNetwork')))), not(empty(variables('jumpboxNetwork')))), and(equals(parameters('standaloneServerPrivateIp'), parameters('connectedPrivateIPAddress')), not(equals(variables('serverNetwork'), variables('jumpboxNetwork')))), false())]",
    "dcPeeringRules": "[if(variables('requiresPeering'), createArray(createObject('name', 'Allow-SpecificDC-Communication-Inbound', 'properties', createObject('description', 'Allows inbound traffic between specific DCs', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('domainControllerPrivateIp'), 'destinationAddressPrefix', parameters('standaloneServerPrivateIp'), 'access', 'Allow', 'priority', 100, 'direction', 'Inbound')), createObject('name', 'Allow-SpecificDC-Communication-Outbound', 'properties', createObject('description', 'Allows outbound traffic between specific DCs', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('standaloneServerPrivateIp'), 'destinationAddressPrefix', parameters('domainControllerPrivateIp'), 'access', 'Allow', 'priority', 100, 'direction', 'Outbound')), createObject('name', 'Allow-IntraSubnet-Inbound', 'properties', createObject('description', 'Allows all inbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Inbound')), createObject('name', 'Allow-IntraSubnet-Outbound', 'properties', createObject('description', 'Allows all outbound traffic within same subnet', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Allow', 'priority', 200, 'direction', 'Outbound')), createObject('name', 'Deny-CrossSubnet-Inbound', 'properties', createObject('description', 'Denies all other inbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('domainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('domainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Inbound')), createObject('name', 'Deny-CrossSubnet-Outbound', 'properties', createObject('description', 'Denies all other outbound cross-subnet traffic', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', if(startsWith(parameters('standaloneServerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('standaloneServerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'destinationAddressPrefix', if(startsWith(parameters('domainControllerPrivateIp'), '10.10.'), '10.10.0.0/24', if(startsWith(parameters('domainControllerPrivateIp'), '172.16.'), '172.16.0.0/24', '192.168.0.0/24')), 'access', 'Deny', 'priority', 4000, 'direction', 'Outbound'))), createArray())]",
    "jumpboxRules": "[if(variables('isJumpbox'), createArray(createObject('name', 'Allow-Jumpbox-Communication-Inbound', 'properties', createObject('description', 'Allows inbound traffic from jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'destinationAddressPrefix', parameters('standaloneServerPrivateIp'), 'access', 'Allow', 'priority', 200, 'direction', 'Inbound')), createObject('name', 'Allow-Jumpbox-Communication-Outbound', 'properties', createObject('description', 'Allows outbound traffic to jumpbox', 'protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '*', 'sourceAddressPrefix', parameters('standaloneServerPrivateIp'), 'destinationAddressPrefix', parameters('jumpboxPrivateIPAddress'), 'access', 'Allow', 'priority', 200, 'direction', 'Outbound'))), createArray())]",
    "allNSG": "[concat(variables('dcPeeringRules'), variables('jumpboxRules'))]"
  },
  "resources": [
    {
      "condition": "[not(empty(variables('allNSG')))]",
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('combined-nsg-{0}', parameters('virtualMachineHostname'))]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": "[variables('allNSG')]"
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}-NIC', parameters('virtualMachineHostname'))]",
      "location": "[parameters('location')]",
      "properties": {
        "dnsSettings": {
          "dnsServers": [
            "[parameters('domainControllerPrivateIp')]",
            "[parameters('standaloneServerPrivateIp')]",
            "8.8.8.8"
          ]
        },
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "[parameters('standaloneServerPrivateIp')]",
              "subnet": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', split(variables('subnetName'), '/')[0], split(variables('subnetName'), '/')[1])]"
              }
            }
          }
        ],
        "networkSecurityGroup": "[if(not(empty(variables('allNSG'))), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', format('combined-nsg-{0}', parameters('virtualMachineHostname')))), null())]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', format('combined-nsg-{0}', parameters('virtualMachineHostname')))]"
      ]
    },
    {
      "condition": "[variables('requiresPeering')]",
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "apiVersion": "2023-05-01",
      "name": "[format('vnet-{0}/peer-to-{1}', variables('serverNetwork'), variables('dcNetwork'))]",
      "properties": {
        "allowVirtualNetworkAccess": true,
        "allowForwardedTraffic": true,
        "allowGatewayTransit": true,
        "useRemoteGateways": false,
        "remoteVirtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('dcNetwork')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
      ]
    },
    {
      "condition": "[variables('requiresPeering')]",
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "apiVersion": "2023-05-01",
      "name": "[format('vnet-{0}/peer-to-{1}', variables('dcNetwork'), variables('serverNetwork'))]",
      "properties": {
        "allowVirtualNetworkAccess": true,
        "allowForwardedTraffic": true,
        "allowGatewayTransit": true,
        "useRemoteGateways": false,
        "remoteVirtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('serverNetwork')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
      ]
    },
    {
      "condition": "[variables('isJumpbox')]",
      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
      "apiVersion": "2023-05-01",
      "name": "[format('vnet-{0}/peer-to-{1}', variables('serverNetwork'), variables('jumpboxNetwork'))]",
      "properties": {
        "allowVirtualNetworkAccess": true,
        "allowForwardedTraffic": true,
        "allowGatewayTransit": true,
        "useRemoteGateways": false,
        "remoteVirtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', variables('jumpboxNetwork')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
      ]
    },
    {
      "condition": "[equals(parameters('deployOrBuild'), 'deploy')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-07-01",
      "name": "[parameters('virtualMachineHostname')]",
      "location": "[parameters('location')]",
      "tags": {
        "VM": "[format('Workstation:{0}', parameters('resourceGroupName'))]"
      },
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('virtualMachineSize')]"
        },
        "storageProfile": {
          "imageReference": {
            "id": "[parameters('imageReference')]"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
      ]
    },
    {
      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-07-01",
      "name": "[parameters('virtualMachineHostname')]",
      "location": "[parameters('location')]",
      "tags": {
        "VM": "[format('Workstation:{0}', parameters('resourceGroupName'))]"
      },
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('virtualMachineSize')]"
        },
        "storageProfile": {
          "osDisk": {
            "createOption": "fromImage",
            "managedDisk": {
              "storageAccountType": "[parameters('osDiskType')]"
            }
          },
          "imageReference": {
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2022-datacenter-g2",
            "version": "latest"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
            }
          ]
        },
        "osProfile": {
          "computerName": "[parameters('virtualMachineHostname')]",
          "adminUsername": "[parameters('localAdminUsername')]",
          "adminPassword": "[parameters('localAdminPassword')]",
          "windowsConfiguration": {
            "provisionVMAgent": true
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-NIC', parameters('virtualMachineHostname')))]"
      ]
    },
    {
      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'JoinDomain')]",
      "location": "[parameters('location')]",
      "properties": {
        "parameters": [
          {
            "name": "domainAndEnterpriseAdminUsername",
            "value": "[parameters('domainAndEnterpriseAdminUsername')]"
          },
          {
            "name": "enterpriseAdminPassword",
            "value": "[parameters('enterpriseAdminPassword')]"
          },
          {
            "name": "domainName",
            "value": "[parameters('domainName')]"
          }
        ],
        "source": {
          "script": "[variables('$fxv#0')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]"
      ]
    },
    {
      "condition": "[equals(parameters('deployOrBuild'), 'build')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', parameters('virtualMachineHostname'), 'downloadConfigurationFiles')]",
      "location": "[parameters('location')]",
      "properties": {
        "parameters": [
          {
            "name": "targetFiles",
            "value": "module"
          },
          {
            "name": "domainAdminUsername",
            "value": "[parameters('domainAndEnterpriseAdminUsername')]"
          },
          {
            "name": "domainAdminPassword",
            "value": "[parameters('enterpriseAdminPassword')]"
          }
        ],
        "source": {
          "script": "[variables('$fxv#1')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineHostname'), 'JoinDomain')]",
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineHostname'))]"
      ]
    }
  ]
}